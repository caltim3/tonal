<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bebop Blueprint</title>
    <link rel="icon" type="image/png" href="jazzmaster.png">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1f618d;
        }
        .app-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .fretboards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .fretboard-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .scale-display {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .controls-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-group label {
            font-weight: bold;
        }
        .control-group select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .fretboard {
            position: relative;
            height: 200px;
            background-color: #FFCF79;
            border-radius: 5px;
            margin-bottom: 30px;
            border: 2px solid #4B1C2E;
            overflow: visible;
        }
        .fret-line {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #c0c0c0;
            border-right: 1px solid rgba(0, 0, 0, 0.3);
            z-index: 1;
        }
        .string-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background: silver;
            border-bottom: 1px solid rgba(0, 0, 0, 0.3);
            z-index: 0;
        }
        .fret-number {
            position: absolute;
            bottom: -40px;
            font-size: 16px;
            color: #1f618d;
            transform: translateX(-50%);
            font-weight: bold;
            z-index: 2;
            width: 20px;
            text-align: center;
        }
        .fret-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #333;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .note {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            z-index: 3;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
        }
        .note:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
        .beat {
            width: 40px;
            height: 80px;
            background: #9E9E9E;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.2s ease;
            font-size: 14px;
            margin: 0 2px;
        }
        .beats-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: nowrap;
        }
        .beat.active {
            transform: translateY(-10px);
        }
        #measures {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .measure {
            position: relative;
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            transition: opacity 0.2s ease;
        }
        .measure.dragging {
            opacity: 0.5;
        }
        .measure.active {
            background-color: #c3e6cb;
            border: 2px solid #28a745;
        }
        .measure-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: #333;
        }
        .chord-controls, .scale-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .chord-controls select, .scale-controls select {
            flex: 1;
        }
        .fretboard-section {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .fretboard-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .control-group label {
            font-weight: bold;
            font-size: 0.9em;
        }
        .control-group select {
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .scale-display {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .fretboard {
            width: 100%;
            margin-top: 10px;
        }
        @media (max-width: 1200px) {
            #measures {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) {
            #measures {
                grid-template-columns: 1fr;
            }
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        select {
            padding: 5px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        #tempo-display {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0 10px;
        }
        #loading-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 5px;
            z-index: 1000;
        }
        .checkbox-wrapper {
            margin-top: 20px;
            margin-left: 20px;
            display: flex;
            align-items: center;
        }
        .control-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .control-button:hover {
            background: #45a049;
        }
        #chordsEnabled {
            margin-bottom: 10px;
            padding: 8px 16px;
        }
        body.dark-mode {
            background-color: #283618;
            color: #fefae0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-mode .app-section {
            background: linear-gradient(145deg, #283618, #606c38);
            color: #fefae0;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .fretboard-container {
            background-color: #606c38;
            border: 1px solid #dda15e;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .dark-mode .fretboard {
            background-color: #dda15e;
            border: 2px solid #4b4b4b;
            border-radius: 5px;
        }
        .dark-mode .note {
            background-color: #dda15e;
            color: #283618;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .note:hover {
            transform: scale(1.2);
            background-color: #bc6c25;
        }
        .dark-mode .scale-display {
            color: #fefae0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5 DONE);
        }
        .dark-mode button {
            background-color: #dda15e;
            color: #283618;
            border: 1px solid #bc6c25;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode button:hover {
            background-color: #bc6c25;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .dark-mode select {
            background-color: #dda15e;
            color: #283618;
            border: 1px solid #bc6c25;
        }
        .dark-mode select:hover {
            background-color: #bc6c25;
        }
        .dark-mode .measure {
            background-color: #606c38;
            color: #fefae0;
            border: 1px solid #dda15e;
        }
        .dark-mode .measure.active {
            background-color: #dda15e;
            border-color: #bc6c25;
        }
        .dark-mode .beat {
            background-color: #dda15e;
            color: #283618;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .beat.active {
            background-color: #bc6c25;
            transform: translateY(-5px);
        }
        .dark-mode .volume-control {
            color: #fefae0;
        }
        .dark-mode .volume-control input[type="range"] {
            background: #606c38;
        }
        .dark-mode .volume-control input[type="range"]::-webkit-slider-thumb {
            background: #dda15e;
            border: 1px solid #bc6c25;
        }
        #dark-mode-toggle.active {
            background-color: #283618;
            color: #fefae0;
            border: 1px solid #dda15e;
        }
        body.dark-mode-2 {
            background-color: #0a1128;
            color: #fefcfb;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-mode-2 .app-section {
            background: linear-gradient(145deg, #001f54, #034078);
            color: #fefcfb;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-2 .fretboard-container {
            background-color: #034078;
            border: 1px solid #1282a2;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .dark-mode-2 .fretboard {
            background-color: #001f54;
            border: 2px solid #1282a2;
            border-radius: 5px;
        }
        .dark-mode-2 .note {
            background-color: #1282a2;
            color: #fefcfb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-2 .scale-display {
            color: #fefcfb;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .dark-mode-2 button {
            background-color: #1282a2;
            color: #fefcfb;
            border: 1px solid #034078;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-2 select {
            background-color: #034078;
            color: #fefcfb;
            border: 1px solid #1282a2;
        }
        .dark-mode-2 .measure {
            background-color: #034078;
            color: #fefcfb;
            border: 1px solid #1282a2;
        }
        .dark-mode-2 .measure.active {
            background-color: #1282a2;
            border-color: #fefcfb;
        }
        .dark-mode-2 .beat {
            background-color: #1282a2;
            color: #fefcfb;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-2 .beat.active {
            background-color: #034078;
            transform: translateY(-5px);
        }
        .dark-mode #fretflow-section {
            background: linear-gradient(145deg, #283618, #606c38);
            color: #fefae0;
        }
        .dark-mode-2 #fretflow-section {
            background: linear-gradient(145deg, #001f54, #034078);
            color: #fefcfb;
        }
        .dark-mode-3 #fretflow-section {
            background: linear-gradient(145deg, #6b705c, #a5a58d);
            color: #ffe8d6;
        }
        .toggle-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .toggle-button.active {
            background: #4CAF50;
        }
        .toggle-button:not(.active) {
            background: #9E9E9E;
        }
        #dark-mode-toggle.active-2 {
            background-color: #1282a2;
            color: #fefcfb;
            border: 1px solid #034078;
        }
        .dark-mode-3 {
            background-color: #6b705c;
            color: #ffe8d6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-mode-3 .app-section {
            background: linear-gradient(145deg, #6b705c, #a5a58d);
            color: #ffe8d6;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-3 .fretboard-container {
            background-color: #606c38;
            border: 1px solid #cb997e;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .dark-mode-3 .fretboard {
            background-color: #cb997e;
            border: 2px solid #6b705c;
            border-radius: 5px;
        }
        .dark-mode-3 .note {
            background-color: #b7b7a4;
            color: #6b705c;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-3 .scale-display {
            color: #ffe8d6;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .dark-mode-3 button {
            background-color: #cb997e;
            color: #ffe8d6;
            border: 1px solid #6b705c;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-3 select {
            background-color: #ddbea9;
            color: #6b705c;
            border: 1px solid #cb997e;
        }
        .dark-mode-3 .measure {
            background-color: #a5a58d;
            color: #ffe8d6;
            border: 1px solid #cb997e;
        }
        .dark-mode-3 .measure.active {
            background-color: #ddbea9;
            border-color: #cb997e;
        }
        .dark-mode-3 .beat {
            background-color: #ddbea9;
            color: #6b705c;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode-3 .beat.active {
            background-color: #cb997e;
            transform: translateY(-5px);
        }
        .dark-mode-3 .volume-control {
            color: #ffe8d6;
        }
        #dark-mode-toggle.active-3 {
            background-color: #cb997e;
            color: #ffe8d6;
            border: 1px solid #6b705c;
        }
    </style>
</head>
<body>
    <div class="app-section" id="chord-fretboard-section">
        <h1>BEBOP BLUEPRINT</h1>
        <h3>Fretflow - Dynamic Fretboard with Scales that Move with the Chord Progression</h3>
        <button id="dark-mode-toggle" aria-label="Toggle dark mode">Dark Mode</button>
        <div class="volume-control">
            <span>Fretboard Volume:</span>
            <input type="range" id="chord-fretboard-volume" min="0" max="1" step="0.1" value="0.3">
        </div>
        <div class="fretboard-container">
            <div class="scale-display" id="scale-display"></div>
            <div class="controls">
                <select class="tuning-select" id="chord-tuning" aria-label="Select guitar tuning">
                    <option value="standard">Standard (EADGBE)</option>
                    <option value="dropD">Drop D (DADGBE)</option>
                    <option value="openG">Open G (DGDGBD)</option>
                    <option value="DADGAD">DADGAD</option>
                    <option value="openE">Open E (EBEG#BE)</option>
                </select>
            </div>
            <div id="chord-fretboard" class="fretboard"></div>
        </div>
    </div>

    <div class="app-section" id="metronome-section">
        <h2>BeatForge Metronome</h2>
        <h3>Click to accent strong beats</h3>
        <div class="controls">
            <select id="time-signature" aria-label="Select time signature">
                <option value="2">2/4</option>
                <option value="3">3/4</option>
                <option value="4" selected>4/4</option>
                <option value="6">6/8</option>
                <option value="7">7/8</option>
                <option value="8">8/8</option>
                <option value="12">12/8</option>
            </select>
            <select id="sound-type" aria-label="Select metronome sound">
                <option value="click">Click</option>
                <option value="woodblock">Woodblock</option>
                <option value="drums">Drums</option>
            </select>
            <button id="drumSetToggleBtn" class="control-button">Drums</button>
            <div class="volume-control">
                <span>Metronome Volume:</span>
                <input type="range" id="metronome-volume" min="0" max="1" step="0.1" value="0.25" aria-label="Metronome volume">
            </div>
            <input type="range" id="tempo" min="40" max="220" value="120" aria-label="Tempo">
            <span id="tempo-display">120 BPM</span>
            <button id="tap-tempo" aria-label="Tap tempo">Tap Tempo</button>
            <button id="start-stop" aria-label="Start or stop metronome">Start</button>
        </div>
        <div class="beats-container"></div>
    </div>

    <div class="volume-control">
        <label for="accent-intensity">Accent Intensity:</label>
        <input type="range" id="accent-intensity" min="1" max="2" step="0.1" value="1.5" aria-label="Accent intensity">
    </div>
    
    <div class="app-section" id="chord-progression-section">
        <h2>Chord Progression Practice</h2>
        <h3>Create a progression or pick one from the dropdown. Choose which key and scale to go with it.</h3>
        <label for="progression-select">Select Progression:</label>
        <select id="progression-select" aria-label="Select chord progression">
            <option value="I V7">I-V7</option>
            <option value="jazz_blues">Jazz Blues</option>
            <option value="minor_blues">Minor Blues</option>
            <option value="rhythm_changes">Rhythm Changes</option>
            <option value="2_5_1">II-V-I</option>
            <option value="6_2_5_1">VI-II-V-I</option>
            <option value="minor_2_5_1">Minor iim-V7-im</option>
            <option value="dark_eyes">Dark Eyes</option>
            <option value="ill_see_you_in_my_dreams">I'll See You In My Dreams</option>
            <option value="rose_room">Rose Room</option>
            <option value="black_orpheus">Black Orpheus</option>
            <option value="all_the_things_you_are">All The Things You Are</option>
            <option value="all_of_me">All of Me</option>
            <option value="stella_by_starlight">Stella By Starlight</option>
            <option value="autumn_leaves">Autumn Leaves</option>
            <option value="summertime">Summertime</option>
            <option value="girl_from_ipanema">Girl From Ipanema</option>
            <option value="coltrane_changes">Coltrane Changes</option>
            <option value="bird_blues">Bird Blues</option>
            <option value="just_friends">Just Friends</option>
            <option value="blue_bossa">Blue Bossa</option>
            <option value="on_green_dolphin_street">On Green Dolphin Street</option>
            <option value="solar">Solar</option>
            <option value="misty">Misty</option>
            <option value="days_of_wine_and_roses">Days of Wine and Roses</option>
            <option value="cherokee">Cherokee</option>
            <option value="caravan">Caravan</option>
            <option value="nows_the_time">Now's The Time</option>
            <option value="tenor_madness">Tenor Madness</option>
        </select>
        <label for="keySelect">Select Key:</label>
        <select id="keySelect" aria-label="Select key">
          <option value="C">C</option>
          <option value="Cm">Cm</option>
          <option value="Db">Db</option>
          <option value="Dbm">Dbm</option>
          <option value="D">D</option>
          <option value="Dm">Dm</option>
          <option value="Eb">Eb</option>
          <option value="Ebm">Ebm</option>
          <option value="E">E</option>
          <option value="Em">Em</option>
          <option value="F">F</option>
          <option value="Fm">Fm</option>
          <option value="Gb">Gb</option>
          <option value="Gbm">Gbm</option>
          <option value="G">G</option>
          <option value="Gm">Gm</option>
          <option value="Ab">Ab</option>
          <option value="Abm">Abm</option>
          <option value="A">A</option>
          <option value="Am">Am</option>
          <option value="Bb">Bb</option>
          <option value="Bbm">Bbm</option>
          <option value="B">B</option>
          <option value="Bm">Bm</option>
        </select>
        <div id="measures">
            <!-- Measures will be populated dynamically -->
        </div>
        <button onclick="addMeasure()" aria-label="Add measure">Add Measure</button>
        <button onclick="removeMeasure()" aria-label="Remove measure">Remove Measure</button>
        <div class="checkbox-wrapper">
            <button id="chordsEnabled" class="toggle-button active">Chords Enabled</button>
        </div>
        <div class="volume-control">
            <label for="chord-volume">Chord Volume:</label>
            <input type="range" id="chord-volume" min="0" max="1" step="0.1" value="0.75" aria-label="Chord volume">
        </div>
    </div>

    <div class="app-section" id="fretflow-section">
        <h2>FretFlow</h2>
        <h3>Multiple scale workout</h3>
        <div class="controls-container">
            <div class="control-group">
                <label for="fretflow-key">Key:</label>
                <select id="fretflow-key" aria-label="Select key">
                    <option value="C">C</option>
                    <option value="C#">C#</option>
                    <option value="D">D</option>
                    <option value="D#">D#</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F#</option>
                    <option value="G">G</option>
                    <option value="G#">G#</option>
                    <option value="A">A</option>
                    <option value="A#">A#</option>
                    <option value="B">B</option>
                </select>
            </div>
            <div class="control-group">
                <label for="fretflow-scale">Scale Type:</label>
                <select id="fretflow-scale" aria-label="Select scale type">
                    <!-- Populated dynamically -->
                </select>
            </div>
        </div>
        <div class="volume-control">
            <span>Fretboard Volume:</span>
            <input type="range" id="fretboard-volume" min="0" max="1" step="0.1" value="0.3" aria-label="Fretboard volume">
        </div>
        <div class="fretboards-grid"></div>
    </div>

    <script>
        // Utility Functions
        function log(message) {
            console.log(`[FretFlow Debug] ${message}`);
        }

        function updateLoadingStatus(message) {
            let indicator = document.getElementById('loading-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'loading-indicator';
                document.body.appendChild(indicator);
            }
            indicator.textContent = message;
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Musical Constants
        const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const ALL_NOTES = ['a', 'as', 'b', 'c', 'cs', 'd', 'ds', 'e', 'f', 'fs', 'g', 'gs'];
        const OCTAVES = [2, 3, 4, 5];
        const FILE_FORMAT = 'wav';

        function getSampleFileName(note, octave) {
            return `${note}${octave}.${FILE_FORMAT}`;
        }

        const allSampleFiles = [];
        for (const note of ALL_NOTES) {
            for (const octave of OCTAVES) {
                allSampleFiles.push(getSampleFileName(note, octave));
            }
        }

        const PIANO_CONFIG = {
            notes: ALL_NOTES,
            octaves: OCTAVES,
            velocities: [12],
            fileFormat: FILE_FORMAT
        };

        const ENHARMONIC_MAP = {
            'C#': 'Db', 'Db': 'Db',
            'D#': 'Eb', 'Eb': 'Eb',
            'F#': 'Gb', 'Gb': 'Gb',
            'G#': 'Ab', 'Ab': 'Ab',
            'A#': 'Bb', 'Bb': 'Bb'
        };

        const SAMPLE_NOTE_MAP = {
            'C': 'c', 'C#': 'cs', 'Db': 'cs', 'D': 'd', 'D#': 'ds', 'Eb': 'ds',
            'E': 'e', 'F': 'f', 'F#': 'fs', 'Gb': 'fs', 'G': 'g', 'G#': 'gs',
            'Ab': 'gs', 'A': 'a', 'A#': 'as', 'Bb': 'as', 'B': 'b'
        };

        const PIANO_NOTES = {
            'A2': 110.00, 'As2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'Cs3': 138.59, 'D3': 146.83, 'Ds3': 155.56, 'E3': 164.81, 'F3': 174.61,
            'Fs3': 185.00, 'G3': 196.00, 'Gs3': 207.65, 'A3': 220.00, 'As3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'Cs4': 277.18, 'D4': 293.66, 'Ds4': 311.13, 'E4': 329.63
        };

        const FRETBOARD_FREQUENCIES = {
            'string6': [82.41, 87.31, 92.50, 98.00, 103.83, 110.00, 116.54, 123.47, 130.81, 138.59, 146.83, 155.56, 164.81],
            'string5': [110.00, 116.54, 123.47, 130.81, 138.59, 146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00],
            'string4': [146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66],
            'string3': [196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00],
            'string2': [246.94, 261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88],
            'string1': [329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88, 523.25, 554.37, 587.33, 622.25, 659.25]
        };

        const SCALES = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            melodicMinor: [0, 2, 3, 5, 7, 9, 11],
            dorian: [0, 2, 3, 5, 7, 9, 10],
            phrygian: [0, 1, 3, 5, 7, 8, 10],
            lydian: [0, 2, 4, 6, 7, 9, 11],
            mixolydian: [0, 2, 4, 5, 7, 9, 10],
            locrian: [0, 1, 3, 5, 6, 8, 10],
            bebopDominant: [0, 2, 4, 5, 7, 9, 10, 11],
            bebopMajor: [0, 2, 4, 5, 7, 8, 9, 11],
            bebopDorian: [0, 2, 3, 4, 5, 7, 9, 10],
            bebopPhrygian: [0, 1, 2, 3, 5, 7, 8, 10],
            altered: [0, 1, 3, 4, 6, 8, 10],
            lydianDominant: [0, 2, 4, 6, 7, 9, 10],
            diminishedWH: [0, 2, 3, 5, 6, 8, 9, 11],
            diminishedHW: [0, 1, 3, 4, 6, 7, 9, 10],
            wholeHalf: [0, 2, 4, 6, 8, 10],
            pentatonicMajor: [0, 2, 4, 7, 9],
            pentatonicMinor: [0, 3, 5, 7, 10],
            blues: [0, 3, 5, 6, 7, 10],
            majorBlues: [0, 2, 3, 4, 7, 9],
            halfWhole: [0, 1, 3, 4, 6, 7, 9, 10],
            harmonicMajor: [0, 2, 4, 5, 7, 8, 11],
            doubleHarmonic: [0, 1, 4, 5, 7, 8, 11],
            enigmatic: [0, 1, 4, 6, 8, 10, 11],
            persian: [0, 1, 4, 5, 6, 8, 11],
            arabic: [0, 2, 4, 5, 6, 8, 10],
            japanese: [0, 2, 5, 7, 8],
            egyptian: [0, 2, 5, 7, 10]
        };

        const TUNINGS = {
            standard: ['E', 'B', 'G', 'D', 'A', 'E'],
            dropD: ['E', 'B', 'G', 'D', 'A', 'D'],
            openG: ['D', 'B', 'G', 'D', 'G', 'D'],
            DADGAD: ['D', 'A', 'G', 'D', 'A', 'D'],
            openE: ['E', 'B', 'E', 'Ab', 'B', 'E']
        };

        const DRUM_PATTERNS = {
            '2': { kick: [1, 0], snare: [0, 1], hihat: [1, 1] },
            '3': { kick: [1, 0, 0], snare: [0, 1, 0], hihat: [1, 1, 1] },
            '4': { kick: [1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1, 1] },
            '6': { kick: [1, 0, 0, 1, 0, 0], snare: [0, 0, 1, 0, 0, 1], hihat: [1, 1, 1, 1, 1, 1] },
            '7': { kick: [1, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1] },
            '8': { kick: [1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1, 1] },
            '12': { kick: [1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0], snare: [0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1], hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1] }
        };

        let currentDrumSetIndex = 0;
        const drumSoundSets = [
            { name: "Drums", snare: "Snare.wav", hihat: "HiHat.wav", kick: "Kick.wav" },
            { name: "Makaya", snare: "Snare2.wav", hihat: "HiHat2.wav", kick: "Kick2.wav" },
            { name: "PhillyJoe", kick: 'jazzkick.wav', snare: 'jazzsnare.wav', hihat: 'jazzhat.wav' }
        ];

        const progressions = {
            "I V7": { defaultKey: "C", progression: ["Imaj7", "V7"] },
            "jazz_blues": { defaultKey: "Bb", progression: ["I7", "IV7", "I7", "I7", "IV7", "IV7", "I7", "VI7", "IIm7", "V7", "I7", "V7"] },
            "minor_blues": { defaultKey: "Am", progression: ["im7", "ivm7", "im7", "im7", "ivm7", "ivm7", "im7", "im7", "V7", "V7", "im7", "V7"] },
            "rhythm_changes": { defaultKey: "Bb", progression: ["I6", "vim7", "iim7", "V7", "I6", "vim7", "iim7", "V7", "I6", "IV7", "I6", "I6", "iim7", "V7", "I6", "V7"] },
            "2_5_1": { defaultKey: "C", progression: ["iim7", "V7", "Imaj7", "Imaj7"] },
            "6_2_5_1": { defaultKey: "C", progression: ["vim7", "iim7", "V7", "Imaj7", "Imaj7"] },
            "minor_2_5_1": { defaultKey: "Am", progression: ["iim7b5", "V7b9", "im7", "im7"] },
            "dark_eyes": { defaultKey: "Dm", progression: ["V7", "V7", "im7", "im7", "V7", "V7", "VI6", "VI6", "ivm6", "ivm6", "im7", "im7", "V7", "V7", "im7", "im7"] },
            "ill_see_you_in_my_dreams": { defaultKey: "F", progression: ["IV6", "IV6", "ivm6", "ivm6", "Imaj7", "VII7", "Imaj7", "Imaj7", "VI7", "VI7", "VI7", "VI7", "II7", "II7", "iim7", "V7", "Imaj7"] },
            "rose_room": { defaultKey: "Ab", progression: ["II7", "V7", "I6", "I7", "IV6", "ivm7", "bVII7", "I6", "VI7", "V7", "V7", "II7", "V7", "I6", "I7", "IV6", "ivm7", "bVII7", "I6", "VI7", "IV7", "V7", "I6", "VI7"] },
            "black_orpheus": { defaultKey: "Am", progression: ["im7", "iim7b5", "V7b9", "im7", "ivm7", "VII7", "bIIImaj7", "bVImaj7", "iim7b5", "V7b9", "im7", "iim7b5", "V7b9", "im7", "ivm7", "VII7"] },
            "all_the_things_you_are": { defaultKey: "Ab", progression: ["vim7", "iim7", "V7", "Imaj7", "IVmaj7", "iiim7", "VI7", "IImaj7", "iim7", "vm7", "I7", "IVmaj7", "Imaj7", "iim7", "V7", "Imaj7", "iim7", "V7", "Imaj7", "iim7", "vm7", "I7", "IVmaj7", "Imaj7"] },
            "all_of_me": { defaultKey: "C", progression: ["Imaj7", "III7", "VI7", "iim7", "III7", "vim7", "II7", "iim7", "V7", "Imaj7", "III7", "VI7", "iim7", "IVmaj7", "ivm7", "Imaj7", "V7"] },
            "stella_by_starlight": { defaultKey: "Bb", progression: ["iim7b5", "V7b9", "im7", "IV7", "vm7", "I7", "IVmaj7", "bVIImaj7", "biiim7b5", "VI7b9", "iim7", "V7", "im7", "IV7", "IVmaj7", "V7"] },
            "autumn_leaves": { defaultKey: "Em", progression: ["ivm7", "VII7", "bIIImaj7", "bVImaj7", "iim7b5", "V7b9", "im7", "im7"] },
            "summertime": { defaultKey: "Am", progression: ["im7", "V7", "im7", "V7", "im7", "V7", "im7", "V7", "iv7", "im7", "V7", "im7", "iv7", "im7", "V7", "im7"] },
            "girl_from_ipanema": { defaultKey: "F", progression: ["Imaj7", "II7", "iim7", "V7", "Imaj7", "II7", "iim7", "V7", "Imaj7", "bII7", "#IVmaj7", "vim7", "iim7", "V7", "Imaj7", "vim7", "iim7", "V7"] },
            "coltrane_changes": { defaultKey: "C", progression: ["Imaj7", "bIII7", "bVImaj7", "VII7", "IIImaj7", "V7", "Imaj7", "bIII7", "bVImaj7", "VII7", "IIImaj7", "V7"] },
            "bird_blues": { defaultKey: "F", progression: ["I7", "IV7", "I7", "vim7", "iim7", "V7", "IV7", "ivm7", "I7", "vim7", "iim7", "V7"] },
            "just_friends": { defaultKey: "G", progression: ["Imaj7", "VI7", "iim7", "V7", "Imaj7", "VI7", "iim7", "V7", "iim7", "V7", "Imaj7", "VI7", "iim7", "V7", "Imaj7", "VI7"] },
            "blue_bossa": { defaultKey: "Cm", progression: ["im7", "im7", "bVII7", "bVII7", "im7", "im7", "ivm7", "bVII7", "im7", "V7", "im7", "im7"] },
            "on_green_dolphin_street": { defaultKey: "C", progression: ["Imaj7", "bIII7", "bVImaj7", "iim7", "V7", "Imaj7", "bIII7", "bVImaj7", "iim7", "V7", "Imaj7"] },
            "solar": { defaultKey: "C", progression: ["im7", "im7", "bIIImaj7", "bIIImaj7", "bVImaj7", "bVImaj7", "bII7", "bII7", "im7", "im7"] },
            "misty": { defaultKey: "Eb", progression: ["Imaj7", "I7", "IVmaj7", "ivm7", "Imaj7", "V7", "Imaj7", "vim7", "iim7", "V7", "Imaj7"] },
            "days_of_wine_and_roses": { defaultKey: "F", progression: ["Imaj7", "vim7", "iim7", "V7", "Imaj7", "vim7", "iim7", "V7", "Imaj7", "vim7", "iim7", "V7", "Imaj7"] },
            "cherokee": { defaultKey: "Bb", progression: ["Imaj7", "Imaj7", "iim7", "V7", "Imaj7", "Imaj7", "iim7", "V7", "bVI7", "bVI7", "V7", "V7", "Imaj7", "Imaj7", "iim7", "V7"] },
            "caravan": { defaultKey: "Eb", progression: ["im7", "IV7b5", "im7", "IV7b5", "im7", "IV7b5", "im7", "IV7b5", "bVII7", "bVII7", "Imaj7", "Imaj7", "V7", "V7", "im7", "im7"] },
            "nows_the_time": { defaultKey: "F", progression: ["I7", "I7", "I7", "I7", "IV7", "IV7", "I7", "I7", "V7", "IV7", "I7", "I7"] },
            "tenor_madness": { defaultKey: "Bb", progression: ["I7", "I7", "I7", "I7", "IV7", "IV7", "I7", "I7", "iim7", "V7", "I7", "I7"] }
        };

        const scaleDegrees = {
            major: {
                'I': 0, 'II': 2, 'III': 4, 'IV': 5, 'V': 7, 'VI': 9, 'VII': 11,
                'i': 0, 'ii': 2, 'iii': 4, 'iv': 5, 'v': 7, 'vi': 9, 'vii': 11,
                'I7': 0, 'II7': 2, 'III7': 4, 'IV7': 5, 'V7': 7, 'VI7': 9, 'VII7': 11,
                'i7': 0, 'ii7': 2, 'iii7': 4, 'iv7': 5, 'v7': 7, 'vi7': 9, 'vii7': 11,
                'Im7': 0, 'IIm7': 2, 'IIIm7': 4, 'IVm7': 5, 'Vm7': 7, 'VIm7': 9, 'VIIm7': 11,
                'Imaj7': 0, 'IImaj7': 2, 'IIImaj7': 4, 'IVmaj7': 5, 'Vmaj7': 7, 'VImaj7': 9, 'VIImaj7': 11,
                'I9': 0, 'II9': 2, 'III9': 4, 'IV9': 5, 'V9': 7, 'VI9': 9, 'VII9': 11,
                'I13': 0, 'II13': 2, 'III13': 4, 'IV13': 5, 'V13': 7, 'VI13': 9, 'VII13': 11,
                'V7b9': 7, 'V7#9': 7, 'V7b13': 7, 'V7#11': 7,
                'vii°': 11, 'ii°': 2, 'iii°': 4,
                'vii∅7': 11, 'ii∅7': 2, 'iii∅7': 4,
                'bII': 1, 'bIII': 3, 'bV': 6, 'bVI': 8, 'bVII': 10,
                'bII7': 1, 'bIII7': 3, 'bV7': 6, 'bVI7': 8, 'bVII7': 10,
                'bIImaj7': 1, 'bIIImaj7': 3, 'bVmaj7': 6, 'bVImaj7': 8, 'bVIImaj7': 10
            },
            minor: {
                'i': 0, 'ii': 2, 'III': 3, 'iv': 5, 'v': 7, 'VI': 8, 'VII': 10,
                'i°': 0, 'ii°': 2, 'III+': 3, 'iv°': 5, 'v°': 7, 'VI+': 8, 'vii°': 11,
                'i7': 0, 'ii7': 2, 'III7': 3, 'iv7': 5, 'v7': 7, 'VI7': 8, 'VII7': 10,
                'im7': 0, 'iim7': 2, 'IIIm7': 3, 'ivm7': 5, 'vm7': 7, 'VIm7': 8, 'VIIm7': 10,
                'imaj7': 0, 'iimaj7': 2, 'IIImaj7': 3, 'ivmaj7': 5, 'vmaj7': 7, 'VImaj7': 8, 'VIImaj7': 10,
                'iø7': 0, 'iiø7': 2, 'IIIø7': 3, 'ivø7': 5, 'vø7': 7, 'VIø7': 8, 'VIIø7': 10,
                'i°7': 0, 'ii°7': 2, 'III°7': 3, 'iv°7': 5, 'v°7': 7, 'VI°7': 8, 'VII°7': 10,
                'iim7b5': 2, 'iiim7b5': 4, 'vim7b5': 9,
                'i9': 0, 'ii9': 2, 'III9': 3, 'iv9': 5, 'v9': 7, 'VI9': 8, 'VII9': 10,
                'i13': 0, 'ii13': 2, 'III13': 3, 'iv13': 5, 'v13': 7, 'VI13': 8, 'VII13': 10,
                'V7b9': 7, 'V7#9': 7, 'V7b13': 7, 'V7#11': 7,
                'bII': 1, 'bIII': 3, 'bIV': 4, 'bV': 6, 'bVI': 8, 'bVII': 10,
                'bII7': 1, 'bIII7': 3, 'bIV7': 4, 'bV7': 6, 'bVI7': 8, 'bVII7': 10,
                'bIImaj7': 1, 'bIIImaj7': 3, 'bIVmaj7': 4, 'bVmaj7': 6, 'bVImaj7': 8, 'bVIImaj7': 10,
                'V7/III': 7, 'V7/iv': 7, 'V7/v': 7, 'V7/VI': 7, 'V7/VII': 7,
                'V7/bIII': 7, 'V7/bVI': 7, 'V7/bVII': 7
            }
        };

        // State Management
        const AppState = {
            isPlaying: false,
            currentBeat: 0,
            currentMeasure: 0,
            tempo: 120,
            audioInitialized: false,
            darkMode: false,
            listeners: [],
            updateState(newState) {
                Object.assign(this, newState);
                this.notifyListeners();
            },
            addListener(callback) {
                this.listeners.push(callback);
            },
            notifyListeners() {
                this.listeners.forEach(callback => callback(this));
            }
        };

        // UI Management
        const UI = {
            elements: {
                chordFretboard: document.getElementById('chord-fretboard'),
                measures: document.getElementById('measures'),
                tempoDisplay: document.getElementById('tempo-display'),
                startStopButton: document.getElementById('start-stop'),
                progressionSelect: document.getElementById('progression-select'),
                keySelect: document.getElementById('keySelect'),
                scaleDisplay: document.getElementById('scale-display'),
                chordTuning: document.getElementById('chord-tuning'),
                timeSignature: document.getElementById('time-signature'),
                soundType: document.getElementById('sound-type'),
                metronomeVolume: document.getElementById('metronome-volume'),
                tempo: document.getElementById('tempo'),
                tapTempo: document.getElementById('tap-tempo'),
                chordFretboardVolume: document.getElementById('chord-fretboard-volume'),
                chordVolume: document.getElementById('chord-volume'),
                chordsEnabled: document.getElementById('chordsEnabled'),
                fretboardVolume: document.getElementById('fretboard-volume'),
                fretboardsGrid: document.querySelector('.fretboards-grid'),
                darkModeToggle: document.getElementById('dark-mode-toggle'),
                accentIntensity: document.getElementById('accent-intensity')
            },
            init() {
                Object.entries(this.elements).forEach(([key, el]) => {
                    if (!el) console.warn(`Missing DOM element: ${key}`);
                });
            }
        };

        function initializeScaleSelects() {
            const scaleOptions = Object.keys(SCALES).map(scale => {
                const displayName = scale
                    .replace(/([A-Z])/g, ' $1')
                    .toLowerCase()
                    .replace(/\b\w/g, c => c.toUpperCase());
                return `<option value="${scale}">${displayName}</option>`;
            }).join('');
            const fretflowScale = document.getElementById('fretflow-scale');
            if (fretflowScale) {
                fretflowScale.innerHTML = scaleOptions;
            }
            const measureScaleSelects = document.querySelectorAll('.scale-select');
            measureScaleSelects.forEach(select => {
                select.innerHTML = scaleOptions;
            });
        }

        // Audio Management
        const AudioContextManager = {
            context: null,
            soundBuffers: {},
            pianoSampleBuffers: {},
            reverbNode: null,
            samplesLoaded: false,
            currentChordGain: null,

            initialize: async function() {
                if (!this.context) {
                    this.context = new (window.AudioContext || window.webkitAudioContext)();
                    await this.loadSounds();
                    await this.loadPianoSamples();
                    await this.setupReverb();
                }
                if (this.context.state === 'suspended') {
                    await this.context.resume();
                }
                AppState.updateState({ audioInitialized: true });
                return this.context;
            },

            ensureAudioContext: async function() {
                return await this.initialize();
            },

            loadSounds: async function() {
                const soundFiles = {
                    'click': 'Click.wav',
                    'hihat': 'HiHat.wav',
                    'kick': 'Kick.wav',
                    'snare': 'Snare.wav',
                    'woodblock': 'woodblock.wav'
                };
                for (let [type, filename] of Object.entries(soundFiles)) {
                    try {
                        const response = await fetch(`./${filename}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const arrayBuffer = await response.arrayBuffer();
                        this.soundBuffers[type] = await this.context.decodeAudioData(arrayBuffer);
                        log(`Loaded ${type} sound from ${filename}`);
                    } catch (error) {
                        console.error(`Failed to load ${filename}:`, error);
                        this.soundBuffers[type] = await this.createDrumSound(type);
                        log(`Using fallback synthetic sound for ${type}`);
                    }
                }
                updateLoadingStatus("Drum sounds loaded");
            },

            createDrumSound: async function(type) {
                const sampleRate = this.context.sampleRate;
                const duration = type === 'hihat' ? 0.05 : 0.2;
                const buffer = this.context.createBuffer(1, sampleRate * duration, sampleRate);
                const data = buffer.getChannelData(0);
                switch (type) {
                    case 'click':
                        for (let i = 0; i < data.length; i++) data[i] = Math.sin(i * 0.05) * Math.exp(-i * 0.01);
                        break;
                    case 'hihat':
                        for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (sampleRate * 0.01));
                        break;
                    case 'kick':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = Math.sin(2 * Math.PI * 100 * t) * Math.exp(-t * 10) * 2;
                        }
                        break;
                    case 'snare':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = ((Math.random() * 2 - 1) + Math.sin(2 * Math.PI * 200 * t)) * Math.exp(-t * 10) * 2;
                        }
                        break;
                    case 'woodblock':
                        for (let i = 0; i < data.length; i++) {
                            const t = i / sampleRate;
                            data[i] = Math.sin(2 * Math.PI * 800 * t) * Math.exp(-t * 20);
                        }
                        break;
                }
                return buffer;
            },

            loadPianoSamples: async function() {
                updateLoadingStatus("Loading piano samples...");
                for (const file of allSampleFiles) {
                    try {
                        const response = await fetch(`./piano_samples/${file}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const arrayBuffer = await response.arrayBuffer();
                        this.pianoSampleBuffers[file] = await this.context.decodeAudioData(arrayBuffer);
                        log(`Loaded piano sample: ${file}`);
                    } catch (error) {
                        console.error(`Failed to load piano sample ${file}:`, error);
                    }
                }
                this.samplesLoaded = true;
                updateLoadingStatus("Piano samples loaded");
            },

            setupReverb: async function() {
                try {
                    const response = await fetch('./impulse_response.wav');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const arrayBuffer = await response.arrayBuffer();
                    const reverbBuffer = await this.context.decodeAudioData(arrayBuffer);
                    this.reverbNode = this.context.createConvolver();
                    this.reverbNode.buffer = reverbBuffer;
                    this.reverbNode.connect(this.context.destination);
                    log("Reverb setup completed");
                } catch (error) {
                    console.error('Failed to setup reverb:', error);
                    this.reverbNode = null;
                }
            }
        };

        async function ensureAudioInitialized() {
            if (!AppState.audioInitialized) {
                try {
                    await AudioContextManager.initialize();
                    log("Audio context initialized");
                } catch (error) {
                    console.error('Failed to initialize audio context:', error);
                    throw error;
                }
            }
        }

        async function playNote(string, fret, volume = 0.5, duration = 500) {
            try {
                await AudioContextManager.ensureAudioContext();
                const frequency = FRETBOARD_FREQUENCIES[string][fret];
                const closestNote = Object.entries(PIANO_NOTES).reduce((prev, curr) => {
                    return Math.abs(curr[1] - frequency) < Math.abs(prev[1] - frequency) ? curr : prev;
                })[0];
                const noteName = closestNote.split(/(?=[0-9])/)[0];
                const octave = parseInt(closestNote.match(/\d+/)[0]);
                const sampleNote = SAMPLE_NOTE_MAP[noteName];
                if (!sampleNote) {
                    console.error(`No sample note mapping for ${noteName}`);
                    return;
                }
                const sampleFile = getSampleFileName(sampleNote, octave);
                const buffer = AudioContextManager.pianoSampleBuffers[sampleFile];
                if (!buffer) {
                    console.error(`No buffer found for ${sampleFile}`);
                    return;
                }
                const source = AudioContextManager.context.createBufferSource();
                source.buffer = buffer;
                const gainNode = AudioContextManager.context.createGain();
                const chordFretboardVolume = parseFloat(UI.elements.chordFretboardVolume.value) || 0.3;
                gainNode.gain.value = volume * chordFretboardVolume;
                source.connect(gainNode);
                gainNode.connect(AudioContextManager.context.destination);
                if (AudioContextManager.reverbNode) {
                    const reverbGain = AudioContextManager.context.createGain();
                    reverbGain.gain.value = 0.2;
                    source.connect(reverbGain);
                    reverbGain.connect(AudioContextManager.reverbNode);
                }
                source.start(0);
                setTimeout(() => source.stop(), duration);
            } catch (error) {
                console.error('Error playing note:', error);
            }
        }

        function standardizeNoteName(note) {
            if (!note) return 'C';
            const cleanNote = note.replace(/[^A-Gb#]/g, '');
            return ENHARMONIC_MAP[cleanNote] || cleanNote || 'C';
        }

        async function playChord(root, quality, startTime = AudioContextManager.context.currentTime, duration = 2, isSecondHalf = false) {
            try {
                await AudioContextManager.ensureAudioContext();
                if (!UI.elements.chordsEnabled.classList.contains('active')) return;
                const chordNotes = getChordNotes(root, quality);
                if (AudioContextManager.currentChordGain) {
                    AudioContextManager.currentChordGain.gain.setValueAtTime(AudioContextManager.currentChordGain.gain.value, startTime);
                    AudioContextManager.currentChordGain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.1);
                }
                const gainNode = AudioContextManager.context.createGain();
                const chordVolume = parseFloat(UI.elements.chordVolume.value) || 0.75;
                gainNode.gain.value = chordVolume / chordNotes.length;
                gainNode.connect(AudioContextManager.context.destination);
                if (AudioContextManager.reverbNode) {
                    const reverbGain = AudioContextManager.context.createGain();
                    reverbGain.gain.value = 0.3;
                    gainNode.connect(reverbGain);
                    reverbGain.connect(AudioContextManager.reverbNode);
                }
                AudioContextManager.currentChordGain = gainNode;
                chordNotes.forEach(note => {
                    const noteName = note.split(/(?=[0-9])/)[0];
                    const octave = parseInt(note.match(/\d+/)[0]);
                    const sampleNote = SAMPLE_NOTE_MAP[noteName];
                    if (!sampleNote) {
                        console.warn(`No sample note mapping for ${noteName}`);
                        return;
                    }
                    const sampleFile = getSampleFileName(sampleNote, octave);
                    const buffer = AudioContextManager.pianoSampleBuffers[sampleFile];
                    if (!buffer) {
                        console.warn(`No buffer found for ${sampleFile}`);
                        return;
                    }
                    const source = AudioContextManager.context.createBufferSource();
                    source.buffer = buffer;
                    source.connect(gainNode);
                    source.start(startTime);
                    source.stop(startTime + duration);
                });
            } catch (error) {
                console.error('Error playing chord:', error);
            }
        }

        function getChordNotes(root, quality) {
            const rootIndex = NOTES.indexOf(standardizeNoteName(root));
            let intervals;
            switch (quality) {
                case 'major':
                    intervals = [0, 4, 7];
                    break;
                case 'minor':
                    intervals = [0, 3, 7];
                    break;
                case 'diminished':
                    intervals = [0, 3, 6];
                    break;
                case 'augmented':
                    intervals = [0, 4, 8];
                    break;
                case 'maj7':
                    intervals = [0, 4, 7, 11];
                    break;
                case 'min7':
                    intervals = [0, 3, 7, 10];
                    break;
                case 'dom7':
                    intervals = [0, 4, 7, 10];
                    break;
                case 'min7b5':
                    intervals = [0, 3, 6, 10];
                    break;
                case 'dim7':
                    intervals = [0, 3, 6, 9];
                    break;
                default:
                    intervals = [0, 4, 7];
            }
            return intervals.map(interval => {
                const noteIndex = (rootIndex + interval) % 12;
                return `${NOTES[noteIndex]}3`;
            });
        }

        function getChordFromFunction(chordFunction, key) {
            const isMinor = key.endsWith('m');
            const cleanKey = key.replace('m', '');
            const keyIndex = NOTES.indexOf(standardizeNoteName(cleanKey));
            const degreeTable = isMinor ? scaleDegrees.minor : scaleDegrees.major;
            let chordSymbol = chordFunction;
            let degreeMatch = chordFunction.match(/^([b#]?[IViv]+)(.*)$/);
            if (!degreeMatch) {
                console.warn(`Invalid chord function: ${chordFunction}`);
                return `${cleanKey}maj7`;
            }
            const [, degree, quality] = degreeMatch;
            const degreeKey = degree.toLowerCase();
            let offset = degreeTable[chordFunction] || degreeTable[degreeKey];
            if (offset === undefined) {
                console.warn(`No offset found for degree: ${chordFunction}`);
                offset = 0;
            }
            const rootIndex = (keyIndex + offset) % 12;
            let rootNote = NOTES[rootIndex];
            let chordQuality;
            switch (quality) {
                case 'maj7':
                case 'M7':
                    chordQuality = 'maj7';
                    break;
                case 'm7':
                case '-7':
                    chordQuality = 'min7';
                    break;
                case '7':
                    chordQuality = 'dom7';
                    break;
                case 'm7b5':
                case 'ø7':
                    chordQuality = 'min7b5';
                    break;
                case 'dim7':
                case '°7':
                    chordQuality = 'dim7';
                    break;
                case '':
                case '6':
                    chordQuality = isMinor && degree === 'i' ? 'min7' : 'maj7';
                    break;
                default:
                    chordQuality = 'maj7';
                    console.warn(`Unknown quality ${quality}, defaulting to maj7`);
            }
            return `${rootNote}${chordQuality}`;
        }

function renderFretboard(container, tuning, scaleNotes, rootNote, scaleName, chord = null, startFret = 0, endFret = 12) {
    container.innerHTML = '';
    const numFrets = endFret - startFret + 1;
    const stringSpacing = container.offsetHeight / (tuning.length - 1);
    const fretSpacing = container.offsetWidth / (numFrets - 1);

    // Draw strings
    tuning.forEach((_, index) => {
        const string = document.createElement('div');
        string.className = 'string-line';
        string.style.top = `${index * stringSpacing}px`;
        container.appendChild(string);
    });

    // Draw frets
    for (let i = 0; i < numFrets; i++) {
        const fret = document.createElement('div');
        fret.className = 'fret-line';
        fret.style.left = `${i * fretSpacing}px`;
        container.appendChild(fret);

        // Add fret numbers
        if (i > 0) {
            const fretNumber = document.createElement('div');
            fretNumber.className = 'fret-number';
            fretNumber.textContent = startFret + i;
            fretNumber.style.left = `${i * fretSpacing}px`;
            container.appendChild(fretNumber);
        }
    }

    // Add fretboard markers
    const markers = [3, 5, 7, 9, 12].filter(f => f >= startFret && f <= endFret);
    markers.forEach(fret => {
        const marker = document.createElement('div');
        marker.className = 'fret-marker';
        marker.style.left = `${((fret - startFret) * fretSpacing) - (fretSpacing / 2)}px`;
        marker.style.top = `${container.offsetHeight / 2}px`;
        container.appendChild(marker);
    });

    // Draw notes
    tuning.forEach((openNote, stringIndex) => {
        const stringKey = `string${6 - stringIndex}`;
        for (let fret = 0; fret <= 12; fret++) {
            const noteIndex = (NOTES.indexOf(openNote) + fret) % 12;
            const noteName = NOTES[noteIndex];
            if (scaleNotes.includes(noteName)) {
                if (fret < startFret || fret > endFret) continue;
                const note = document.createElement('div');
                note.className = 'note';
                note.textContent = noteName;
                note.style.backgroundColor = noteName === rootNote ? '#ff5555' : '#2196F3';
                note.style.left = `${((fret - startFret) * fretSpacing)}px`;
                note.style.top = `${stringIndex * stringSpacing}px`;
                note.onclick = () => playNote(stringKey, fret);
                container.appendChild(note);
            }
        }
    });

    // Update scale display
    const scaleDisplay = container.parentElement.querySelector('.scale-display');
    if (scaleDisplay) {
        scaleDisplay.textContent = chord ? 
            `${scaleName} over ${chord}` : 
            `${rootNote} ${scaleName}`;
    }
}

function getScaleNotes(root, scaleType) {
    const rootIndex = NOTES.indexOf(standardizeNoteName(root));
    const intervals = SCALES[scaleType] || SCALES.major;
    return intervals.map(interval => NOTES[(rootIndex + interval) % 12]);
}

// Chord Progression Logic
function updateChordProgression() {
    const progressionSelect = UI.elements.progressionSelect;
    const keySelect = UI.elements.keySelect;
    const selectedProgression = progressionSelect.value;
    const selectedKey = keySelect.value;

    const progressionData = progressions[selectedProgression] || progressions["I V7"];
    const chordFunctions = progressionData.progression;
    UI.elements.measures.innerHTML = '';

    chordFunctions.forEach((chordFunction, index) => {
        const measure = document.createElement('div');
        measure.className = 'measure';
        measure.draggable = true;
        measure.dataset.index = index;

        const measureNumber = document.createElement('div');
        measureNumber.className = 'measure-number';
        measureNumber.textContent = index + 1;
        measure.appendChild(measureNumber);

        const chordControls = document.createElement('div');
        chordControls.className = 'chord-controls';
        const chordSelect = document.createElement('select');
        chordSelect.className = 'chord-select';
        const chordOptions = Object.keys(scaleDegrees[selectedKey.endsWith('m') ? 'minor' : 'major'])
            .map(degree => `<option value="${degree}" ${degree === chordFunction ? 'selected' : ''}>${degree}</option>`)
            .join('');
        chordSelect.innerHTML = chordOptions;
        chordSelect.onchange = () => {
            chordFunctions[index] = chordSelect.value;
            updateFretboardForMeasure(index);
        };
        chordControls.appendChild(chordSelect);
        measure.appendChild(chordControls);

        const scaleControls = document.createElement('div');
        scaleControls.className = 'scale-controls';
        const scaleSelect = document.createElement('select');
        scaleSelect.className = 'scale-select';
        scaleSelect.innerHTML = Object.keys(SCALES)
            .map(scale => `<option value="${scale}">${scale.replace(/([A-Z])/g, ' $1').toLowerCase().replace(/\b\w/g, c => c.toUpperCase())}</option>`)
            .join('');
        scaleSelect.value = getSuggestedScale(chordFunction, selectedKey);
        scaleSelect.onchange = () => updateFretboardForMeasure(index);
        scaleControls.appendChild(scaleSelect);
        measure.appendChild(scaleControls);

        measure.ondragstart = (e) => {
            e.dataTransfer.setData('text/plain', index);
            measure.classList.add('dragging');
        };
        measure.ondragover = (e) => e.preventDefault();
        measure.ondrop = (e) => {
            e.preventDefault();
            const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const toIndex = parseInt(measure.dataset.index);
            if (fromIndex !== toIndex) {
                const temp = chordFunctions[fromIndex];
                chordFunctions[fromIndex] = chordFunctions[toIndex];
                chordFunctions[toIndex] = temp;
                updateChordProgression();
                updateFretboardForMeasure(AppState.currentMeasure);
            }
            measure.classList.remove('dragging');
        };
        measure.ondragend = () => measure.classList.remove('dragging');

        UI.elements.measures.appendChild(measure);
    });

    updateFretboardForMeasure(AppState.currentMeasure);
}

function getSuggestedScale(chordFunction, key) {
    const isMinor = key.endsWith('m');
    if (isMinor) {
        if (chordFunction.includes('im7') || chordFunction.includes('i7')) return 'minor';
        if (chordFunction.includes('V7')) return 'harmonicMinor';
        if (chordFunction.includes('iim7b5')) return 'locrian';
        if (chordFunction.includes('ivm7')) return 'dorian';
        return 'minor';
    } else {
        if (chordFunction.includes('Imaj7') || chordFunction.includes('I7')) return 'major';
        if (chordFunction.includes('V7')) return 'mixolydian';
        if (chordFunction.includes('iim7')) return 'dorian';
        if (chordFunction.includes('viim7b5')) return 'locrian';
        return 'major';
    }
}

function updateFretboardForMeasure(measureIndex) {
    const measure = UI.elements.measures.children[measureIndex];
    if (!measure) return;
    const chordSelect = measure.querySelector('.chord-select');
    const scaleSelect = measure.querySelector('.scale-select');
    const chordFunction = chordSelect.value;
    const scaleType = scaleSelect.value;
    const key = UI.elements.keySelect.value;
    const chord = getChordFromFunction(chordFunction, key);
    const [root, quality] = parseChord(chord);
    const scaleNotes = getScaleNotes(root, scaleType);
    const tuning = TUNINGS[UI.elements.chordTuning.value] || TUNINGS.standard;
    Array.from(UI.elements.measures.children).forEach((m, i) => {
        m.classList.toggle('active', i === measureIndex);
    });
    renderFretboard(
        UI.elements.chordFretboard,
        tuning,
        scaleNotes,
        root,
        scaleType,
        `${chordFunction} (${chord})`
    );
}

function parseChord(chord) {
    const match = chord.match(/^([A-G][b#]?)(.*)$/);
    if (!match) return ['C', 'major'];
    const [, root, quality] = match;
    switch (quality) {
        case 'maj7': return [root, 'maj7'];
        case 'min7': case 'm7': return [root, 'min7'];
        case 'dom7': case '7': return [root, 'dom7'];
        case 'min7b5': case 'm7b5': return [root, 'min7b5'];
        case 'dim7': return [root, 'dim7'];
        default: return [root, 'major'];
    }
}

function addMeasure() {
    const progressionSelect = UI.elements.progressionSelect;
    const selectedProgression = progressionSelect.value;
    const progressionData = progressions[selectedProgression] || progressions["I V7"];
    const chordFunctions = progressionData.progression;
    chordFunctions.push('Imaj7');
    updateChordProgression();
}

function removeMeasure() {
    const progressionSelect = UI.elements.progressionSelect;
    const selectedProgression = progressionSelect.value;
    const progressionData = progressions[selectedProgression] || progressions["I V7"];
    const chordFunctions = progressionData.progression;
    if (chordFunctions.length > 1) {
        chordFunctions.pop();
        updateChordProgression();
    }
}

// Metronome Logic
let lastBeatTime = 0;
let tapTimes = [];

async function playMetronomeSound(beat, isAccented = false) {
    try {
        await AudioContextManager.ensureAudioContext();
        const soundType = UI.elements.soundType.value;
        const volume = parseFloat(UI.elements.metronomeVolume.value) || 0.25;
        const accentIntensity = parseFloat(UI.elements.accentIntensity.value) || 1.5;
        let buffer;
        if (soundType === 'drums') {
            const pattern = DRUM_PATTERNS[UI.elements.timeSignature.value];
            const drumSet = drumSoundSets[currentDrumSetIndex];
            if (pattern.kick[beat % pattern.kick.length]) {
                buffer = AudioContextManager.soundBuffers['kick'] || await AudioContextManager.createDrumSound('kick');
            } else if (pattern.snare[beat % pattern.snare.length]) {
                buffer = AudioContextManager.soundBuffers['snare'] || await AudioContextManager.createDrumSound('snare');
            } else if (pattern.hihat[beat % pattern.hihat.length]) {
                buffer = AudioContextManager.soundBuffers['hihat'] || await AudioContextManager.createDrumSound('hihat');
            }
        } else {
            buffer = AudioContextManager.soundBuffers[soundType] || AudioContextManager.soundBuffers['click'];
        }
        if (!buffer) {
            console.warn(`No buffer for sound type ${soundType}`);
            return;
        }
        const source = AudioContextManager.context.createBufferSource();
        source.buffer = buffer;
        const gainNode = AudioContextManager.context.createGain();
        gainNode.gain.value = isAccented ? volume * accentIntensity : volume;
        source.connect(gainNode);
        gainNode.connect(AudioContextManager.context.destination);
        source.start();
    } catch (error) {
        console.error('Error playing metronome sound:', error);
    }
}

function updateBeatsContainer() {
    const beatsContainer = document.querySelector('.beats-container');
    const timeSignature = parseInt(UI.elements.timeSignature.value);
    beatsContainer.innerHTML = '';
    for (let i = 0; i < timeSignature; i++) {
        const beat = document.createElement('div');
        beat.className = 'beat';
        beat.textContent = i === 0 ? '1' : i + 1;
        beat.dataset.accented = i === 0 ? 'true' : 'false';
        beat.onclick = () => {
            beat.dataset.accented = beat.dataset.accented === 'true' ? 'false' : 'true';
            beat.style.background = beat.dataset.accented === 'true' ? '#4CAF50' : '#9E9E9E';
        };
        beatsContainer.appendChild(beat);
    }
}

async function playBeat() {
    if (!AppState.isPlaying) return;
    const timeSignature = parseInt(UI.elements.timeSignature.value);
    const beats = document.querySelectorAll('.beat');
    const currentBeatElement = beats[AppState.currentBeat];
    if (!currentBeatElement) return;

    // Update visual feedback
    beats.forEach((beat, index) => {
        beat.classList.toggle('active', index === AppState.currentBeat);
    });

    // Play metronome sound
    const isAccented = currentBeatElement.dataset.accented === 'true';
    await playMetronomeSound(AppState.currentBeat, isAccented);

    // Handle chord progression
    const measures = UI.elements.measures.children;
    const currentMeasure = measures[AppState.currentMeasure];
    if (currentMeasure) {
        const chordSelect = currentMeasure.querySelector('.chord-select');
        const chordFunction = chordSelect.value;
        const key = UI.elements.keySelect.value;
        const chord = getChordFromFunction(chordFunction, key);
        const [root, quality] = parseChord(chord);

        // Play chord on first beat or every beat in 3/4
        if (AppState.currentBeat === 0 || timeSignature === 3) {
            const duration = timeSignature === 3 ? 1.5 : 2;
            await playChord(root, quality, AudioContextManager.context.currentTime, duration);
            updateFretboardForMeasure(AppState.currentMeasure);
        }
    }

    // Advance beat and measure
    AppState.currentBeat = (AppState.currentBeat + 1) % timeSignature;
    if (AppState.currentBeat === 0) {
        AppState.currentMeasure = (AppState.currentMeasure + 1) % measures.length;
    }

    // Schedule next beat
    const interval = 60000 / AppState.tempo;
    setTimeout(playBeat, interval);
}

function startMetronome() {
    if (AppState.isPlaying) return;
    AppState.updateState({ isPlaying: true, currentBeat: 0, currentMeasure: 0 });
    UI.elements.startStopButton.textContent = 'Stop';
    playBeat();
}

function stopMetronome() {
    AppState.updateState({ isPlaying: false });
    UI.elements.startStopButton.textContent = 'Start';
    document.querySelectorAll('.beat').forEach(beat => beat.classList.remove('active'));
}

// FretFlow Logic
function initializeFretFlow() {
    const fretboardsGrid = UI.elements.fretboardsGrid;
    const positions = [
        { startFret: 0, endFret: 5 },
        { startFret: 5, endFret: 10 },
        { startFret: 7, endFret: 12 }
    ];

    fretboardsGrid.innerHTML = '';
    positions.forEach((pos, index) => {
        const container = document.createElement('div');
        container.className = 'fretboard-container';
        const scaleDisplay = document.createElement('div');
        scaleDisplay.className = 'scale-display';
        container.appendChild(scaleDisplay);
        const fretboard = document.createElement('div');
        fretboard.className = 'fretboard';
        container.appendChild(fretboard);
        fretboardsGrid.appendChild(container);
        updateFretFlowFretboard(index);
    });
}

function updateFretFlowFretboard(index) {
    const fretboards = UI.elements.fretboardsGrid.children;
    const container = fretboards[index];
    if (!container) return;
    const fretboard = container.querySelector('.fretboard');
    const key = UI.elements.fretflowKey.value;
    const scaleType = UI.elements.fretflowScale.value;
    const scaleNotes = getScaleNotes(key, scaleType);
    const tuning = TUNINGS.standard;
    const positions = [
        { startFret: 0, endFret: 5 },
        { startFret: 5, endFret: 10 },
        { startFret: 7, endFret: 12 }
    ];
    const { startFret, endFret } = positions[index];
    renderFretboard(fretboard, tuning, scaleNotes, key, scaleType, null, startFret, endFret);
}

// Event Listeners
function setupEventListeners() {
    UI.elements.chordTuning.onchange = () => updateFretboardForMeasure(AppState.currentMeasure);
    UI.elements.progressionSelect.onchange = updateChordProgression;
    UI.elements.keySelect.onchange = updateChordProgression;
    UI.elements.timeSignature.onchange = updateBeatsContainer;
    UI.elements.soundType.onchange = () => {
        const isDrums = UI.elements.soundType.value === 'drums';
        UI.elements.drumSetToggleBtn.style.display = isDrums ? 'inline-block' : 'none';
    };
    UI.elements.metronomeVolume.oninput = () => log(`Metronome volume: ${UI.elements.metronomeVolume.value}`);
    UI.elements.chordFretboardVolume.oninput = () => log(`Chord fretboard volume: ${UI.elements.chordFretboardVolume.value}`);
    UI.elements.chordVolume.oninput = () => log(`Chord volume: ${UI.elements.chordVolume.value}`);
    UI.elements.fretboardVolume.oninput = () => log(`Fretboard volume: ${UI.elements.fretboardVolume.value}`);
    UI.elements.tempo.oninput = () => {
        AppState.updateState({ tempo: parseInt(UI.elements.tempo.value) });
        UI.elements.tempoDisplay.textContent = `${AppState.tempo} BPM`;
    };
    UI.elements.tapTempo.onclick = () => {
        const now = performance.now();
        tapTimes.push(now);
        if (tapTimes.length > 4) tapTimes.shift();
        if (tapTimes.length >= 2) {
            const intervals = tapTimes.slice(1).map((t, i) => t - tapTimes[i]);
            const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
            const tempo = Math.round(60000 / avgInterval);
            if (tempo >= 40 && tempo <= 220) {
                AppState.updateState({ tempo });
                UI.elements.tempo.value = tempo;
                UI.elements.tempoDisplay.textContent = `${tempo} BPM`;
            }
        }
    };
    UI.elements.startStopButton.onclick = () => {
        if (AppState.isPlaying) {
            stopMetronome();
        } else {
            startMetronome();
        }
    };
    UI.elements.fretflowKey.onchange = () => initializeFretFlow();
    UI.elements.fretflowScale.onchange = () => initializeFretFlow();
    UI.elements.chordsEnabled.onclick = () => {
        UI.elements.chordsEnabled.classList.toggle('active');
        UI.elements.chordsEnabled.textContent = UI.elements.chordsEnabled.classList.contains('active') ? 'Chords Enabled' : 'Chords Disabled';
    };
    UI.elements.drumSetToggleBtn.onclick = () => {
        currentDrumSetIndex = (currentDrumSetIndex + 1) % drumSoundSets.length;
        UI.elements.drumSetToggleBtn.textContent = drumSoundSets[currentDrumSetIndex].name;
        log(`Switched to drum set: ${drumSoundSets[currentDrumSetIndex].name}`);
    };
    UI.elements.accentIntensity.oninput = () => log(`Accent intensity: ${UI.elements.accentIntensity.value}`);
    UI.elements.darkModeToggle.onclick = () => {
        const modes = ['dark-mode', 'dark-mode-2', 'dark-mode-3'];
        let currentModeIndex = modes.findIndex(mode => document.body.classList.contains(mode));
        document.body.classList.remove(...modes);
        currentModeIndex = (currentModeIndex + 1) % (modes.length + 1);
        if (currentModeIndex > 0) {
            document.body.classList.add(modes[currentModeIndex - 1]);
            UI.elements.darkModeToggle.classList.add(`active-${currentModeIndex}`);
        } else {
            UI.elements.darkModeToggle.classList.remove('active-1', 'active-2', 'active-3');
        }
        UI.elements.darkModeToggle.classList.toggle('active', currentModeIndex > 0);
        UI.elements.darkModeToggle.textContent = currentModeIndex === 0 ? 'Dark Mode' : `Dark Mode ${currentModeIndex}`;
        AppState.updateState({ darkMode: currentModeIndex > 0 });
    };
}

// Initialization
async function initializeApp() {
    UI.init();
    await ensureAudioInitialized();
    updateBeatsContainer();
    updateChordProgression();
    initializeFretFlow();
    initializeScaleSelects();
    setupEventListeners();
    UI.elements.drumSetToggleBtn.style.display = UI.elements.soundType.value === 'drums' ? 'inline-block' : 'none';
    log("Application initialized");
}

document.addEventListener('DOMContentLoaded', initializeApp);
</script>
