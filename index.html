
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bebop Blueprint</title>
    <link rel="icon" type="image/png" href="jazzmaster.png">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1f618d;
        }
        .app-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .fretboards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .fretboard-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .scale-display {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            color: #333;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .controls-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .control-group label {
            font-weight: bold;
        }
        
        .control-group select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .fretboard {
            position: relative;
            height: 200px;
            background-color: #FFCF79;
            border-radius: 5px;
            margin-bottom: 30px;
            border: 2px solid #4B1C2E;
            overflow: visible;
        }
        .fret-line {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: #c0c0c0;
            border-right: 1px solid rgba(0, 0, 0, 0.3);
            z-index: 1;
        }
        .string-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 1px;
            background: silver;
            border-bottom: 1px solid rgba(0, 0, 0, 0.3);
            z-index: 0;
        }
        .fret-number {
            position: absolute;
            bottom: -40px;
            font-size: 16px;
            color: #1f618d;
            transform: translateX(-50%);
            font-weight: bold;
            z-index: 2;
            width: 20px;
            text-align: center;
        }
        .fret-marker {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #333;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .note {
            position: absolute;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            z-index: 3;
            cursor: pointer;
            transform: translate(-50%, -50%);
            transition: transform 0.1s ease;
        }
        .note:hover {
            transform: translate(-50%, -50%) scale(1.2);
        }
        .beat {
            width: 40px;
            height: 80px;
            background: #9E9E9E;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.2s ease;
            font-size: 14px;
            margin: 0 2px;
        }
        .beats-container {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            flex-wrap: nowrap;
        }
        .beat.active {
            transform: translateY(-10px);
        }
        #measures {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .measure {
            position: relative;
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            transition: opacity 0.2s ease;
        }
        .measure.dragging {
            opacity: 0.5;
        }
        .measure.active {
            background-color: #c3e6cb;
            border: 2px solid #28a745;
        }
        .measure-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            color: #333;
        }
        .chord-controls, .scale-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .chord-controls select, .scale-controls select {
            flex: 1;
        }

        .fretboard-section {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        /* Dark Mode 1 */
        body.dark-mode .fretboard-section {
            background-color: #23272e;
            border-color: #444;
            color: #fefae0;
        }
        
        /* Dark Mode 2 */
        body.dark-mode-2 .fretboard-section {
            background-color: #001f54;
            border-color: #1282a2;
            color: #fefcfb;
        }
        
        /* Dark Mode 3 */
        body.dark-mode-3 .fretboard-section {
            background-color: #a5a58d;
            border-color: #cb997e;
            color: #ffe8d6;
        }
        
        /* Dark Mode 1 */
        body.dark-mode .fretboard-section {
            background-color: #23272e;
            border-color: #444;
            color: #fefae0;
        }
        
        /* Dark Mode 2 */
        body.dark-mode-2 .fretboard-section {
            background-color: #001f54;
            border-color: #1282a2;
            color: #fefcfb;
        }
        
        /* Dark Mode 3 */
        body.dark-mode-3 .fretboard-section {
            background-color: #a5a58d;
            border-color: #cb997e;
            color: #ffe8d6;
        }
        .fretboard-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: bold;
            font-size: 0.9em;
        }
        
        .control-group select {
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        
        .scale-display {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .fretboard {
            width: 100%;
            margin-top: 10px;
        }
        
        @media (max-width: 1200px) {
            #measures {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (max-width: 600px) {
            #measures {
                grid-template-columns: 1fr;
            }
        }
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        select {
            padding: 5px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        #tempo-display {
            font-size: 1.2em;
            font-weight: bold;
            margin: 0 10px;
        }
        #loading-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 5px;
            z-index: 1000;
        }

        .checkbox-wrapper {
            margin-top: 20px;  /* Add space above the button */
            margin-left: 20px; /* Move button to the left */
            display: flex;
            align-items: center;
        }

        .control-button {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .control-button:hover {
            background: #45a049;
        }
        
        /* Optional: adjust the button itself for better alignment */
        #chordsEnabled {
            margin-bottom: 10px;  /* Add some space below the button */
            padding: 8px 16px;    /* Slightly adjust padding if needed */
        }
        body.dark-mode {
            background-color: #283618;
            color: #fefae0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .dark-mode .app-section {
            background: linear-gradient(145deg, #283618, #606c38);
            color: #fefae0;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .fretboard-container {
            background-color: #606c38;
            border: 1px solid #dda15e;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .dark-mode .fretboard {
            background-color: #dda15e;
            border: 2px solid #4b4b4b;
            border-radius: 5px;
        }
        .dark-mode .note {
            background-color: #dda15e;
            color: #283618;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .note:hover {
            transform: scale(1.2);
            background-color: #bc6c25;
        }
        .dark-mode .scale-display {
            color: #fefae0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .dark-mode button {
            background-color: #dda15e;
            color: #283618;
            border: 1px solid #bc6c25;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode button:hover {
            background-color: #bc6c25;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .dark-mode select {
            background-color: #dda15e;
            color: #283618;
            border: 1px solid #bc6c25;
        }
        .dark-mode select:hover {
            background-color: #bc6c25;
        }
        .dark-mode .measure {
            background-color: #606c38;
            color: #fefae0;
            border: 1px solid #dda15e;
        }
        .dark-mode .measure.active {
            background-color: #dda15e;
            border-color: #bc6c25;
        }
        .dark-mode .beat {
            background-color: #dda15e;
            color: #283618;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .dark-mode .beat.active {
            background-color: #bc6c25;
            transform: translateY(-5px);
        }
        .dark-mode .volume-control {
            color: #fefae0;
        }
        .dark-mode .volume-control input[type="range"] {
            background: #606c38;
        }
        .dark-mode .volume-control input[type="range"]::-webkit-slider-thumb {
            background: #dda15e;
            border: 1px solid #bc6c25;
        }
        #dark-mode-toggle.active {
            background-color: #283618;
            color: #fefae0;
            border: 1px solid #dda15e;
        }

        .dark-mode-2 {
            background-color: #0a1128;
            color: #fefcfb;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .dark-mode-2 .app-section {
            background: linear-gradient(145deg, #001f54, #034078);
            color: #fefcfb;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode-2 .fretboard-container {
            background-color: #034078;
            border: 1px solid #1282a2;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .dark-mode-2 .fretboard {
            background-color: #001f54;
            border: 2px solid #1282a2;
            border-radius: 5px;
        }
        
        .dark-mode-2 .note {
            background-color: #1282a2;
            color: #fefcfb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode-2 .scale-display {
            color: #fefcfb;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .dark-mode-2 button {
            background-color: #1282a2;
            color: #fefcfb;
            border: 1px solid #034078;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode-2 select {
            background-color: #034078;
            color: #fefcfb;
            border: 1px solid #1282a2;
        }
        
        .dark-mode-2 .measure {
            background-color: #034078;
            color: #fefcfb;
            border: 1px solid #1282a2;
        }
        
        .dark-mode-2 .measure.active {
            background-color: #1282a2;
            border-color: #fefcfb;
        }
        
        .dark-mode-2 .beat {
            background-color: #1282a2;
            color: #fefcfb;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode-2 .beat.active {
            background-color: #034078;
            transform: translateY(-5px);
        }

        /* Add these to your existing dark mode CSS sections */
        .dark-mode #fretflow-section {
            background: linear-gradient(145deg, #283618, #606c38);
            color: #fefae0;
        }
        
        .dark-mode-2 #fretflow-section {
            background: linear-gradient(145deg, #001f54, #034078);
            color: #fefcfb;
        }
        
        .dark-mode-3 #fretflow-section {
            background: linear-gradient(145deg, #6b705c, #a5a58d);
            color: #ffe8d6;
        }
        
                .toggle-button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-button.active {
            background: #4CAF50;
        }
        
        .toggle-button:not(.active) {
            background: #9E9E9E;
        }
        
        #dark-mode-toggle.active-2 {
            background-color: #1282a2;
            color: #fefcfb;
            border: 1px solid #034078;
        }
        
        .dark-mode-3 {
            background-color: #6b705c;
            color: #ffe8d6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .dark-mode-3 .app-section {
            background: linear-gradient(145deg, #6b705c, #a5a58d);
            color: #ffe8d6;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode-3 .fretboard-container {
            background-color: #606c38;
            border: 1px solid #cb997e;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .dark-mode-3 .fretboard {
            background-color: #cb997e;
            border: 2px solid #6b705c;
            border-radius: 5px;
        }
        
        .dark-mode-3 .note {
            background-color: #b7b7a4;
            color: #6b705c;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode-3 .scale-display {
            color: #ffe8d6;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .dark-mode-3 button {
            background-color: #cb997e;
            color: #ffe8d6;
            border: 1px solid #6b705c;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode-3 select {
            background-color: #ddbea9;
            color: #6b705c;
            border: 1px solid #cb997e;
        }
        
        .dark-mode-3 .measure {
            background-color: #a5a58d;
            color: #ffe8d6;
            border: 1px solid #cb997e;
        }
        
        .dark-mode-3 .measure.active {
            background-color: #ddbea9;
            border-color: #cb997e;
        }
        
        .dark-mode-3 .beat {
            background-color: #ddbea9;
            color: #6b705c;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .dark-mode-3 .beat.active {
            background-color: #cb997e;
            transform: translateY(-5px);
        }
        
        .dark-mode-3 .volume-control {
            color: #ffe8d6;
        }
        
        #dark-mode-toggle.active-3 {
            background-color: #cb997e;
            color: #ffe8d6;
            border: 1px solid #6b705c;
        }
        
    </style>
</head>
<body>
    <div class="app-section" id="chord-fretboard-section">
        <h1>BEBOP BLUEPRINT</h1>
        <h3>Fretflow - Dynamic Fretboard with Scales that Move with the Chord Progression</h3>
        <button id="dark-mode-toggle" aria-label="Toggle dark mode">Dark Mode</button>
        <div class="volume-control">
            <span>Fretboard Volume:</span>
            <input type="range" id="chord-fretboard-volume" min="0" max="1" step="0.1" value="0.3">
        </div>
        <div class="fretboard-container">
            <div class="scale-display" id="scale-display"></div>
            <div class="controls">
                <select class="tuning-select" id="chord-tuning" aria-label="Select guitar tuning">
                    <option value="standard">Standard (EADGBE)</option>
                    <option value="dropD">Drop D (DADGBE)</option>
                    <option value="openG">Open G (DGDGBD)</option>
                    <option value="DADGAD">DADGAD</option>
                    <option value="openE">Open E (EBEG#BE)</option>
                </select>
            </div>
            <div id="chord-fretboard" class="fretboard"></div>
        </div>
    </div>

    <div class="app-section" id="metronome-section">
        <h2>BeatForge Metronome</h2>
        <h3>Click to accent strong beats</h3>
        <div class="controls">
            <select id="time-signature" aria-label="Select time signature">
                <option value="2">2/4</option>
                <option value="3">3/4</option>
                <option value="4" selected>4/4</option>
                <option value="6">6/8</option>
                <option value="7">7/8</option>
                <option value="8">8/8</option>
                <option value="12">12/8</option>
            </select>
            <select id="sound-type" aria-label="Select metronome sound">
                <option value="click">Click</option>
                <option value="woodblock">Woodblock</option>
                <option value="drums">Drums</option>
            </select>
            <button id="drumSetToggleBtn" class="control-button">Drums</button>
            <div class="volume-control">
                <span>Metronome Volume:</span>
                <input type="range" id="metronome-volume" min="0" max="1" step="0.1" value="0.25" aria-label="Metronome volume">
            </div>
            <input type="range" id="tempo" min="40" max="220" value="120" aria-label="Tempo">
            <span id="tempo-display">120 BPM</span>
            <button id="tap-tempo" aria-label="Tap tempo">Tap Tempo</button>
            <button id="start-stop" aria-label="Start or stop metronome">Start</button>
        </div>
        <div class="beats-container"></div>
    </div>

    <div class="volume-control">
        <label for="accent-intensity">Accent Intensity:</label>
        <input type="range" id="accent-intensity" min="1" max="2" step="0.1" value="1.5" aria-label="Accent intensity">
    </div>
    
    <div class="app-section" id="chord-progression-section">
        <h2>Chord Progression Practice</h2>
        <h3>Create a progression or pick one from the dropdown. Choose which key and scale to go with it.</h3>
        <label for="progression-select">Select Progression:</label>
        <select id="progression-select" aria-label="Select chord progression">
<option value="I V7">I-V7</option>
            <option value="jazz_blues">Jazz Blues</option>
            <option value="minor_blues">Minor Blues</option>
            <option value="rhythm_changes">Rhythm Changes</option>
            <option value="2_5_1">II-V-I</option>
            <option value="6_2_5_1">VI-II-V-I</option>
            <option value="minor 2_5_1">Minor iim-V7-im</option>
            <option value="dark_eyes">Dark Eyes</option>
            <option value="ill_see_you_in_my_dreams">I'll See You In My Dreams</option>
            <option value="rose_room">Rose Room</option>
            <option value="black_orpheus">Black Orpheus</option>
            <option value="all_the_things_you_are">All The Things You Are</option>
            <option value="all_of_me">All of Me</option>
            <option value="stella_by_starlight">Stella By Starlight</option>
            <option value="autumn_leaves">Autumn Leaves</option>
            <option value="summertime">Summertime</option>
            <option value="girl_from_ipanema">Girl From Ipanema</option>
            <option value="coltrane_changes">Coltrane Changes</option>
            <option value="bird_blues">Bird Blues</option>
            <option value="just_friends">Just Friends</option>
            <option value="blue_bossa">Blue Bossa</option>
            <option value="on_green_dolphin_street">On Green Dolphin Street</option>
            <option value="solar">Solar</option>
            <option value="misty">Misty</option>
            <option value="days_of_wine_and_roses">Days of Wine and Roses</option>
            <option value="cherokee">Cherokee</option>
            <option value="caravan">Caravan</option>
            <option value="nows_the_time">Now's The Time</option>
            <option value="tenor_madness">Tenor Madness</option>
        </select>
        <label for="keySelect">Select Key:</label>
        <select id="keySelect" aria-label="Select key">
          <option value="C">C</option>
          <option value="Cm">Cm</option>
          <option value="Db">Db</option>
          <option value="Dbm">Dbm</option>
          <option value="D">D</option>
          <option value="Dm">Dm</option>
          <option value="Eb">Eb</option>
          <option value="Ebm">Ebm</option>
          <option value="E">E</option>
          <option value="Em">Em</option>
          <option value="F">F</option>
          <option value="Fm">Fm</option>
          <option value="Gb">Gb</option>
          <option value="Gbm">Gbm</option>
          <option value="G">G</option>
          <option value="Gm">Gm</option>
          <option value="Ab">Ab</option>
          <option value="Abm">Abm</option>
          <option value="A">A</option>
          <option value="Am">Am</option>
          <option value="Bb">Bb</option>
          <option value="Bbm">Bbm</option>
          <option value="B">B</option>
          <option value="Bm">Bm</option>
        </select>
        <div id="measures">
            <!-- Measures will be populated dynamically -->
        </div>
        <button onclick="addMeasure()" aria-label="Add measure">Add Measure</button>
        <button onclick="removeMeasure()" aria-label="Remove measure">Remove Measure</button>
        <div class="checkbox-wrapper">
            <button id="chordsEnabled" class="toggle-button active">Chords Enabled</button>
        </div>
        <div class="volume-control">
            <label for="chord-volume">Chord Volume:</label>
            <input type="range" id="chord-volume" min="0" max="1" step="0.1" value="0.75" aria-label="Chord volume">
        </div>
    </div>

<div class="app-section" id="fretflow-section">
    <h2>FretFlow</h2>
    <h3>Multiple scale workout</h3>
    <!-- controls-container and volume-control removed -->
    <div class="fretboards-grid"></div>
</div>

    <script>
  // Utility Functions
function log(message) {
    console.log(`[FretFlow Debug] ${message}`);
}

function updateLoadingStatus(message) {
    let indicator = document.getElementById('loading-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'loading-indicator';
        document.body.appendChild(indicator);
    }
    indicator.textContent = message;
}

function debounce(func, wait) {
    let timeout;
    return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Musical Constants
const NOTES = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

const ALL_NOTES = [
    'a', 'as', 'b', 'c', 'cs', 'd', 'ds', 'e', 'f', 'fs', 'g', 'gs'
];
const OCTAVES = [2, 3, 4, 5];
const FILE_FORMAT = 'wav';

const SAMPLE_NOTE_MAP = {
    'C': 'c',
    'C#': 'cs',
    'Db': 'cs',
    'D': 'd',
    'D#': 'ds',
    'Eb': 'ds',
    'E': 'e',
    'F': 'f',
    'F#': 'fs',
    'Gb': 'fs',
    'G': 'g',
    'G#': 'gs',
    'Ab': 'gs',
    'A': 'a',
    'A#': 'as', // Matches as3.wav
    'Bb': 'as', // Matches as3.wav
    'B': 'b'
};

const allSampleFiles = [];
for (const note of ALL_NOTES) {
    for (const octave of OCTAVES) {
        allSampleFiles.push(getSampleFileName(note, octave));
    }
}

const PIANO_CONFIG = {
    notes: ALL_NOTES,
    octaves: OCTAVES,
    velocities: [12],
    fileFormat: FILE_FORMAT
};

const ENHARMONIC_MAP = {
    'C#': 'Db', 'Db': 'Db',
    'D#': 'Eb', 'Eb': 'Eb',
    'F#': 'Gb', 'Gb': 'Gb',
    'G#': 'Ab', 'Ab': 'Ab',
    'A#': 'Bb', 'Bb': 'Bb'
};

const PIANO_NOTES = {
    'A2': 110.00, 'As2': 116.54, 'B2': 123.47,
    'C3': 130.81, 'Cs3': 138.59, 'D3': 146.83, 'Ds3': 155.56, 'E3': 164.81, 'F3': 174.61,
    'Fs3': 185.00, 'G3': 196.00, 'Gs3': 207.65, 'A3': 220.00, 'As3': 233.08, 'B3': 246.94,
    'C4': 261.63, 'Cs4': 277.18, 'D4': 293.66, 'Ds4': 311.13, 'E4': 329.63
};

function standardizeNoteName(note) {
    if (!note) return '';
    note = note.toUpperCase().trim();
    const flatToSharp = {
        'BB': 'A#',
        'DB': 'C#',
        'EB': 'D#',
        'GB': 'F#',
        'AB': 'G#'
    };
    note = note.replace('♭', 'b').replace('♯', '#');
    if (note.includes('b')) {
        const flatNote = note.replace('b', 'B');
        return flatToSharp[flatNote] || note;
    }
    return note;
}

const FRETBOARD_FREQUENCIES = {
    'string6': [82.41, 87.31, 92.50, 98.00, 103.83, 110.00, 116.54, 123.47, 130.81, 138.59, 146.83, 155.56, 164.81],
    'string5': [110.00, 116.54, 123.47, 130.81, 138.59, 146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00],
    'string4': [146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66],
    'string3': [196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00],
    'string2': [246.94, 261.63, 277.18, 293.66, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88],
    'string1': [329.63, 349.23, 369.99, 392.00, 415.30, 440.00, 466.16, 493.88, 523.25, 554.37, 587.33, 622.25, 659.25]
};

const SCALES = {
    major: [0, 2, 4, 5, 7, 9, 11],
    minor: [0, 2, 3, 5, 7, 8, 10],
    harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
    melodicMinor: [0, 2, 3, 5, 7, 9, 11],
    dorian: [0, 2, 3, 5, 7, 9, 10],
    phrygian: [0, 1, 3, 5, 7, 8, 10],
    lydian: [0, 2, 4, 6, 7, 9, 11],
    mixolydian: [0, 2, 4, 5, 7, 9, 10],
    locrian: [0, 1, 3, 5, 6, 8, 10],
    bebopDominant: [0, 2, 4, 5, 7, 9, 10, 11],
    bebopMajor: [0, 2, 4, 5, 7, 8, 9, 11],
    bebopDorian: [0, 2, 3, 4, 5, 7, 9, 10],
    bebopPhrygian: [0, 1, 2, 3, 5, 7, 8, 10],
    altered: [0, 1, 3, 4, 6, 8, 10],
    lydianDominant: [0, 2, 4, 6, 7, 9, 10],
    diminishedWH: [0, 2, 3, 5, 6, 8, 9, 11],
    diminishedHW: [0, 1, 3, 4, 6, 7, 9, 10],
    wholeHalf: [0, 2, 4, 6, 8, 10],
    pentatonicMajor: [0, 2, 4, 7, 9],
    pentatonicMinor: [0, 3, 5, 7, 10],
    blues: [0, 3, 5, 6, 7, 10],
    majorBlues: [0, 2, 3, 4, 7, 9],
    halfWhole: [0, 1, 3, 4, 6, 7, 9, 10],
    harmonicMajor: [0, 2, 4, 5, 7, 8, 11],
    doubleHarmonic: [0, 1, 4, 5, 7, 8, 11],
    enigmatic: [0, 1, 4, 6, 8, 10, 11],
    persian: [0, 1, 4, 5, 6, 8, 11],
    arabic: [0, 2, 4, 5, 6, 8, 10],
    japanese: [0, 2, 5, 7, 8],
    egyptian: [0, 2, 5, 7, 10]
};

const TUNINGS = {
    standard: ['E', 'B', 'G', 'D', 'A', 'E'],
    dropD: ['E', 'B', 'G', 'D', 'A', 'D'],
    openG: ['D', 'B', 'G', 'D', 'G', 'D'],
    DADGAD: ['D', 'A', 'G', 'D', 'A', 'D'],
    openE: ['E', 'B', 'E', 'Ab', 'B', 'E']
};

const DRUM_PATTERNS = {
    '2': { kick: [1, 0], snare: [0, 1], hihat: [1, 1] },
    '3': { kick: [1, 0, 0], snare: [0, 1, 0], hihat: [1, 1, 1] },
    '4': { kick: [1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1, 1] },
    '6': { kick: [1, 0, 0, 1, 0, 0], snare: [0, 0, 1, 0, 0, 1], hihat: [1, 1, 1, 1, 1, 1] },
    '7': { kick: [1, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1] },
    '8': { kick: [1, 0, 0, 0, 1, 0, 0, 0], snare: [0, 0, 1, 0, 0, 0, 1, 0], hihat: [1, 1, 1, 1, 1, 1, 1, 1] },
    '12': { kick: [1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0], snare: [0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1], hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1] }
};

let currentDrumSetIndex = 0;
const drumSoundSets = [
    {
        name: "Drums",
        snare: "Snare.wav",
        hihat: "HiHat.wav",
        kick: "Kick.wav"
    },
    {
        name: "Makaya",
        snare: "Snare2.wav",
        hihat: "HiHat2.wav",
        kick: "Kick2.wav"
    },
    {
        name: "PhillyJoe",
        kick: 'jazzkick.wav',
        snare: 'jazzsnare.wav',
        hihat: 'jazzhat.wav'
    }
];

// Updated progressions object with explicit chord definitions
const progressions = {
    "I V7": { 
        defaultKey: "C", 
        chords: [
            { root: "C", quality: "maj7" },
            { root: "G", quality: "7" }
        ]
    },
    "jazz_blues": { 
        defaultKey: "Bb", 
        chords: [
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "F", quality: "7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "F", quality: "7" }
        ]
    },
    "minor_blues": { 
        defaultKey: "Am", 
        chords: [
            { root: "A", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "A", quality: "min7" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "A", quality: "min7" },
            { root: "A", quality: "min7" },
            { root: "E", quality: "7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "E", quality: "7" }
        ]
    },
    "rhythm_changes": { 
        defaultKey: "Bb", 
        chords: [
            { root: "Bb", quality: "6" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "7" },
            { root: "Bb", quality: "6" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "7" },
            { root: "Bb", quality: "6" },
            { root: "Eb", quality: "7" },
            { root: "Bb", quality: "6" },
            { root: "Bb", quality: "6" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "7" },
            { root: "Bb", quality: "6" },
            { root: "F", quality: "7" }
        ]
    },
    "2_5_1": { 
        defaultKey: "C", 
        chords: [
            { root: "D", quality: "min7" },
            { root: "G", quality: "7" },
            { root: "C", quality: "maj7" },
            { root: "C", quality: "maj7" }
        ]
    },
    "6_2_5_1": { 
        defaultKey: "C", 
        chords: [
            { root: "A", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "7" },
            { root: "C", quality: "maj7" },
            { root: "C", quality: "maj7" }
        ]
    },
    "minor_2_5_1": { 
        defaultKey: "Am", 
        chords: [
            { root: "B", quality: "min7b5" },
            { root: "E", quality: "7b9" },
            { root: "A", quality: "min7" },
            { root: "A", quality: "min7" }
        ]
    },
    "dark_eyes": { 
        defaultKey: "Dm", 
        chords: [
            { root: "A", quality: "7" },
            { root: "A", quality: "7" },
            { root: "D", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "A", quality: "7" },
            { root: "A", quality: "7" },
            { root: "B", quality: "6" },
            { root: "B", quality: "6" },
            { root: "G", quality: "min6" },
            { root: "G", quality: "min6" },
            { root: "D", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "A", quality: "7" },
            { root: "A", quality: "7" },
            { root: "D", quality: "min7" },
            { root: "D", quality: "min7" }
        ]
    },
    "ill_see_you_in_my_dreams": { 
        defaultKey: "F", 
        chords: [
            { root: "Bb", quality: "6" },
            { root: "Bb", quality: "6" },
            { root: "Bb", quality: "min6" },
            { root: "Bb", quality: "min6" },
            { root: "F", quality: "maj7" },
            { root: "E", quality: "7" },
            { root: "F", quality: "maj7" },
            { root: "F", quality: "maj7" },
            { root: "D", quality: "7" },
            { root: "D", quality: "7" },
            { root: "D", quality: "7" },
            { root: "D", quality: "7" },
            { root: "G", quality: "7" },
            { root: "G", quality: "7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" },
            { root: "F", quality: "maj7" }
        ]
    },
    "rose_room": { 
        defaultKey: "Ab", 
        chords: [
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "6" },
            { root: "Ab", quality: "7" },
            { root: "Db", quality: "6" },
            { root: "Db", quality: "min7" },
            { root: "Gb", quality: "7" },
            { root: "Ab", quality: "6" },
            { root: "F", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "6" },
            { root: "Ab", quality: "7" },
            { root: "Db", quality: "6" },
            { root: "Db", quality: "min7" },
            { root: "Gb", quality: "7" },
            { root: "Ab", quality: "6" },
            { root: "F", quality: "7" },
            { root: "Db", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "6" },
            { root: "F", quality: "7" }
        ]
    },
    "black_orpheus": { 
        defaultKey: "Am", 
        chords: [
            { root: "A", quality: "min7" },
            { root: "B", quality: "min7b5" },
            { root: "E", quality: "7b9" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "7" },
            { root: "C", quality: "maj7" },
            { root: "F", quality: "maj7" },
            { root: "B", quality: "min7b5" },
            { root: "E", quality: "7b9" },
            { root: "A", quality: "min7" },
            { root: "B", quality: "min7b5" },
            { root: "E", quality: "7b9" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "7" }
        ]
    },
    "all_the_things_you_are": { 
        defaultKey: "Ab", 
        chords: [
            { root: "F", quality: "min7" },
            { root: "Bb", quality: "min7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "maj7" },
            { root: "Db", quality: "maj7" },
            { root: "C", quality: "min7" },
            { root: "A", quality: "7" },
            { root: "D", quality: "maj7" },
            { root: "Bb", quality: "min7" },
            { root: "E", quality: "min7" },
            { root: "A", quality: "7" },
            { root: "D", quality: "maj7" },
            { root: "Ab", quality: "maj7" },
            { root: "Bb", quality: "min7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "maj7" },
            { root: "Bb", quality: "min7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "maj7" },
            { root: "Bb", quality: "min7" },
            { root: "E", quality: "min7" },
            { root: "A", quality: "7" },
            { root: "D", quality: "maj7" },
            { root: "Ab", quality: "maj7" }
        ]
    },
    "all_of_me": { 
        defaultKey: "C", 
        chords: [
            { root: "C", quality: "maj7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "7" },
            { root: "D", quality: "min7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "7" },
            { root: "C", quality: "maj7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "7" },
            { root: "D", quality: "min7" },
            { root: "F", quality: "maj7" },
            { root: "F", quality: "min7" },
            { root: "C", quality: "maj7" },
            { root: "G", quality: "7ERA" }
        ]
    },
    "stella_by_starlight": { 
        defaultKey: "Bb", 
        chords: [
            { root: "C", quality: "min7b5" },
            { root: "F", quality: "7b9" },
            { root: "Bb", quality: "min7" },
            { root: "Eb", quality: "7" },
            { root: "F", quality: "min7" },
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "maj7" },
            { root: "Ab", quality: "maj7" },
            { root: "A", quality: "min7b5" },
            { root: "D", quality: "7b9" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" },
            { root: "Bb", quality: "min7" },
            { root: "Eb", quality: "7" },
            { root: "Eb", quality: "maj7" },
            { root: "C", quality: "7" }
        ]
    },
    "autumn_leaves": { 
        defaultKey: "Em", 
        chords: [
            { root: "A", quality: "min7" },
            { root: "D", quality: "7" },
            { root: "G", quality: "maj7" },
            { root: "C", quality: "maj7" },
            { root: "F#", quality: "min7b5" },
            { root: "B", quality: "7b9" },
            { root: "E", quality: "min7" },
            { root: "E", quality: "min7" }
        ]
    },
    "summertime": { 
        defaultKey: "Am", 
        chords: [
            { root: "A", quality: "min7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "E", quality: "7" },
            { root: "D", quality: "min7" },
            { root: "A", quality: "min7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "min7" },
            { root: "A", quality: "min7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" }
        ]
    },
    "girl_from_ipanema": { 
        defaultKey: "F", 
        chords: [
            { root: "F", quality: "maj7" },
            { root: "G", quality: "7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" },
            { root: "F", quality: "maj7" },
            { root: "G", quality: "7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" },
            { root: "F", quality: "maj7" },
            { root: "Gb", quality: "7" },
            { root: "B", quality: "maj7" },
            { root: "F#", quality: "min7" },
            { root: "C", quality: "min7" },
            { root: "G", quality: "7" },
            { root: "F", quality: "maj7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" }
        ]
    },
    "coltrane_changes": { 
        defaultKey: "C", 
        chords: [
            { root: "C", quality: "maj7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "maj7" },
            { root: "B", quality: "7" },
            { root: "G", quality: "maj7" },
            { root: "C", quality: "7" },
            { root: "C", quality: "maj7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "maj7" },
            { root: "B", quality: "7" },
            { root: "G", quality: "maj7" },
            { root: "C", quality: "7" }
        ]
    },
    "bird_blues": { 
        defaultKey: "F", 
        chords: [
            { root: "F", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "F", quality: "7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "min7" },
            { root: "F", quality: "7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" }
        ]
    },
    "just_friends": { 
        defaultKey: "G", 
        chords: [
            { root: "G", quality: "maj7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "7" },
            { root: "G", quality: "maj7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "7" },
            { root: "G", quality: "maj7" },
            { root: "E", quality: "7" },
            { root: "A", quality: "min7" },
            { root: "D", quality: "7" },
            { root: "G", quality: "maj7" },
            { root: "E", quality: "7" }
        ]
    },
    "blue_bossa": { 
        defaultKey: "Cm", 
        chords: [
            { root: "C", quality: "min7" },
            { root: "C", quality: "min7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "C", quality: "min7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "min7" },
            { root: "Bb", quality: "7" },
            { root: "C", quality: "min7" },
            { root: "G", quality: "7" },
            { root: "C", quality: "min7" },
            { root: "C", quality: "min7" }
        ]
    },
    "on_green_dolphin_street": { 
        defaultKey: "C", 
        chords: [
            { root: "C", quality: "maj7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "maj7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "7" },
            { root: "C", quality: "maj7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "maj7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "7" },
            { root: "C", quality: "maj7" }
        ]
    },
    "solar": { 
        defaultKey: "C", 
        chords: [
            { root: "C", quality: "min7" },
            { root: "C", quality: "min7" },
            { root: "Eb", quality: "maj7" },
            { root: "Eb", quality: "maj7" },
            { root: "Ab", quality: "maj7" },
            { root: "Ab", quality: "maj7" },
            { root: "Db", quality: "7" },
            { root: "Db", quality: "7" },
            { root: "C", quality: "min7" },
            { root: "C", quality: "min7" }
        ]
    },
    "misty": { 
        defaultKey: "Eb", 
        chords: [
            { root: "Eb", quality: "maj7" },
            { root: "Eb", quality: "7" },
            { root: "Ab", quality: "maj7" },
            { root: "Ab", quality: "min7" },
            { root: "Eb", quality: "maj7" },
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "maj7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "min7" },
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "maj7" }
        ]
    },
    "days_of_wine_and_roses": { 
        defaultKey: "F", 
        chords: [
            { root: "F", quality: "maj7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" },
            { root: "F", quality: "maj7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" },
            { root: "F", quality: "maj7" },
            { root: "D", quality: "min7" },
            { root: "G", quality: "min7" },
            { root: "C", quality: "7" },
            { root: "F", quality: "maj7" }
        ]
    },
    "cherokee": { 
        defaultKey: "Bb", 
        chords: [
            { root: "Bb", quality: "maj7" },
            { root: "Bb", quality: "maj7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "7" },
            { root: "Bb", quality: "maj7" },
            { root: "Bb", quality: "maj7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "7" },
            { root: "Gb", quality: "7" },
            { root: "Gb", quality: "7" },
            { root: "F", quality: "7" },
            { root: "F", quality: "7" },
            { root: "Bb", quality: "maj7" },
            { root: "Bb", quality: "maj7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "7" }
        ]
    },
    "caravan": { 
        defaultKey: "Eb", 
        chords: [
            { root: "Eb", quality: "min7" },
            { root: "Ab", quality: "7b5" },
            { root: "Eb", quality: "min7" },
            { root: "Ab", quality: "7b5" },
            { root: "Eb", quality: "min7" },
            { root: "Ab", quality: "7b5" },
            { root: "Eb", quality: "min7" },
            { root: "Ab", quality: "7b5" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "maj7" },
            { root: "Eb", quality: "maj7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "min7" },
            { root: "Eb", quality: "min7" }
        ]
    },
    "nows_the_time": { 
        defaultKey: "F", 
        chords: [
            { root: "F", quality: "7" },
            { root: "F", quality: "7" },
            { root: "F", quality: "7" },
            { root: "F", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "F", quality: "7" },
            { root: "F", quality: "7" },
            { root: "C", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "F", quality: "7" },
            { root: "F", quality: "7" }
        ]
    },
    "tenor_madness": { 
        defaultKey: "Bb", 
        chords: [
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Eb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "C", quality: "min7" },
            { root: "F", quality: "7" },
            { root: "Bb", quality: "7" },
            { root: "Bb", quality: "7" }
        ]
    }
};

// State Management
const AppState = {
    isPlaying: false,
    currentBeat: 0,
    currentMeasure: 0,
    tempo: 120,
    audioInitialized: false,
    darkMode: false,
    listeners: [],
    updateState(newState) {
        Object.assign(this, newState);
        this.notifyListeners();
    },
    addListener(callback) {
        this.listeners.push(callback);
    },
    notifyListeners() {
        this.listeners.forEach(callback => callback(this));
    }
};

// UI Management
const UI = {
    elements: {
        chordFretboard: document.getElementById('chord-fretboard'),
        measures: document.getElementById('measures'),
        tempoDisplay: document.getElementById('tempo-display'),
        startStopButton: document.getElementById('start-stop'),
        progressionSelect: document.getElementById('progression-select'),
        keySelect: document.getElementById('keySelect'),
        scaleDisplay: document.getElementById('scale-display'),
        chordTuning: document.getElementById('chord-tuning'),
        timeSignature: document.getElementById('time-signature'),
        soundType: document.getElementById('sound-type'),
        metronomeVolume: document.getElementById('metronome-volume'),
        tempo: document.getElementById('tempo'),
        tapTempo: document.getElementById('tap-tempo'),
        chordFretboardVolume: document.getElementById('chord-fretboard-volume'),
        chordVolume: document.getElementById('chord-volume'),
        chordsEnabled: document.getElementById('chordsEnabled'),
        fretboardsGrid: document.querySelector('.fretboards-grid'),
        darkModeToggle: document.getElementById('dark-mode-toggle'),
        accentIntensity: document.getElementById('accent-intensity')
    },
    init() {
        Object.entries(this.elements).forEach(([key, el]) => {
            if (!el) console.warn(`Missing DOM element: ${key}`);
        });
    }
};

function initializeScaleSelects() {
    const scaleOptions = Object.keys(SCALES).map(scale => {
        const displayName = scale
            .replace(/([A-Z])/g, ' $1')
            .toLowerCase()
            .replace(/\b\w/g, c => c.toUpperCase());
        return `<option value="${scale}">${displayName}</option>`;
    }).join('');

    const fretflowScale = document.getElementById('fretflow-scale');
    if (fretflowScale) {
        fretflowScale.innerHTML = scaleOptions;
    }

    const measureScaleSelects = document.querySelectorAll('.scale-select');
    measureScaleSelects.forEach(select => {
        select.innerHTML = scaleOptions;
    });
}


function getSampleFileName(note, octave) {
    const sampleNote = SAMPLE_NOTE_MAP[standardizeNoteName(note)];
    return `${sampleNote}${octave}.wav`; // Ensure .wav matches your file extension
}

// Audio Management
const AudioContextManager = {
    context: null,
    soundBuffers: {},
    pianoSampleBuffers: {},
    reverbNode: null,
    samplesLoaded: false,
    currentChordGain: null,

    initialize: async function() {
        if (!this.context) {
            this.context = new (window.AudioContext || window.webkitAudioContext)();
            await this.loadSounds();
            await this.loadPianoSamples();
            await this.setupReverb();
        }
        if (this.context.state === 'suspended') {
            await this.context.resume();
        }
        AppState.updateState({ audioInitialized: true });
        return this.context;
    },

    ensureAudioContext: async function() {
        return await this.initialize();
    },

    loadSounds: async function() {
        const soundFiles = {
            'click': 'Click.wav',
            'hihat': 'HiHat.wav',
            'kick': 'Kick.wav',
            'snare': 'Snare.wav',
            'woodblock': 'woodblock.wav'
        };
        for (let [type, filename] of Object.entries(soundFiles)) {
            try {
                const response = await fetch(`./${filename}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                this.soundBuffers[type] = await this.context.decodeAudioData(arrayBuffer);
                log(`Loaded ${type} sound from ${filename}`);
            } catch (error) {
                console.error(`Failed to load ${filename}:`, error);
                this.soundBuffers[type] = await this.createDrumSound(type);
                log(`Using fallback synthetic sound for ${type}`);
            }
        }
        updateLoadingStatus("Drum sounds loaded");
    },

    createDrumSound: async function(type) {
        const sampleRate = this.context.sampleRate;
        const duration = type === 'hihat' ? 0.05 : 0.2;
        const buffer = this.context.createBuffer(1, sampleRate * duration, sampleRate);
        const data = buffer.getChannelData(0);
        switch (type) {
            case 'click':
                for (let i = 0; i < data.length; i++) data[i] = Math.sin(i * 0.05) * Math.exp(-i * 0.01);
                break;
            case 'hihat':
                for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (sampleRate * 0.01));
                break;
            case 'kick':
                for (let i = 0; i < data.length; i++) {
                    const t = i / sampleRate;
                    data[i] = Math.sin(2 * Math.PI * 100 * t) * Math.exp(-t * 10) * 2;
                }
                break;
            case 'snare':
                for (let i = 0; i < data.length; i++) {
                    const t = i / sampleRate;
                    data[i] = ((Math.random() * 2 - 1) + Math.sin(2 * Math.PI * 200 * t)) * Math.exp(-t * 10) * 2;
                }
                break;
            case 'woodblock':
                for (let i = 0; i < data.length; i++) {
                    const t = i / sampleRate;
                    data[i] = Math.sin(2 * Math.PI * 800 * t) * Math.exp(-t * 20);
                }
                break;
        }
        return buffer;
    },

    loadPianoSamples: async function() {
        updateLoadingStatus("Loading piano samples...");
        const baseUrl = './tonal/piano/';
        const allSampleFiles = [
            'a2.wav', 'a3.wav', 'a4.wav', 'a5.wav',
            'as2.wav', 'as3.wav', 'as4.wav', 'as5.wav',
            'b2.wav', 'b3.wav', 'b4.wav', 'b5.wav',
            'c2.wav', 'c3.wav', 'c4.wav', 'c5.wav',
            'cs2.wav', 'cs3.wav', 'cs4.wav', 'cs5.wav',
            'd2.wav', 'd3.wav', 'd4.wav', 'd5.wav',
            'ds2.wav', 'ds3.wav', 'ds4.wav', 'ds5.wav',
            'e2.wav', 'e3.wav', 'e4.wav', 'e5.wav',
            'f2.wav', 'f3.wav', 'f4.wav', 'f5.wav',
            'fs2.wav', 'fs3.wav', 'fs4.wav', 'fs5.wav',
            'g2.wav', 'g3.wav', 'g4.wav', 'g5.wav',
            'gs2.wav', 'gs3.wav', 'gs4.wav', 'gs5.wav'
        ];
        for (const file of allSampleFiles) {
            try {
                const response = await fetch(`${baseUrl}${file}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const arrayBuffer = await response.arrayBuffer();
                this.pianoSampleBuffers[file] = await this.context.decodeAudioData(arrayBuffer);
                log(`Loaded piano sample: ${file}`);
            } catch (error) {
                console.error(`Failed to load piano sample ${file}:`, error);
            }
        }
        this.samplesLoaded = true;
        updateLoadingStatus("Piano samples loaded");
    },

    setupReverb: async function() {
        try {
            const response = await fetch('./tonal/impulse_response.wav');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const arrayBuffer = await response.arrayBuffer();
            const reverbBuffer = await this.context.decodeAudioData(arrayBuffer);
            this.reverbNode = this.context.createConvolver();
            this.reverbNode.buffer = reverbBuffer;
            this.reverbNode.connect(this.context.destination);
            log("Reverb setup complete");
        } catch (error) {
            console.error('Failed to setup reverb:', error);
        }
    }
};

// Rest of the script remains unchanged from the previous response
// (e.g., Chord Playing Logic, Fretboard Functions, State Management, etc.)// Helper function to transpose a note
function transposeNote(note, semitones) {
    const noteIndex = NOTES.indexOf(standardizeNoteName(note));
    if (noteIndex === -1) return note;
    const newIndex = (noteIndex + semitones + 12) % 12;
    return NOTES[newIndex];
}

// Helper function to transpose a chord
function transposeChord(chord, semitones) {
    return {
        root: transposeNote(chord.root, semitones),
        quality: chord.quality
    };
}

// Updated parseChord function
function parseChord(chordStr) {
    if (typeof chordStr !== 'string') return null;
    
    const chordRegex = /^([A-G][b#]?)(.*)$/;
    const match = chordStr.match(chordRegex);
    if (!match) return null;

    const root = standardizeNoteName(match[1]);
    let quality = match[2].toLowerCase();

    const qualityMap = {
        '': 'major',
        'm': 'minor',
        'min': 'minor',
        'maj7': 'maj7',
        'm7': 'min7',
        '7': '7',
        '6': '6',
        'm6': 'min6',
        'min6': 'min6',
        'm7b5': 'min7b5',
        'ø7': 'min7b5',
        'dim': 'dim',
        'dim7': 'dim7',
        'aug': 'aug',
        '+': 'aug',
        '7b9': '7b9',
        '7#9': '7#9',
        '7b13': '7b13',
        '7#11': '7#11'
    };

    quality = qualityMap[quality] || 'major';
    return { root, quality };
}

// Updated getChordFromFunction
function getChordFromFunction(chordFunction, key) {
    if (!chordFunction || !key) return null;

    const keyIsMinor = key.endsWith('m');
    const keyRoot = keyIsMinor ? key.slice(0, -1) : key;
    const keyIndex = NOTES.indexOf(standardizeNoteName(keyRoot));
    if (keyIndex === -1) return null;

    const chordRegex = /^([ivIV]+|[b#]?[IViv]+)?(\d)?(.*)$/;
    const match = chordFunction.match(chordRegex);
    if (!match) return null;

    let degree = match[1] || 'I';
    const octave = match[2] || '';
    let quality = match[3] || '';

    const isMinor = /^[iv]+$/.test(degree);
    degree = degree.toUpperCase().replace(/[iv]+/, degree => {
        return { 'i': 'I', 'ii': 'II', 'iii': 'III', 'iv': 'IV', 'v': 'V', 'vi': 'VI', 'vii': 'VII' }[degree.toLowerCase()] || degree;
    });

    const degreeMap = {
        'I': 0,
        'II': 2,
        'III': 3,
        'IV': 5,
        'V': 7,
        'VI': 8,
        'VII': 10,
        'bII': 1,
        'bIII': 3,
        'bV': 6,
        'bVI': 8,
        'bVII': 10
    };

    const degreeValue = degreeMap[degree];
    if (degreeValue === undefined) return null;

    const scale = keyIsMinor ? SCALES.minor : SCALES.major;
    const noteIndex = (keyIndex + scale[degreeValue % scale.length]) % 12;
    let rootNote = NOTES[noteIndex];

    const qualityMap = {
        '': isMinor ? 'minor' : 'major',
        '7': '7',
        'maj7': 'maj7',
        'm7': 'min7',
        'min7': 'min7',
        '6': '6',
        'm6': 'min6',
        'min6': 'min6',
        'm7b5': 'min7b5',
        'dim': 'dim',
        'dim7': 'dim7',
        'aug': 'aug',
        '7b9': '7b9'
    };

    quality = qualityMap[quality.toLowerCase()] || (isMinor ? 'minor' : 'major');

    return { root: rootNote, quality };
}

// Updated suggestScaleForQuality
function suggestScaleForQuality(quality) {
    const scaleSuggestions = {
        'major': 'major',
        'minor': 'minor',
        'maj7': 'major',
        'min7': 'dorian',
        '7': 'mixolydian',
        '6': 'major',
        'min6': 'melodicMinor',
        'min7b5': 'locrian',
        'dim': 'diminishedWH',
        'dim7': 'diminishedWH',
        'aug': 'wholeTone',
        '7b9': 'altered'
    };
    return scaleSuggestions[quality] || 'major';
}

// Updated createKeyOptions
function createKeyOptions(selectedNote) {
    return NOTES.map(note => 
        `<option value="${note}" ${note === selectedNote ? 'selected' : ''}>${note}</option>`
    ).join('');
}

// Updated createQualityOptions
function createQualityOptions(selectedQuality) {
    const qualities = [
        'major', 'minor', 'maj7', 'min7', '7', '6', 'min6', 'min7b5', 
        'dim', 'dim7', 'aug', '7b9', '7#9', '7b13', '7#11'
    ];
    return qualities.map(quality => 
        `<option value="${quality}" ${quality === selectedQuality ? 'selected' : ''}>
            ${quality.replace('min', 'm').replace('maj', 'Maj')}
        </option>`
    ).join('');
}

// Updated createScaleOptions
function createScaleOptions(selectedScale) {
    return Object.keys(SCALES).map(scale => 
        `<option value="${scale}" ${scale === selectedScale ? 'selected' : ''}>
            ${scale.replace(/([A-Z])/g, ' $1').trim()}
        </option>`
    ).join('');
}

// Chord Playing Logic
async function playNote(string, fret, volume = 1.0, duration = 500) {
    try {
        await AudioContextManager.ensureAudioContext();
        const frequency = FRETBOARD_FREQUENCIES[string][fret];
        const note = Object.keys(PIANO_NOTES).find(key => Math.abs(PIANO_NOTES[key] - frequency) < 1);
        if (!note) {
            console.error(`No piano note found for frequency: ${frequency}`);
            return;
        }
        const sampleNote = SAMPLE_NOTE_MAP[note.slice(0, -1)];
        const octave = parseInt(note.slice(-1));
        const sampleFile = getSampleFileName(sampleNote, octave);
        const buffer = AudioContextManager.pianoSampleBuffers[sampleFile];
        if (!buffer) {
            console.error(`No buffer found for sample: ${sampleFile}`);
            return;
        }
        const source = AudioContextManager.context.createBufferSource();
        source.buffer = buffer;
        const gainNode = AudioContextManager.context.createGain();
        gainNode.gain.value = volume * parseFloat(UI.elements.chordFretboardVolume.value);
        source.connect(gainNode);
        gainNode.connect(AudioContextManager.context.destination);
        if (AudioContextManager.reverbNode) {
            const reverbGain = AudioContextManager.context.createGain();
            reverbGain.gain.value = 0.2;
            source.connect(reverbGain);
            reverbGain.connect(AudioContextManager.reverbNode);
        }
        source.start();
        source.stop(AudioContextManager.context.currentTime + duration / 1000);
    } catch (error) {
        console.error('Error playing note:', error);
    }
}

async function playChord(root, quality, startTime = 0, duration = 2, passing = false) {
    if (!UI.elements.chordsEnabled.classList.contains('active')) return;
    try {
        await AudioContextManager.ensureAudioContext();
        if (AudioContextManager.currentChordGain) {
            AudioContextManager.currentChordGain.gain.setValueAtTime(AudioContextManager.currentChordGain.gain.value, AudioContextManager.context.currentTime);
            AudioContextManager.currentChordGain.gain.exponentialRampToValueAtTime(0.001, AudioContextManager.context.currentTime + 0.05);
        }
        const chordNotes = getChordNotes(root, quality);
        const gainNode = AudioContextManager.context.createGain();
        gainNode.gain.value = parseFloat(UI.elements.chordVolume.value) * (passing ? 0.7 : 1);
        AudioContextManager.currentChordGain = gainNode;
        chordNotes.forEach(note => {
            const sampleNote = SAMPLE_NOTE_MAP[note.slice(0, -1)];
            const octave = parseInt(note.slice(-1));
            const sampleFile = getSampleFileName(sampleNote, octave);
            const buffer = AudioContextManager.pianoSampleBuffers[sampleFile];
            if (buffer) {
                const source = AudioContextManager.context.createBufferSource();
                source.buffer = buffer;
                source.connect(gainNode);
                gainNode.connect(AudioContextManager.context.destination);
                source.start(startTime);
                source.stop(startTime + duration);
            }
        });
    } catch (error) {
        console.error('Error playing chord:', error);
    }
}

function getChordNotes(root, quality) {
    const rootIndex = NOTES.indexOf(standardizeNoteName(root));
    if (rootIndex === -1) return [];
    const chordIntervals = {
        'major': [0, 4, 7],
        'minor': [0, 3, 7],
        'maj7': [0, 4, 7, 11],
        'min7': [0, 3, 7, 10],
        '7': [0, 4, 7, 10],
        '6': [0, 4, 7, 9],
        'min6': [0, 3, 7, 9],
        'min7b5': [0, 3, 6, 10],
        'dim': [0, 3, 6],
        'dim7': [0, 3, 6, 9],
        'aug': [0, 4, 8],
        '7b9': [0, 4, 7, 10, 13],
        '7#9': [0, 4, 7, 10, 15],
        '7b13': [0, 4, 7, 10, 20],
        '7#11': [0, 4, 7, 10, 18]
    };
    const intervals = chordIntervals[quality] || chordIntervals['major'];
    return intervals.map(interval => {
        const noteIndex = (rootIndex + interval) % 12;
        const octave = Math.floor((rootIndex + interval) / 12) + 3;
        return `${NOTES[noteIndex]}${octave}`;
    });
}

async function playMetronomeSound(volume) {
    const currentBeatElement = document.querySelector(`.beat[data-beat="${AppState.currentBeat}"]`);
    if (!currentBeatElement || currentBeatElement.dataset.sound === 'silent') return;
    const sounds = currentBeatElement.dataset.sound.split(',');
    const isAccent = volume >= 1 && ['kick', 'snare'].includes(sounds[0]);
    const accentBoost = parseFloat(UI.elements.accentIntensity?.value || 1);
    const finalVolume = isAccent ? Math.min(volume * accentBoost, 1) : volume;
    for (const sound of sounds) {
        if (sound !== 'silent') {
            await playDrumSound(sound, finalVolume);
        }
    }
}

async function playDrumSound(type, volume) {
    await AudioContextManager.ensureAudioContext();
    const set = drumSoundSets[currentDrumSetIndex];
    let sampleFile;
    switch(type) {
        case 'snare': sampleFile = set.snare; break;
        case 'hihat': sampleFile = set.hihat; break;
        case 'kick': sampleFile = set.kick; break;
        default: sampleFile = null;
    }
    try {
        let buffer;
        const response = await fetch(`./${sampleFile}`);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const arrayBuffer = await response.arrayBuffer();
        buffer = await AudioContextManager.context.decodeAudioData(arrayBuffer);
        const source = AudioContextManager.context.createBufferSource();
        source.buffer = buffer;
        const gainNode = AudioContextManager.context.createGain();
        const metronomeVolume = parseFloat(UI.elements.metronomeVolume.value);
        let finalVolume = metronomeVolume * volume;
        if (type === 'kick') {
            finalVolume *= 1.2;
        } else if (type === 'snare') {
            finalVolume *= 1.1;
        } else if (type === 'hihat') {
            finalVolume *= 0.8;
        }
        finalVolume = Math.min(finalVolume, 1.0);
        gainNode.gain.value = finalVolume;
        source.connect(gainNode);
        gainNode.connect(AudioContextManager.context.destination);
        if (AudioContextManager.reverbNode) {
            const reverbGain = AudioContextManager.context.createGain();
            reverbGain.gain.value = 0.1;
            source.connect(reverbGain);
            reverbGain.connect(AudioContextManager.reverbNode);
        }
        source.start(0);
    } catch (error) {
        console.error(`Failed to play drum sample: ${type}`, error);
        try {
            const fallbackBuffer = AudioContextManager.soundBuffers[type] || 
                await AudioContextManager.createDrumSound(type);
            const source = AudioContextManager.context.createBufferSource();
            source.buffer = fallbackBuffer;
            const gainNode = AudioContextManager.context.createGain();
            gainNode.gain.value = parseFloat(UI.elements.metronomeVolume.value) * volume;
            source.connect(gainNode);
            gainNode.connect(AudioContextManager.context.destination);
            source.start(0);
        } catch (fallbackError) {
            console.error('Failed to play fallback sound:', fallbackError);
        }
    }
}

function createFretboard(container, tuning) {
    container.innerHTML = '';
    for (let i = 0; i <= 12; i++) {
        const fretLine = document.createElement('div');
        fretLine.className = 'fret-line';
        fretLine.style.left = `${(i / 12) * 100}%`;
        container.appendChild(fretLine);
        if (i > 0) {
            const fretNumber = document.createElement('div');
            fretNumber.className = 'fret-number';
            fretNumber.textContent = i;
            fretNumber.style.left = `${((i - 0.5) / 12) * 100}%`;
            container.appendChild(fretNumber);
        }
    }
    for (let i = 0; i < 6; i++) {
        const stringLine = document.createElement('div');
        stringLine.className = 'string-line';
        stringLine.style.top = `${(i / 5) * 100}%`;
        container.appendChild(stringLine);
    }
    const markerPositions = [3, 5, 7, 9, 12];
    markerPositions.forEach(position => {
        const marker = document.createElement('div');
        marker.className = 'fret-marker';
        marker.style.left = `${((position - 0.5) / 12) * 100}%`;
        if (position === 12) {
            const topMarker = marker.cloneNode(true);
            topMarker.style.top = '25%';
            container.appendChild(topMarker);
            const bottomMarker = marker.cloneNode(true);
            bottomMarker.style.top = '75%';
            container.appendChild(bottomMarker);
        } else {
            marker.style.top = '50%';
            container.appendChild(marker);
        }
    });
}

function updateFretboardNotes(container, rootNote, scale, tuning) {
    if (!(container instanceof HTMLElement)) {
        console.error('Invalid container element');
        return;
    }
    if (!NOTES.includes(standardizeNoteName(rootNote))) {
        console.error(`Invalid root note: ${rootNote}`);
        return;
    }
    if (!SCALES[scale]) {
        console.error(`Invalid scale: ${scale}`);
        return;
    }
    if (!Array.isArray(tuning) || tuning.length !== 6) {
        console.error('Invalid tuning');
        return;
    }
    container.querySelectorAll('.note').forEach(note => note.remove());
    if (container.id === 'chord-fretboard') {
        const measures = UI.elements.measures.children;
        if (measures.length > 0 && AppState.currentMeasure < measures.length) {
            const currentMeasureElement = measures[AppState.currentMeasure];
            const chordRoot = currentMeasureElement.querySelector('.chord-controls .root-note')?.value;
            const chordQuality = currentMeasureElement.querySelector('.chord-controls .chord-quality')?.value;
            const scaleRoot = currentMeasureElement.querySelector('.scale-controls .second-key')?.value;
            const scaleType = currentMeasureElement.querySelector('.scale-controls .scale-select')?.value;
            if (chordRoot && chordQuality && scaleRoot && scaleType) {
                let displayQuality = chordQuality;
                switch (chordQuality) {
                    case 'dom7': displayQuality = '7'; break;
                    case 'maj7': displayQuality = 'Maj7'; break;
                    case 'min7': displayQuality = 'm7'; break;
                    case 'min7b5': displayQuality = 'm7b5'; break;
                    case 'minor': displayQuality = 'm'; break;
                }
                let displayScale = scaleType.charAt(0).toUpperCase() + scaleType.slice(1);
                displayScale = displayScale.replace(/([A-Z])/g, ' $1').trim();
                UI.elements.scaleDisplay.textContent = `${scaleRoot} ${displayScale} over ${chordRoot} ${displayQuality}`;
            }
        }
    }
    const scaleIntervals = SCALES[scale];
    const standardizedRoot = standardizeNoteName(rootNote);
    const rootIndex = NOTES.indexOf(standardizedRoot);
    const scaleNotes = scaleIntervals.map(interval => {
        const noteIndex = (rootIndex + interval) % 12;
        return NOTES[noteIndex];
    });
    console.log(`[updateFretboardNotes] scaleNotes for ${rootNote} ${scale}: ${scaleNotes.join(',')}`);
    for (let string = 0; string < 6; string++) {
        const openNote = tuning[string];
        const openNoteIndex = NOTES.indexOf(openNote);
        for (let fret = 0; fret <= 12; fret++) {
            const noteIndex = (openNoteIndex + fret) % 12;
            const currentNote = NOTES[noteIndex];
            if (scaleNotes.includes(currentNote)) {
                const noteElement = document.createElement('div');
                noteElement.className = 'note';
                noteElement.textContent = currentNote;
                const fretOffset = fret === 0 ? 0 : ((fret - 0.5) / 12) * 100;
                noteElement.style.left = `${fretOffset}%`;
                noteElement.style.top = `${(string / 5) * 100}%`;
                const degree = scaleNotes.indexOf(currentNote);
                if (currentNote === standardizedRoot) {
                    noteElement.style.backgroundColor = '#BD2031';
                } else if ([2, 4, 6].includes(degree)) {
                    noteElement.style.backgroundColor = '#006400';
                } else {
                    noteElement.style.backgroundColor = '#4CAF50';
                }
                noteElement.addEventListener('click', async () => {
                    try {
                        await AudioContextManager.ensureAudioContext();
                        let volume = parseFloat(currentBeatElement.dataset.baseVolume) || 0;
                        const isAccent = volume >= 1 && ['kick', 'snare'].includes(currentBeatElement.dataset.sound);
                        const accentBoost = parseFloat(UI.elements.accentIntensity?.value || 1);
                        if (isAccent) {
                            volume = Math.min(volume * accentBoost, 1);
                        }
                        await playNote(`string${6 - string}`, fret, volume);
                        noteElement.style.transform = 'translate(-50%, -50%) scale(1.2)';
                        setTimeout(() => {
                            noteElement.style.transform = 'translate(-50%, -50%) scale(1)';
                        }, 100);
                    } catch (error) {
                        console.error('Error playing note:', error);
                    }
                });
                noteElement.addEventListener('mouseenter', () => {
                    noteElement.style.transform = 'translate(-50%, -50%) scale(1.1)';
                });
                noteElement.addEventListener('mouseleave', () => {
                    noteElement.style.transform = 'translate(-50%, -50%) scale(1)';
                });
                container.appendChild(noteElement);
            }
        }
    }
    log(`Fretboard updated with ${rootNote} ${scale} scale`);
}

function createBeats() {
    const container = document.querySelector('.beats-container');
    container.innerHTML = '';
    const timeSignature = parseInt(UI.elements.timeSignature.value);
    const soundType = UI.elements.soundType.value;
    let totalBeats = timeSignature === 4 ? 8 : timeSignature;
    const beatConfigs = {
        4: { 
            strongBeats: [0, 4], 
            drumSounds: { 
                0: { sound: ['kick', 'hihat'], volume: '1', color: '#1F618D' },
                2: { sound: ['snare', 'hihat'], volume: '1', color: '#4CAF50' },
                4: { sound: ['kick', 'hihat'], volume: '1', color: '#1F618D' },
                6: { sound: ['snare', 'hihat'], volume: '1', color: '#4CAF50' }
            }
        },
        3: { strongBeats: [0, 3, 6] },
        6: { strongBeats: [0, 3] },
        7: { strongBeats: [0, 4] },
        8: { strongBeats: [0, 4] },
        12: {
            strongBeats: [0, 4, 6, 10],
            drumSounds: { 0: 'kick', 4: 'snare', 6: 'kick', 10: 'snare' }
        }
    };
    const config = beatConfigs[timeSignature] || { strongBeats: [0] };
    for (let i = 0; i < totalBeats; i++) {
        const beat = document.createElement('div');
        beat.className = 'beat';
        beat.dataset.beat = i;
        if (timeSignature === 4) {
            const isQuarterNote = i % 2 === 0;
            beat.textContent = `${Math.floor(i / 2 + 1)}${isQuarterNote ? '' : '&'}`;
            if (soundType === 'drums') {
                let volume = '0.7';
                let sound = 'hihat';
                let color = '#9E9E9E';
                const drumConfig = config.drumSounds[i];
                if (drumConfig) {
                    sound = drumConfig.sound;
                    volume = drumConfig.volume;
                    color = drumConfig.color;
                }
                beat.dataset.baseVolume = volume;
                beat.dataset.volume = volume;
                beat.dataset.sound = Array.isArray(sound) ? sound.join(',') : sound;
                beat.style.backgroundColor = color;
            } else {
                if (isQuarterNote) {
                    beat.dataset.sound = soundType;
                    beat.dataset.baseVolume = i === 0 ? '1' : '0.3';
                    beat.dataset.volume = i === 0 ? '1' : '0.3';
                    beat.style.backgroundColor = i === 0 ? '#1F618D' : '#4CAF50';
                } else {
                    beat.dataset.sound = 'silent';
                    beat.dataset.baseVolume = '0';
                    beat.dataset.volume = '0';
                    beat.style.backgroundColor = '#9E9E9E';
                }
            }
        } else {
            beat.textContent = i + 1;
            const isStrong = config.strongBeats.includes(i);
            if (soundType === 'drums') {
                beat.dataset.sound = isStrong ? 'kick' : 'hihat';
                beat.dataset.baseVolume = '1';
                beat.dataset.volume = '1';
                beat.style.backgroundColor = isStrong ? '#1F618D' : '#9E9E9E';
            } else {
                beat.dataset.sound = soundType;
                beat.dataset.baseVolume = isStrong ? '1' : '0.3';
                beat.dataset.volume = isStrong ? '1' : '0.3';
                beat.style.backgroundColor = isStrong ? '#1F618D' : '#4CAF50';
            }
        }
        beat.addEventListener('click', () => toggleBeatState(beat, timeSignature, soundType));
        container.appendChild(beat);
    }
}

         
            function toggleBeatState(beat, timeSignature, soundType) {
                const isEighth = timeSignature === 4 && parseInt(beat.dataset.beat) % 2 === 1;
                const states = soundType === 'drums' && timeSignature === 4 ? (
                    isEighth ? [
                        { volume: '1', sound: 'hihat', color: '#9E9E9E' },
                        { volume: '1', sound: 'kick', color: '#1F618D' },
                        { volume: '1', sound: 'snare', color: '#4CAF50' },
                        { volume: '0', sound: 'silent', color: '#9E9E9E' }
                    ] : [
                        { volume: '1', sound: ['kick', 'hihat'], color: '#1F618D' },
                        { volume: '1', sound: ['snare', 'hihat'], color: '#4CAF50' },
                        { volume: '1', sound: ['hihat'], color: '#9E9E9E' },
                        { volume: '0', sound: 'silent', color: '#9E9E9E' }
                    ]
                ) : [
                    { volume: '1', sound: soundType, color: '#1F618D' },
                    { volume: '0.3', sound: soundType, color: '#4CAF50' },
                    { volume: '0', sound: 'silent', color: '#9E9E9E' }
                ];
                let currentIndex = states.findIndex(state => 
                    state.volume === beat.dataset.volume && 
                    (Array.isArray(state.sound) ? 
                        state.sound.join(',') === beat.dataset.sound : 
                        state.sound === beat.dataset.sound)
                );
                currentIndex = (currentIndex + 1) % states.length;
                const nextState = states[currentIndex];
                beat.dataset.volume = nextState.volume;
                beat.dataset.sound = Array.isArray(nextState.sound) ? nextState.sound.join(',') : nextState.sound;
                beat.style.backgroundColor = nextState.color;
                if (nextState.volume === '0') {
                    beat.classList.add('silent');
                } else {
                    beat.classList.remove('silent');
                }
            }
            
            async function playBeat() {
                const timeSignature = parseInt(UI.elements.timeSignature.value);
                const totalBeats = timeSignature === 4 ? 8 : timeSignature;
                const measures = UI.elements.measures.children;
                const currentMeasureElement = measures[AppState.currentMeasure];
                const beatsContainer = document.querySelector('.beats-container');
                const previousBeatElement = beatsContainer.querySelector('.beat.active');
                if (previousBeatElement) {
                    previousBeatElement.classList.remove('active');
                }
                const currentBeatElement = beatsContainer.querySelector(`.beat[data-beat="${AppState.currentBeat}"]`);
                if (currentBeatElement) {
                    currentBeatElement.classList.add('active');
                    const volume = parseFloat(currentBeatElement.dataset.volume) || 0;
                    await playMetronomeSound(volume);
                }
                if (AppState.currentBeat === 0 && currentMeasureElement) {
                    const chordRoot = currentMeasureElement.querySelector('.chord-controls .root-note')?.value;
                    const chordQuality = currentMeasureElement.querySelector('.chord-controls .chord-quality')?.value;
                    const scaleRoot = currentMeasureElement.querySelector('.scale-controls .second-key')?.value;
                    const scaleType = currentMeasureElement.querySelector('.scale-controls .scale-select')?.value;
                    if (chordRoot && chordQuality && scaleRoot && scaleType) {
                        const now = AudioContextManager.context?.currentTime || 0;
                        const beatDuration = (60 / AppState.tempo) * (timeSignature === 4 ? 2 : 1);
                        await playChord(chordRoot, chordQuality, now, beatDuration);
                        const tuning = TUNINGS[UI.elements.chordTuning.value];
                        updateFretboardNotes(UI.elements.chordFretboard, scaleRoot, scaleType, tuning);
                    }
                }
                AppState.currentBeat = (AppState.currentBeat + 1) % totalBeats;
                if (AppState.currentBeat === 0) {
                    AppState.currentMeasure = (AppState.currentMeasure + 1) % measures.length;
                }
            }
            
            function addMeasureWithChord(chord = { root: 'C', quality: 'major' }, index = null) {
                const measure = document.createElement('div');
                measure.className = 'measure';
                if (index !== null) {
                    measure.dataset.index = index;
                }
                const chordControls = document.createElement('div');
                chordControls.className = 'chord-controls';
                const rootSelect = document.createElement('select');
                rootSelect.className = 'root-note';
                rootSelect.innerHTML = createKeyOptions(chord.root);
                const qualitySelect = document.createElement('select');
                qualitySelect.className = 'chord-quality';
                qualitySelect.innerHTML = createQualityOptions(chord.quality);
                chordControls.appendChild(rootSelect);
                chordControls.appendChild(qualitySelect);
                const scaleControls = document.createElement('div');
                scaleControls.className = 'scale-controls';
                const secondKeySelect = document.createElement('select');
                secondKeySelect.className = 'second-key';
                secondKeySelect.innerHTML = createKeyOptions(chord.root);
                const scaleSelect = document.createElement('select');
                scaleSelect.className = 'scale-select';
                scaleSelect.innerHTML = createScaleOptions(suggestScaleForQuality(chord.quality));
                scaleControls.appendChild(secondKeySelect);
                scaleControls.appendChild(scaleSelect);
                measure.appendChild(chordControls);
                measure.appendChild(scaleControls);
                const removeButton = document.createElement('button');
                removeButton.className = 'remove-measure';
                removeButton.textContent = 'Remove';
                removeButton.addEventListener('click', () => {
                    measure.remove();
                    updateDisplay();
                });
                measure.appendChild(removeButton);
                const updateHandler = async () => {
                    const newRoot = rootSelect.value;
                    const newQuality = qualitySelect.value;
                    const newScaleRoot = secondKeySelect.value;
                    const newScale = scaleSelect.value;
                    secondKeySelect.innerHTML = createKeyOptions(newRoot);
                    secondKeySelect.value = newScaleRoot || newRoot;
                    scaleSelect.innerHTML = createScaleOptions(newScale);
                    scaleSelect.value = newScale || suggestScaleForQuality(newQuality);
                    const tuning = TUNINGS[UI.elements.chordTuning.value];
                    updateFretboardNotes(UI.elements.chordFretboard, newScaleRoot, newScale, tuning);
                    let displayQuality = newQuality;
                    switch (newQuality) {
                        case 'dom7': displayQuality = '7'; break;
                        case 'maj7': displayQuality = 'Maj7'; break;
                        case 'min7': displayQuality = 'm7'; break;
                        case 'min7b5': displayQuality = 'm7b5'; break;
                        case 'minor': displayQuality = 'm'; break;
                    }
                    let displayScale = newScale.charAt(0).toUpperCase() + newScale.slice(1);
                    displayScale = displayScale.replace(/([A-Z])/g, ' $1').trim();
                    UI.elements.scaleDisplay.textContent = `${newScaleRoot} ${displayScale} over ${newRoot} ${displayQuality}`;
                    if (UI.elements.chordsEnabled.classList.contains('active')) {
                        const now = AudioContextManager.context?.currentTime || 0;
                        await playChord(newRoot, newQuality, now, 2);
                    }
                };
                rootSelect.addEventListener('change', updateHandler);
                qualitySelect.addEventListener('change', updateHandler);
                secondKeySelect.addEventListener('change', updateHandler);
                scaleSelect.addEventListener('change', updateHandler);
                UI.elements.measures.appendChild(measure);
            }
            
            function updateDisplay() {
                const measures = UI.elements.measures.children;
                if (measures.length === 0) {
                    UI.elements.scaleDisplay.textContent = 'No chords selected';
                    const tuning = TUNINGS[UI.elements.chordTuning.value];
                    updateFretboardNotes(UI.elements.chordFretboard, 'C', 'major', tuning);
                    return;
                }
                const currentMeasureElement = measures[AppState.currentMeasure] || measures[0];
                const chordRoot = currentMeasureElement.querySelector('.chord-controls .root-note')?.value;
                const chordQuality = currentMeasureElement.querySelector('.chord-controls .chord-quality')?.value;
                const scaleRoot = currentMeasureElement.querySelector('.scale-controls .second-key')?.value;
                const scaleType = currentMeasureElement.querySelector('.scale-controls .scale-select')?.value;
                if (chordRoot && chordQuality && scaleRoot && scaleType) {
                    const tuning = TUNINGS[UI.elements.chordTuning.value];
                    updateFretboardNotes(UI.elements.chordFretboard, scaleRoot, scaleType, tuning);
                    let displayQuality = chordQuality;
                    switch (chordQuality) {
                        case 'dom7': displayQuality = '7'; break;
                        case 'maj7': displayQuality = 'Maj7'; break;
                        case 'min7': displayQuality = 'm7'; break;
                        case 'min7b5': displayQuality = 'm7b5'; break;
                        case 'minor': displayQuality = 'm'; break;
                    }
                    let displayScale = scaleType.charAt(0).toUpperCase() + scaleType.slice(1);
                    displayScale = displayScale.replace(/([A-Z])/g, ' $1').trim();
                    UI.elements.scaleDisplay.textContent = `${scaleRoot} ${displayScale} over ${chordRoot} ${displayQuality}`;
                }
            }
            
            function createProgressionOptions() {
                const select = UI.elements.progressionSelect;
                select.innerHTML = '<option value="">Select Progression</option>';
                Object.keys(progressions).forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                    select.appendChild(option);
                });
            }
            
            // Updated loadProgression
            function loadProgression(progressionName, overrideKey = null) {
                if (!progressionName || !progressions[progressionName]) {
                    console.error(`Invalid progression name: ${progressionName}`);
                    return;
                }
            
                const progression = progressions[progressionName];
                const defaultKey = progression.defaultKey;
                const selectedKey = overrideKey || defaultKey;
            
                // Calculate transposition semitones
                const defaultKeyIndex = NOTES.indexOf(standardizeNoteName(defaultKey.replace('m', '')));
                const selectedKeyIndex = NOTES.indexOf(standardizeNoteName(selectedKey.replace('m', '')));
                const semitones = (selectedKeyIndex - defaultKeyIndex + 12) % 12;
            
                // Update key select
                UI.elements.keySelect.value = selectedKey;
            
                // Clear existing measures
                UI.elements.measures.innerHTML = '';
            
                // Add measures with transposed chords
                progression.chords.forEach((chord, index) => {
                    const transposedChord = transposeChord(chord, semitones);
                    addMeasureWithChord(transposedChord, index);
                });
            
                // Update fretboard
                updateDisplay();
                log(`Loaded progression ${progressionName} in key ${selectedKey}`);
            }
            
            // Updated updateProgressionKey
            function updateProgressionKey(newKey) {
                const selectedProgression = UI.elements.progressionSelect.value;
                if (!selectedProgression || !progressions[selectedProgression]) return;
            
                const progression = progressions[selectedProgression];
                const defaultKey = progression.defaultKey;
            
                // Calculate transposition semitones
                const defaultKeyIndex = NOTES.indexOf(standardizeNoteName(defaultKey.replace('m', '')));
                const newKeyIndex = NOTES.indexOf(standardizeNoteName(newKey.replace('m', '')));
                const semitones = (newKeyIndex - defaultKeyIndex + 12) % 12;
            
                // Update measures
                Array.from(UI.elements.measures.children).forEach((measure, index) => {
                    const originalChord = progression.chords[index];
                    if (!originalChord) return;
            
                    const transposedChord = transposeChord(originalChord, semitones);
                    const rootSelect = measure.querySelector('.root-note');
                    const qualitySelect = measure.querySelector('.chord-quality');
                    const secondKeySelect = measure.querySelector('.second-key');
                    const scaleSelect = measure.querySelector('.scale-select');
            
                    if (rootSelect) rootSelect.value = transposedChord.root;
                    if (qualitySelect) qualitySelect.value = transposedChord.quality;
                    if (secondKeySelect) secondKeySelect.value = transposedChord.root;
                    if (scaleSelect) scaleSelect.value = suggestScaleForQuality(transposedChord.quality);
                });
            
                // Update fretboard
                const firstMeasure = UI.elements.measures.firstElementChild;
                if (firstMeasure) {
                    const scaleRoot = firstMeasure.querySelector('.second-key').value;
                    const scaleType = firstMeasure.querySelector('.scale-select').value;
                    const tuning = TUNINGS[UI.elements.chordTuning.value];
                    updateFretboardNotes(UI.elements.chordFretboard, scaleRoot, scaleType, tuning);
                }
            
                log(`Progression transposed to key: ${newKey}`);
            }
            
            async function initializeFretFlow() {
                UI.init();
                updateLoadingStatus("Initializing FretFlow...");
                await AudioContextManager.initialize();
                createFretboard(UI.elements.chordFretboard, TUNINGS.standard);
                createBeats();
                createProgressionOptions();
                const keySelect = UI.elements.keySelect;
                keySelect.innerHTML = NOTES.map(note => `<option value="${note}">${note}</option>`).join('');
                keySelect.value = 'C';
                UI.elements.tempoDisplay.textContent = `${AppState.tempo} BPM`;
                initializeScaleSelects();
                UI.elements.startStopButton.addEventListener('click', async () => {
                    await AudioContextManager.ensureAudioContext();
                    AppState.updateState({ isPlaying: !AppState.isPlaying });
                    UI.elements.startStopButton.textContent = AppState.isPlaying ? 'Stop' : 'Start';
                    if (AppState.isPlaying) {
                        const interval = (60 / AppState.tempo) * 1000 / (parseInt(UI.elements.timeSignature.value) === 4 ? 2 : 1);
                        const tick = async () => {
                            if (!AppState.isPlaying) return;
                            await playBeat();
                            setTimeout(tick, interval);
                        };
                        tick();
                    }
                });
                UI.elements.progressionSelect.addEventListener('change', (e) => {
                    const progressionName = e.target.value;
                    if (progressionName) {
                        loadProgression(progressionName);
                    }
                });
                UI.elements.keySelect.addEventListener('change', (e) => {
                    updateProgressionKey(e.target.value);
                });
                UI.elements.chordTuning.addEventListener('change', () => {
                    const tuning = TUNINGS[UI.elements.chordTuning.value];
                    createFretboard(UI.elements.chordFretboard, tuning);
                    updateDisplay();
                });
                UI.elements.timeSignature.addEventListener('change', () => {
                    createBeats();
                });
                UI.elements.soundType.addEventListener('change', () => {
                    createBeats();
                });
                UI.elements.tempo.addEventListener('input', (e) => {
                    AppState.tempo = parseInt(e.target.value);
                    UI.elements.tempoDisplay.textContent = `${AppState.tempo} BPM`;
                });
                let tapTimes = [];
                UI.elements.tapTempo.addEventListener('click', () => {
                    const now = Date.now();
                    tapTimes.push(now);
                    if (tapTimes.length > 4) {
                        tapTimes.shift();
                    }
                    if (tapTimes.length >= 2) {
                        const intervals = tapTimes.slice(1).map((t, i) => t - tapTimes[i]);
                        const averageInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                        const newTempo = Math.round(60000 / averageInterval);
                        if (newTempo >= 40 && newTempo <= 240) {
                            AppState.tempo = newTempo;
                            UI.elements.tempo.value = newTempo;
                            UI.elements.tempoDisplay.textContent = `${newTempo} BPM`;
                        }
                    }
                });
                UI.elements.chordsEnabled.addEventListener('click', () => {
                    UI.elements.chordsEnabled.classList.toggle('active');
                    const label = UI.elements.chordsEnabled.querySelector('label');
                    if (label) {
                        label.textContent = UI.elements.chordsEnabled.classList.contains('active') ? 'Chords: On' : 'Chords: Off';
                    }
                });
                const drumSetSelect = document.getElementById('drum-set-select');
                if (drumSetSelect) {
                    drumSetSelect.innerHTML = drumSoundSets.map((set, index) => 
                        `<option value="${index}" ${index === currentDrumSetIndex ? 'selected' : ''}>${set.name}</option>`
                    ).join('');
                    drumSetSelect.addEventListener('change', (e) => {
                        currentDrumSetIndex = parseInt(e.target.value);
                        log(`Drum set changed to: ${drumSoundSets[currentDrumSetIndex].name}`);
                    });
                }
                const addMeasureButton = document.getElementById('add-measure');
                if (addMeasureButton) {
                    addMeasureButton.addEventListener('click', () => {
                        addMeasureWithChord();
                        updateDisplay();
                    });
                }
                UI.elements.darkModeToggle.addEventListener('click', () => {
                    AppState.darkMode = !AppState.darkMode;
                    document.body.classList.toggle('dark-mode', AppState.darkMode);
                    UI.elements.darkModeToggle.textContent = AppState.darkMode ? '☀️' : '🌙';
                    localStorage.setItem('darkMode', AppState.darkMode);
                });
                const savedDarkMode = localStorage.getItem('darkMode');
                if (savedDarkMode === 'true') {
                    AppState.darkMode = true;
                    document.body.classList.add('dark-mode');
                    UI.elements.darkModeToggle.textContent = '☀️';
                }
                AppState.addListener((state) => {
                    log(`State updated: isPlaying=${state.isPlaying}, tempo=${state.tempo}`);
                });
                updateLoadingStatus("FretFlow initialized");
                console.log('[FretFlow] Initialization complete');
            }
            
            document.addEventListener('DOMContentLoaded', initializeFretFlow);            

            </script>
        </body>
        </html>
