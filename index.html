<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bebop Blueprint</title>
    <link rel="icon" type="image/png" href="jazzmaster.png">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
    body {
        font-family: 'Lato', sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: var(--bg-color, #f0f0f0); /* Lighter default background */
        color: var(--text-color, #333);

        /* Light Theme (Default) Guide Tone Colors */
        --guide-tone-bg-color: #007bff;       /* Bright Blue */
        --guide-tone-text-color: white;
        --guide-tone-border-color: #0056b3;    /* Darker Blue */
        --root-highlight-border-color: #c82333; /* Default for root highlight border */

        /* Item 1: Song Title Color */
        --song-title-fretboard-color: #0056b3; /* Darker blue for light mode */

        /* NEW: Subsection styling variables for Light Mode */
        --subsection-bg-color: #e9ecef;
        --subsection-border-color: #ced4da;
        --subsection-title-color: inherit;
    }
    .app-section {
        background: var(--section-bg-color, white);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        color: var(--section-text-color, inherit);
    }

    /* NEW: Subsection styling */
    .app-subsection {
        background-color: var(--subsection-bg-color, #e9ecef);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid var(--subsection-border-color, #ced4da);
    }
    .song-setup-controls h4 { /* Specific for the song setup title */
        margin-top: 0;
        margin-bottom: 10px;
        color: var(--subsection-title-color, var(--text-color));
    }


    .fretboards-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }
    .fretboard-container {
        background: var(--fretboard-container-bg, white);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border: 1px solid var(--fretboard-container-border, transparent);
    }
    /* Song Info Display Styling (Item 1) */
    #song-info-display-fretboard {
        margin-bottom: 10px; /* Space before scale display */
    }
    #song-info-display-fretboard #current-song-title-fretboard {
        text-align: left;
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 1.3em; /* Slightly larger */
        font-weight: bold; /* Bolder */
        color: var(--song-title-fretboard-color); /* Themed color */
    }
    #song-info-display-fretboard p {
        text-align: left;
        margin-top: 0;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: var(--song-info-p-color, #555);
        font-style: italic;
    }

    .scale-display {
        font-size: 1.2em;
        font-weight: bold;
        text-align: center;
        margin-bottom: 5px; /* Reduced margin */
        color: var(--scale-display-color, #333);
        min-height: 1.5em; /* Reserve space */
    }
    /* Next Chord Display Styling */
    .next-chord-display {
        font-size: 0.95em; /* Slightly smaller than scale display */
        font-style: italic;
        text-align: center;
        color: var(--next-chord-color, #6c757d); /* Muted gray color */
        margin-top: -5px; /* Pull it up slightly */
        margin-bottom: 15px; /* Space below before controls */
        height: auto; /* Allow multiple lines */
        min-height: 1.2em; /* Reserve space to prevent layout shift for single line */
        line-height: 1.2em;
    }
    .controls, .top-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    /* MODIFIED: .top-controls for global panel */
    .top-controls {
        justify-content: flex-start; /* Align items to the start */
    }

    .controls-container { display: flex; gap: 20px; margin-bottom: 20px; }
    .control-group { display: flex; align-items: center; gap: 10px; }
    .control-group label { font-weight: bold; }
    .control-group select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }

    .fretboard {
        position: relative;
        height: 200px;
        background-color: var(--fretboard-bg, #FFCF79);
        border-radius: 5px;
        margin-bottom: 30px;
        border: 2px solid var(--fretboard-border, #4A3B31);
        overflow: visible;
    }
    .fret-line { position: absolute; top: 0; height: 100%; width: 2px; background: #A0A0A0; border-right: 1px solid rgba(0,0,0,0.1); z-index: 1; }
    .string-line { position: absolute; left: 0; width: 100%; height: 1px; background: #C0C0C0; border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 0; }
    .fret-number { position: absolute; bottom: -25px; font-size: 14px; color: #555; transform: translateX(-50%); font-weight: bold; z-index: 2; width: 20px; text-align: center; }
    .fret-marker { position: absolute; width: 10px; height: 10px; background-color: #5A4F46; border-radius: 50%; transform: translate(-50%, -50%); z-index: 1; }
    
    .note {
        position: absolute;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        color: var(--note-text-color, white); /* Default note text color */
        z-index: 3;
        cursor: pointer;
        transform: translate(-50%, -50%);
        transition: transform 0.1s ease, box-shadow 0.1s ease, background-color 0.2s ease, color 0.2s ease, outline 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        /* background-color is set by JS for regular notes */
    }

    /* UPDATED GUIDE TONE STYLING (Item 3) */
    .note.guide-tone-highlight, .note.root-highlight-for-guides {
        outline: 3px solid var(--guide-tone-border-color) !important;
        box-shadow: 0 0 8px 2px var(--guide-tone-border-color) !important;
        transform: translate(-50%, -50%) scale(0.95) !important; /* Make them slightly smaller */
        z-index: 10 !important;
        font-weight: bold !important;
        border-radius: 50%;
    }
    .note.guide-tone-highlight {
        background-color: var(--guide-tone-bg-color) !important;
        color: var(--guide-tone-text-color) !important;
    }
    .note.root-highlight-for-guides {
        /* Retains its original background and text color from the scale drawing logic */
        /* Specific border for root if needed, defaults to guide tone border */
         outline-color: var(--root-highlight-border-color) !important;
         box-shadow: 0 0 8px 2px var(--root-highlight-border-color) !important;
    }

    .note:hover {
        transform: translate(-50%, -50%) scale(1.2);
        box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .note.guide-tone-highlight:hover, .note.root-highlight-for-guides:hover {
        transform: translate(-50%, -50%) scale(1.1) !important; /* Slightly larger hover for highlighted notes */
    }


    .beat { width: 40px; height: 80px; background: #9E9E9E; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: white; font-weight: bold; transition: all 0.2s ease; font-size: 14px; margin: 0 2px; }
    .beats-container { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: nowrap; overflow-x: auto; }
    .beat.active { transform: translateY(-10px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    #measures { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    
    .measure { 
        position: relative; 
        background-color: var(--measure-bg, #e9ecef); 
        padding: 10px; /* Reduced padding slightly */
        border-radius: 4px; 
        transition: opacity 0.2s ease, background-color 0.2s ease, border 0.2s ease; 
        border: 2px solid transparent; 
        cursor: pointer; 
        color: var(--measure-text-color, #333); 
        display: flex; /* For split measure layout */
        flex-direction: column; /* Default: Stack parts or part + button */
        gap: 8px; /* Gap between parts or part and button */
    }
    .measure.split-active {
        /* Styles for when measure is split, parts might go side-by-side */
        flex-direction: row; /* Arrange parts side by side */
        align-items: flex-start; /* Align items at the top */
    }
    .measure-part {
        flex: 1; /* Each part takes equal space if side-by-side */
        display: flex;
        flex-direction: column;
        gap: 5px; /* Gap between controls within a part */
        padding: 5px;
        border: 1px dashed var(--measure-part-border-color, #ccc);
        border-radius: 3px;
    }
    .measure.split-active .measure-part {
        min-width: 120px; /* Ensure controls don't get too squished */
    }

    .measure-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    .measure-number { 
        font-size: 12px; 
        color: var(--measure-text-color, #333);
        background-color: rgba(255,255,255,0.7); 
        padding: 2px 4px; 
        border-radius: 3px; 
    }
    .split-measure-button {
        padding: 3px 6px;
        font-size: 0.8em;
        align-self: flex-end; /* Position button appropriately */
        margin-top: 5px;
    }
    .measure.split-active .split-measure-button {
        /* Adjust button position if measure content is row-based */
        /* This might need to be outside the measure-part flow */
    }
     .measure-footer { /* Container for buttons at the bottom of a measure */
        display: flex;
        justify-content: flex-end; /* Align button to the right */
        margin-top: auto; /* Pushes to the bottom if measure is flex-column */
    }
     .measure.split-active .measure-footer {
        width: 100%; /* Make footer span across if measure becomes row for parts */
        justify-content: center; /* Center button if parts are side-by-side */
        padding-top: 10px;
    }


    .measure.loop-selected { border: 2px solid var(--measure-loop-border, #007bff); background-color: var(--measure-loop-bg, #e6f2ff); }
    .measure.active .measure-part.part-active { background-color: var(--measure-active-bg, #c3e6cb); border: 1px solid var(--measure-active-border, #28a745); }
    .measure.active .measure-part:not(.part-active) { /* Slightly dim inactive part */
        opacity: 0.7;
    }


    .chord-controls, .scale-controls { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;}
    .chord-controls select, .scale-controls select { flex: 1; min-width: 60px; }


    .fretboard-section { border: 1px solid #ccc; padding: 15px; border-radius: 8px; background-color: #f9f9f9; }
    body.dark-mode .fretboard-section { background-color: #3a441e; border-color: #606c38; color: #fefae0; }
    body.dark-mode-2 .fretboard-section { background-color: #001f54; border-color: #1282a2; color: #fefcfb; }
    body.dark-mode-3 .fretboard-section { background-color: #a5a58d; border-color: #cb997e; color: #ffe8d6; }
    .fretboard-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    
    .volume-control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 5px 0;
        color: var(--volume-control-text-color, inherit);
    }
    #metronome-volume-controls-stack {
        display: flex; /* Initially flex, JS will toggle to none/flex */
        flex-direction: column;
        gap: 8px;
        max-width: 400px;
        margin: 15px auto 20px auto;
    }
    #metronome-volume-controls-stack .volume-control {
        width: 100%;
        justify-content: space-between; 
    }
    #metronome-volume-controls-stack .volume-control label,
    #metronome-volume-controls-stack .volume-control span {
        margin-right: 10px;
        white-space: nowrap;
        flex-shrink: 0; 
    }
    #metronome-volume-controls-stack .volume-control input[type="range"] {
        flex-grow: 1;
        min-width: 150px;
        max-width: 250px;
    }

    /* NEW: Collapsible Section Styling */
    .collapsible-section {
        margin-bottom: 15px;
    }
    .collapsible-toggle {
        width: 100%;
        text-align: left;
        padding: 8px 12px;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .collapsible-toggle .toggle-icon {
        font-weight: bold;
        transition: transform 0.2s ease-in-out;
    }
    .collapsible-toggle[aria-expanded="true"] .toggle-icon {
        transform: rotate(45deg);
    }
    .collapsible-content {
        border-top: 1px solid var(--subsection-border-color, #ced4da);
        padding-top: 10px;
    }


    button, .button-like { padding: 10px 15px; border: none; border-radius: 5px; background: var(--button-bg, #4CAF50); color: var(--button-text-color, white); cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
    button:hover, .button-like:hover { background: var(--button-hover-bg, #45a049); }
    button.secondary { background-color: var(--button-secondary-bg, #007bff); }
    button.secondary:hover { background-color: var(--button-secondary-hover-bg, #0056b3); }
    button.danger { background-color: var(--button-danger-bg, #6b705c); }
    button.danger:hover { background-color: var(--button-danger-hover-bg, #c82333); }
    select { padding: 8px 10px; margin: 5px; border-radius: 5px; border: 1px solid var(--select-border-color, #ddd); background-color: var(--select-bg-color, white); color: var(--select-text-color, inherit); }
    #tempo-display { font-size: 1.2em; font-weight: bold; margin: 0 10px; min-width: 70px; text-align: center; }
    #loading-indicator { position: fixed; top: 20px; right: 20px; padding: 10px 15px; background: rgba(0,0,0,0.8); color: white; border-radius: 5px; z-index: 1000; font-size: 0.9em; display: none; }
    .checkbox-wrapper { margin-top: 10px; margin-left: 0; display: flex; align-items: center; }
    .control-button { padding: 8px 12px; font-size: 0.9em; }
    #chordsEnabled { margin-bottom: 10px; }

    #start-stop {
        padding: 12px 25px !important;
        font-size: 1.1em !important;
        font-weight: bold !important;
        background-color: var(--start-stop-bg, #28a745) !important;
        border: 2px solid var(--start-stop-border, #1e7e34) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
        color: var(--start-stop-text-color, white) !important;
    }
    #start-stop:hover {
        background-color: var(--start-stop-hover-bg, #218838) !important;
        border-color: var(--start-stop-hover-border, #1c6c2e) !important;
    }

    /* --- Dark Mode 1 --- */
    body.dark-mode {
        --bg-color: #283618;
        --text-color: #fefae0;
        --section-bg-color: linear-gradient(145deg, #283618, #606c38);
        --section-text-color: #fefae0;
        --fretboard-container-bg: #606c38;
        --fretboard-container-border: #dda15e;
        /* Item 1 */ --song-title-fretboard-color: #dda15e; /* Goldish for DM1 */
        --song-info-h4-color: #fefae0;
        --song-info-p-color: #e0daca;
        --fretboard-bg: #dda15e;
        --fretboard-border: #4b4b4b;
        --note-text-color: #283618; /* Note text on fretboard */
        --scale-display-color: #fefae0;
        --button-bg: #dda15e;
        --button-text-color: #283618;
        --button-hover-bg: #bc6c25;
        --button-secondary-bg: #a17d40;
        --button-secondary-hover-bg: #8a6930;
        --button-danger-bg: #6b705c;
        --button-danger-hover-bg: #d73744;
        --start-stop-bg: #fca311;
        --start-stop-border: #e79002;
        --start-stop-text-color: #283618;
        --start-stop-hover-bg: #e79002;
        --start-stop-hover-border: #c87800;
        --select-bg-color: #dda15e;
        --select-text-color: #283618;
        --select-border-color: #bc6c25;
        --measure-bg: #606c38;
        --measure-text-color: #fefae0;
        --measure-border: #dda15e; /* Default border for measure */
        --measure-active-bg: #dda15e;
        --measure-active-border: #bc6c25;
        --measure-loop-bg: #7d6830;
        --measure-loop-border: #ffc107;
        --beat-bg: #dda15e;
        --beat-text-color: #283618;
        --beat-active-bg: #bc6c25;
        --volume-control-text-color: #fefae0;
        --next-chord-color: #fefae0;
        --measure-part-border-color: #dda15e;

        /* NEW: Subsection styling variables for Dark Mode 1 */
        --subsection-bg-color: #2c3e1a;
        --subsection-border-color: #4a5a2a;
        --subsection-title-color: #fefae0;

        /* Dark Mode 1 Guide Tone Colors */
        --guide-tone-bg-color: #61dafb;      /* Light Cyan/Aqua */
        --guide-tone-text-color: #0a1128;    /* Very Dark Blue/Black */
        --guide-tone-border-color: #4ac9e8;   /* Slightly Darker Cyan */
        --root-highlight-border-color: #ffc107; /* Gold for root highlight */
    }
    .dark-mode .app-section { box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .dark-mode .scale-display { text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    .dark-mode .beat.active { transform: translateY(-5px); }
    #dark-mode-toggle.active { background-color: #283618; color: #fefae0; border: 1px solid #dda15e; }

    /* --- Dark Mode 2 --- */
    body.dark-mode-2 {
        --bg-color: #0a1128;
        --text-color: #fefcfb;
        --section-bg-color: linear-gradient(145deg, #001f54, #034078);
        --section-text-color: #fefcfb;
        --fretboard-container-bg: #034078;
        --fretboard-container-border: #1282a2;
        /* Item 1 */ --song-title-fretboard-color: #61dafb; /* Cyan for DM2 */
        --song-info-h4-color: #fefcfb;
        --song-info-p-color: #e0e0df;
        --fretboard-bg: #001f54;
        --fretboard-border: #1282a2;
        --note-text-color: #fefcfb; /* Note text on fretboard */
        --scale-display-color: #fefcfb;
        --button-bg: #1282a2;
        --button-text-color: #fefcfb;
        --button-hover-bg: #0e6c89;
        --button-secondary-bg: #0c5f7d;
        --button-secondary-hover-bg: #094b61;
        --button-danger-bg: #6b705c;
        --button-danger-hover-bg: #e83838;
        --start-stop-bg: #61dafb;
        --start-stop-border: #4ac9e8;
        --start-stop-text-color: #0a1128;
        --start-stop-hover-bg: #4ac9e8;
        --start-stop-hover-border: #32b6d4;
        --select-bg-color: #034078;
        --select-text-color: #fefcfb;
        --select-border-color: #1282a2;
        --measure-bg: #034078;
        --measure-text-color: #fefcfb;
        --measure-border: #1282a2;
        --measure-active-bg: #1282a2;
        --measure-active-border: #fefcfb;
        --measure-loop-bg: #01325A;
        --measure-loop-border: #61dafb;
        --beat-bg: #1282a2;
        --beat-text-color: #fefcfb;
        --beat-active-bg: #034078;
        --volume-control-text-color: #fefcfb;
        --next-chord-color: #fefcfb;
        --measure-part-border-color: #1282a2;

        /* NEW: Subsection styling variables for Dark Mode 2 */
        --subsection-bg-color: #001844;
        --subsection-border-color: #022c60;
        --subsection-title-color: #fefcfb;

        /* Dark Mode 2 Guide Tone Colors */
        --guide-tone-bg-color: #fca311;      /* Bright Orange/Yellow */
        --guide-tone-text-color: #001f54;    /* Dark Blue (contrasts with bg) */
        --guide-tone-border-color: #e79002;   /* Darker Orange */
        --root-highlight-border-color: #61dafb; /* Cyan for root highlight */
    }
    #dark-mode-toggle.active-2 { background-color: #1282a2; color: #fefcfb; border: 1px solid #034078; }

    /* --- Dark Mode 3 --- */
    body.dark-mode-3 {
        --bg-color: #6b705c;
        --text-color: #ffe8d6;
        --section-bg-color: linear-gradient(145deg, #6b705c, #a5a58d);
        --section-text-color: #ffe8d6;
        --fretboard-container-bg: #a5a58d;
        --fretboard-container-border: #cb997e;
        /* Item 1 */ --song-title-fretboard-color: #e7ad99; /* Peach for DM3 */
        --song-info-h4-color: #ffe8d6;
        --song-info-p-color: #f0d8c6;
        --fretboard-bg: #cb997e;
        --fretboard-border: #6b705c;
        --note-text-color: #6b705c; /* Note text on fretboard */
        --scale-display-color: #ffe8d6;
        --button-bg: #cb997e;
        --button-text-color: #6b705c;
        --button-hover-bg: #b2856c;
        --button-secondary-bg: #b18f7a;
        --button-secondary-hover-bg: #9a7860;
        --button-danger-bg: #6b705c;
        --button-danger-text-color: white; /* Specific for this button */
        --button-danger-hover-bg: #c24a4a;
        --start-stop-bg: #e7ad99;
        --start-stop-border: #d09882;
        --start-stop-text-color: #6b705c;
        --start-stop-hover-bg: #d09882;
        --start-stop-hover-border: #b9836c;
        --select-bg-color: #ddbea9;
        --select-text-color: #6b705c;
        --select-border-color: #cb997e;
        --measure-bg: #a5a58d;
        --measure-text-color: #ffe8d6;
        --measure-border: #cb997e;
        --measure-active-bg: #ddbea9;
        --measure-active-border: #cb997e;
        --measure-loop-bg: #BDA290;
        --measure-loop-border: #e7ad99;
        --beat-bg: #ddbea9;
        --beat-text-color: #6b705c;
        --beat-active-bg: #cb997e;
        --volume-control-text-color: #ffe8d6;
        --next-chord-color: #ffe8d6;
        --measure-part-border-color: #cb997e;

        /* NEW: Subsection styling variables for Dark Mode 3 */
        --subsection-bg-color: #5a5e4c;
        --subsection-border-color: #7c826a;
        --subsection-title-color: #ffe8d6;

        /* Dark Mode 3 Guide Tone Colors */
        --guide-tone-bg-color: #EF233C;      /* Bright Red/Pink */
        --guide-tone-text-color: #ffe8d6;    /* Light Peach (theme text color) */
        --guide-tone-border-color: #D90429;   /* Darker Red */
        --root-highlight-border-color: #e7ad99; /* Peach for root highlight */
    }
    .dark-mode-3 button.danger { color: var(--button-danger-text-color, white); } /* Ensure text color is applied */
    #dark-mode-toggle.active-3 { background-color: #cb997e; color: #ffe8d6; border: 1px solid #6b705c; }

    /* Fretflow Section Theming (ensure these are after main theme blocks if they don't use vars from body) */
    .dark-mode #fretflow-section { background: linear-gradient(145deg, #283618, #606c38); color: #fefae0; }
    .dark-mode-2 #fretflow-section { background: linear-gradient(145deg, #001f54, #034078); color: #fefcfb; }
    .dark-mode-3 #fretflow-section { background: linear-gradient(145deg, #6b705c, #a5a58d); color: #ffe8d6; }

    .toggle-button { padding: 8px 12px; border: none; border-radius: 5px; color: white; cursor: pointer; transition: background-color 0.3s ease; font-size: 0.9em; }
    .toggle-button.active { background: #4CAF50; }
    .toggle-button:not(.active) { background: #9E9E9E; }

    #user-songs-section { margin-top: 15px; }
    #user-songs-section label { margin-right: 5px; }

    /* Media Queries (keep at the end) */
    @media (max-width: 1200px) { /* #measures grid-template-columns already responsive */ }
    @media (max-width: 768px) {
        .measure.split-active {
            flex-direction: column; /* Stack parts on smaller screens */
        }
        .measure.split-active .measure-part {
            min-width: unset; /* Allow full width when stacked */
        }
        /* NEW: Make FretFlow grid single column on smaller screens */
        .fretboards-grid {
            grid-template-columns: 1fr;
        }
    }
    @media (max-width: 600px) { /* #measures grid-template-columns already responsive */ }

    </style>
</head>
<body>
    <!-- MODIFIED: Top Controls / Global Panel -->
    <div class="top-controls app-section">
        <button id="dark-mode-toggle" aria-label="Toggle dark mode">Dark Mode</button>
        <!-- Placeholder for future global controls -->
        <button id="swing-toggle" class="toggle-button" style="display: none;">Swing Off</button>
        <select id="note-naming-convention" style="display: none; margin-left: 10px;">
            <option value="default">Note Names: Default</option>
            <option value="sharps">Note Names: Sharps</option>
            <option value="flats">Note Names: Flats</option>
        </select>
    </div>

    <div class="app-section" id="chord-fretboard-section">
        <h1>BEBOP BLUEPRINT</h1>
        <h3>Fretflow - Dynamic Fretboard with Scales that Move with the Chord Progression</h3>
        <div class="volume-control">
            <span>Fretboard Volume:</span>
            <input type="range" id="chord-fretboard-volume" min="0" max="1" step="0.1" value="0.3">
        </div>
        <div class="fretboard-container">
            <div id="song-info-display-fretboard">
                <h4 id="current-song-title-fretboard"></h4>
                <p id="current-song-description-fretboard"></p>
            </div>
            <div class="scale-display" id="scale-display">Select a progression and key.</div>
            <div class="next-chord-display" id="next-chord-display"></div>
            <div class="controls">
                <select class="tuning-select" id="chord-tuning" aria-label="Select guitar tuning">
                    <option value="standard">Standard (EADGBE)</option>
                    <option value="dropD">Drop D (DADGBE)</option>
                    <option value="openG">Open G (DGDGBD)</option>
                    <option value="DADGAD">DADGAD</option>
                    <option value="openE">Open E (EBEG#BE)</option>
                </select>
                <button id="guide-tones-toggle" class="toggle-button" aria-label="Toggle guide tones">Guide Tones Off</button>
            </div>
            <div id="chord-fretboard" class="fretboard"></div>
        </div>
    </div>

    <div class="app-section" id="metronome-section">
        <h2>BeatForge Metronome</h2>
        <h3>Click to accent strong beats</h3>
        <div class="controls"> 
            <select id="time-signature" aria-label="Select time signature">
                <option value="2">2/4</option> <option value="3">3/4</option> <option value="4" selected>4/4</option>
                <option value="6">6/8</option> <option value="7">7/8</option> <option value="8">8/8</option> <option value="12">12/8</option>
            </select>
            <select id="sound-type" aria-label="Select metronome sound">
                <option value="click">Click</option> <option value="woodblock">Woodblock</option> <option value="drums">Drums</option>
            </select>
            <button id="drumSetToggleBtn" class="control-button" style="display: none;">Drums</button> 
            <input type="range" id="tempo" min="40" max="220" value="120" aria-label="Tempo">
            <span id="tempo-display">120 BPM</span>
            <button id="tap-tempo" aria-label="Tap tempo">Tap Tempo</button>
            <button id="start-stop" aria-label="Start or stop metronome">Start</button>
        </div>

        <!-- MODIFIED: Collapsible Metronome Volume Controls -->
        <div class="collapsible-section">
            <button class="collapsible-toggle button-like secondary" aria-expanded="false" aria-controls="metronome-volume-controls-stack">
                Advanced Volume Controls <span class="toggle-icon">+</span>
            </button>
            <div id="metronome-volume-controls-stack" class="collapsible-content" style="display: none;">
                <div class="volume-control" id="metronome-master-volume-container">
                    <span>Metronome Volume:</span>
                    <input type="range" id="metronome-volume" min="0" max="1" step="0.1" value="0.25" aria-label="Metronome volume">
                </div>
                <div class="volume-control" id="kick-volume-container" style="display: none;">
                    <label for="kick-volume">Kick Volume:</label>
                    <input type="range" id="kick-volume" min="0" max="1" step="0.05" value="1.0" aria-label="Kick volume">
                </div>
                <div class="volume-control" id="snare-volume-container" style="display: none;">
                    <label for="snare-volume">Snare Volume:</label>
                    <input type="range" id="snare-volume" min="0" max="1" step="0.05" value="0.7" aria-label="Snare volume">
                </div>
                <div class="volume-control" id="hihat-volume-container" style="display: none;">
                    <label for="hihat-volume">Hi-hat Volume:</label>
                    <input type="range" id="hihat-volume" min="0" max="1" step="0.05" value="0.8" aria-label="Hi-hat volume">
                </div>
                <div class="volume-control" id="accent-intensity-container">
                    <label for="accent-intensity">Accent Intensity:</label>
                    <input type="range" id="accent-intensity" min="1" max="2" step="0.1" value="1.5" aria-label="Accent intensity">
                </div>
            </div>
        </div>

        <div class="beats-container"></div>
    </div>

    <!-- MODIFIED: Chord Progression Practice Section -->
    <div class="app-section" id="chord-progression-section">
        <h2>Chord Progression Practice</h2>
        <div id="song-info-display" style="display: none;">
            <h4 id="current-song-title"></h4>
            <p id="current-song-description"></p>
        </div>
        <h3>Create a progression or pick one from the dropdown. Choose which key and scale to go with it.</h3>

        <!-- NEW "Song Setup" Area -->
        <div class="song-setup-controls app-subsection">
            <h4>Song Setup</h4>
            <div class="controls">
                <label for="progression-select">Select Progression:</label>
                <select id="progression-select" aria-label="Select chord progression">
                    <optgroup label="Practice Progressions">
                        <option value="I V7">I-V7</option>
                        <option value="2_5_1">II-V-I</option>
                        <option value="6_2_5_1">VI-II-V-I</option>
                        <option value="minor_2_5_1">Minor iim-V7-im</option>
                        <option value="jazz_blues">Jazz Blues</option>
                        <option value="minor_blues">Minor Blues</option>
                        <option value="bird_blues">Bird Blues (Parker Blues)</option>
                        <option value="nows_the_time">Now's The Time (Parker F Blues)</option>
                        <option value="tenor_madness">Tenor Madness (Rollins Bb Blues)</option>
                        <option value="blue_monk">Blue Monk</option>
                        <option value="straight_no_chaser">Straight, No Chaser</option>
                        <option value="rhythm_changes">Rhythm Changes (Standard)</option>
                        <option value="rhythm_changes_bebop">Rhythm Changes (Bebop)</option>
                        <option value="oleo">Oleo (Rhythm Changes)</option>
                    </optgroup>
                    <optgroup label="Easy Jazz Standards">
                        <option value="all_of_me">All of Me</option>
                        <option value="autumn_leaves">Autumn Leaves</option>
                        <option value="blue_bossa">Blue Bossa</option>
                        <option value="embraceable_you">Embraceable You</option>
                        <option value="girl_from_ipanema">Girl From Ipanema (Authentic Bossa)</option>
                        <option value="girl_from_ipanema_jazz">Girl From Ipanema (Jazz Variant)</option>
                        <option value="in_a_sentimental_mood">In a Sentimental Mood</option>
                        <option value="just_friends">Just Friends</option>
                        <option value="misty">Misty</option>
                        <option value="my_funny_valentine">My Funny Valentine</option>
                        <option value="someday_my_prince_will_come">Someday My Prince Will Come</option>
                        <option value="summertime">Summertime</option>
                        <option value="take_the_a_train">Take the "A" Train</option>
                        <option value="there_will_never_be_another_you">There Will Never Be Another You</option>
                    </optgroup>
                    <optgroup label="Gypsy Jazz Standards">
                        <option value="after_youve_gone_gypsy">After You've Gone (Gypsy)</option>
                        <option value="belleville_gypsy">Belleville (Gypsy)</option>
                        <option value="dark_eyes">Dark Eyes</option>
                        <option value="djangology">Djangology</option>
                        <option value="douce_ambiance_gypsy">Douce Ambiance (Gypsy)</option>
                        <option value="ill_see_you_in_my_dreams">I'll See You In My Dreams (Django)</option>
                        <option value="ill_see_you_in_my_dreams_alternate">I'll See You In My Dreams (Django Alt.)</option>
                        <option value="jattendrai_gypsy">J'attendrai (Gypsy)</option>
                        <option value="limehouse_blues_gypsy">Limehouse Blues (Gypsy)</option>
                        <option value="minor_swing">Minor Swing</option>
                        <option value="nuages">Nuages</option>
                        <option value="rose_room_django">Rose Room (Django)</option>
                        <option value="sweet_georgia_brown_gypsy">Sweet Georgia Brown (Gypsy)</option>
                        <option value="swing_42_gypsy">Swing 42 (Gypsy)</option>
                    </optgroup>
                    <optgroup label="More Complex Jazz Standards">
                        <option value="a_night_in_tunisia">A Night in Tunisia</option>
                        <option value="all_the_things_you_are">All The Things You Are</option>
                        <option value="black_orpheus">Black Orpheus (Manhã de Carnaval)</option>
                        <option value="body_and_soul">Body and Soul</option>
                        <option value="caravan">Caravan</option>
                        <option value="cherokee">Cherokee</option>
                        <option value="coltrane_changes">Coltrane Changes (Giant Steps Cycle)</option>
                        <option value="confirmation">Confirmation</option>
                        <option value="days_of_wine_and_roses">Days of Wine and Roses</option>
                        <option value="dolphin_dance">Dolphin Dance (Main 16-bar theme)</option>
                        <option value="donna_lee">Donna Lee</option>
                        <option value="footprints">Footprints (12-bar modal blues)</option>
                        <option value="how_high_the_moon">How High the Moon</option>
                        <option value="impressions">Impressions</option>
                        <option value="moments_notice">Moment's Notice (Main 16-bar theme)</option>
                        <option value="on_green_dolphin_street">On Green Dolphin Street</option>
                        <option value="recorda_me">Recorda Me (Main 16-bar theme)</option>
                        <option value="rose_room">Rose Room (Traditional)</option>
                        <option value="so_what">So What</option>
                        <option value="solar">Solar</option>
                        <option value="stella_by_starlight">Stella By Starlight</option>
                    </optgroup>
                </select>
                <label for="keySelect">Select Key:</label>
                <select id="keySelect" aria-label="Select key">
                  <option value="C">C</option> <option value="Cm">Cm</option> <option value="Db">Db</option> <option value="Dbm">Dbm</option> <option value="D">D</option> <option value="Dm">Dm</option> <option value="Eb">Eb</option> <option value="Ebm">Ebm</option> <option value="E">E</option> <option value="Em">Em</option> <option value="F">F</option> <option value="Fm">Fm</option> <option value="Gb">Gb</option> <option value="Gbm">Gbm</option> <option value="G">G</option> <option value="Gm">Gm</option> <option value="Ab">Ab</option> <option value="Abm">Abm</option> <option value="A">A</option> <option value="Am">Am</option> <option value="Bb">Bb</option> <option value="Bbm">Bbm</option> <option value="B">B</option> <option value="Bm">Bm</option>
                </select>
                <button id="loop-selected-toggle" class="toggle-button" aria-label="Toggle measure looping">Looping Off</button>
            </div>
        </div>

        <div id="user-songs-section" class="controls">
            <label for="user-progression-select">Your Saved Songs:</label>
            <select id="user-progression-select" aria-label="Select your saved chord progression">
                <option value="">-- Select a saved song --</option>
            </select>
            <button id="delete-user-song-button" class="danger">Delete Selected Song</button>
        </div>

        <div id="measures"></div>

        <div class="controls">
            <button onclick="addMeasure()" aria-label="Add measure">Add Measure</button>
            <button onclick="removeMeasure()" aria-label="Remove measure">Remove Last Measure</button>
            <button id="save-progression-button" class="secondary" aria-label="Save current progression">Save Current Progression</button>
            <button id="chordsEnabled" class="toggle-button active">Chords Enabled</button>
        </div>
        <div class="volume-control">
            <label for="chord-volume">Chord Volume:</label>
            <input type="range" id="chord-volume" min="0" max="1" step="0.1" value="0.5" aria-label="Chord volume">
        </div>
        <div class="control-group">
              <label for="reverb-dial">Reverb</label>
              <input type="range" id="reverb-dial" min="0" max="100" value="20" style="width: 120px;">
              <span id="reverb-dial-value">20</span>%
         </div>
    </div>

<div class="app-section" id="fretflow-section">
    <h2>FretFlow</h2>
    <h3>Multiple scale workout</h3>
    <div class="fretboards-grid"></div>
</div>
    <div id="loading-indicator"></div>
    <script>
// ==================================
// === UTILITY FUNCTIONS ==========
// ==================================

/**
 * Logs a message to the console with a prefix.
 * @param {string} message - The message to log.
 */
function log(message) {
    console.log(`[Bebop Blueprint Debug] ${message}`);
}

/**
 * Updates and shows/hides a loading indicator.
 * @param {string} message - The message to display in the indicator.
 * @param {boolean} [isVisible=true] - Whether the indicator should be visible.
 */
function updateLoadingStatus(message, isVisible = true) {
    let i = document.getElementById('loading-indicator');
    if (!i) {
        i = document.createElement('div');
        i.id = 'loading-indicator';
        document.body.appendChild(i);
    }
    i.textContent = message;
    i.style.display = isVisible ? 'block' : 'none';
}

// ==================================
// === MUSICAL CONSTANTS ==========
// ==================================

const NOTES = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
const NOTES_CHROMATIC = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
const ALL_NOTES_FOR_SAMPLES = ["a", "as", "b", "c", "cs", "d", "ds", "e", "f", "fs", "g", "gs"];
const OCTAVES_FOR_SAMPLES = [2, 3, 4, 5];
const PLAYBACK_OCTAVES = [3, 4]; // Preferred octaves for chord playback
const FILE_FORMAT = "wav";

const SAMPLE_NOTE_MAP = {
  C: "c", Db: "cs", "C#": "cs", D: "d", Eb: "ds", "D#": "ds", E: "e", F: "f",
  Gb: "fs", "F#": "fs", G: "g", Ab: "gs", "G#": "gs", A: "a", Bb: "as", "A#": "as", B: "b",
  CS: "cs", DS: "ds", FS: "fs", GS: "gs", AS: "as",
};

const FRETBOARD_NOTES_OCTAVES = {
  string1: ["E4", "F4", "Fs4", "G4", "Gs4", "A4", "As4", "B4", "C5", "Cs5", "D5", "Ds5", "E5"],
  string2: ["B3", "C4", "Cs4", "D4", "Ds4", "E4", "F4", "Fs4", "G4", "Gs4", "A4", "As4", "B4"],
  string3: ["G3", "Gs3", "A3", "As3", "B3", "C4", "Cs4", "D4", "Ds4", "E4", "F4", "Fs4", "G4"],
  string4: ["D3", "Ds3", "E3", "F3", "Fs3", "G3", "Gs3", "A3", "As3", "B3", "C4", "Cs4", "D4"],
  string5: ["A2", "As2", "B2", "C3", "Cs3", "D3", "Ds3", "E3", "F3", "Fs3", "G3", "Gs3", "A3"],
  string6: ["E2", "F2", "Fs2", "G2", "Gs2", "A2", "As2", "B2", "C3", "Cs3", "D3", "Ds3", "E3"],
};

const SCALES = {
  major: [0, 2, 4, 5, 7, 9, 11], minor: [0, 2, 3, 5, 7, 8, 10],
  harmonicMinor: [0, 2, 3, 5, 7, 8, 11], melodicMinor: [0, 2, 3, 5, 7, 9, 11],
  dorian: [0, 2, 3, 5, 7, 9, 10], phrygian: [0, 1, 3, 5, 7, 8, 10],
  lydian: [0, 2, 4, 6, 7, 9, 11], mixolydian: [0, 2, 4, 5, 7, 9, 10],
  locrian: [0, 1, 3, 5, 6, 8, 10], bebopDominant: [0, 2, 4, 5, 7, 9, 10, 11],
  bebopMajor: [0, 2, 4, 5, 7, 8, 9, 11], bebopDorian: [0, 2, 3, 4, 5, 7, 9, 10],
  bebopPhrygian: [0, 1, 2, 3, 5, 7, 8, 10], altered: [0, 1, 3, 4, 6, 8, 10],
  lydianDominant: [0, 2, 4, 6, 7, 9, 10], diminishedWH: [0, 2, 3, 5, 6, 8, 9, 11],
  diminishedHW: [0, 1, 3, 4, 6, 7, 9, 10], wholeTone: [0, 2, 4, 6, 8, 10],
  pentatonicMajor: [0, 2, 4, 7, 9], pentatonicMinor: [0, 3, 5, 7, 10],
  blues: [0, 3, 5, 6, 7, 10], majorBlues: [0, 2, 3, 4, 7, 9],
  harmonicMajor: [0, 2, 4, 5, 7, 8, 11], doubleHarmonic: [0, 1, 4, 5, 7, 8, 11],
  enigmatic: [0, 1, 4, 6, 8, 10, 11], persian: [0, 1, 4, 5, 6, 8, 11],
  arabic: [0, 2, 4, 5, 6, 8, 10], japanese: [0, 2, 5, 7, 8],
  egyptian: [0, 2, 5, 7, 10],
};

const TUNINGS = {
  standard: ["E", "A", "D", "G", "B", "E"], // Low E to High E
  dropD:    ["D", "A", "D", "G", "B", "E"],
  openG:    ["D", "G", "D", "G", "B", "D"],
  DADGAD:   ["D", "A", "D", "G", "A", "D"],
  openE:    ["E", "B", "E", "Ab", "B", "E"],
};

const CHORD_INTERVALS = {
  maj: [0, 4, 7], min: [0, 3, 7], dim: [0, 3, 6], aug: [0, 4, 8],
  sus4: [0, 5, 7], sus2: [0, 2, 7],
  maj7: [0, 4, 7, 11], dom7: [0, 4, 7, 10], min7: [0, 3, 7, 10],
  min7b5: [0, 3, 6, 10], dim7: [0, 3, 6, 9],
  maj6: [0, 4, 7, 9], min6: [0, 3, 7, 9],
  dom7b9: [0, 4, 7, 10, 1],
  "dom7#9": [0, 4, 7, 10, 3],
  dom7b5: [0, 4, 6, 10],
  alt: [0, 4, 1, 6, 10],
  dom7sus: [0, 5, 7, 10],
  maj9: [0, 4, 7, 11, 2],
  dom9: [0, 4, 7, 10, 2],
  min9: [0, 3, 7, 10, 2],
  imaj7: [0, 3, 7, 11],
  "6": [0, 4, 7, 9],
  "m6": [0, 3, 7, 9],
  "6/9": [0, 4, 7, 9, 2],
  "7#11": [0, 4, 7, 10, 6],
  "maj7#11": [0, 4, 7, 11, 6],
  "7b13": [0, 4, 7, 10, 8],
  unknown: [0, 4, 7, 10],
};

const drumSoundSets = [
  { name: "Drums", snare: "Snare.wav", hihat: "HiHat.wav", kick: "Kick.wav" },
  { name: "Makaya", snare: "Snare2.wav", hihat: "HiHat2.wav", kick: "Kick2.wav" },
  { name: "PhillyJoe", kick: "jazzkick.wav", snare: "jazzsnare.wav", hihat: "jazzhat.wav" },
];

const progressions = {
  "I V7": {
    defaultKey: "C",
    displayName: "I-V7",
    progression: ["Imaj7", "V7"],
    description: "A classic two-chord progression often used in jazz standards for a simple, elegant harmonic resolution.",
  },
  jazz_blues: {
    defaultKey: "Bb",
    displayName: "Jazz Blues",
    progression: [
      "Bb7", "Eb7", "Bb7", "Bb7",
      "Eb7", "Eb7", "Bb7", "G7",
      "Cm7", "F7", "Bb7", "F7"
    ],
    description: "A swinging 12-bar blues with jazzy substitutions, perfect for improvisation and soulful melodies.",
  },
  minor_blues: {
    defaultKey: "Cm",
    displayName: "Minor Blues",
    progression: [
      "Cm7", "Cm7", "Cm7", "Cm7",
      "Fm7", "Fm7", "Cm7", "Cm7",
      "G7alt", "G7alt", "Cm7", "G7alt"
    ],
    description: "A moody minor blues progression with a melancholic vibe, ideal for expressive solos.",
  },
  rhythm_changes: { 
    defaultKey: "Bb",
    displayName: "Rhythm Changes (Standard)",
    progression: [
      "Bbmaj7", "G7",    "Cm7",    "F7", "Bbmaj7", "G7",    "Cm7",    "F7",
      "Bbmaj7", "G7",    "Cm7",    "F7", "Bbmaj7", "Bb7",   "Ebmaj7", "Edim7",
      "Dm7",    "G7",    "Cm7",    "F7", "Bbmaj7", "F7", 
      "Bbmaj7", "G7",    "Cm7",    "F7", "Bbmaj7", "G7",    "Cm7",    "F7"
    ],
    description: "A fast-paced, iconic jazz structure based on Gershwin's 'I Got Rhythm,' great for bebop. This is the standard 32-bar AABA form with traditional changes."
  },
  rhythm_changes_bebop: { 
    defaultKey: "Bb",
    displayName: "Rhythm Changes (Bebop)",
    progression: [
      "Bbmaj7", "Bdim7", "Cm7",    "F7", "Dm7",    "G7",    "Cm7",    "F7",
      "Bbmaj7", "Bdim7", "Cm7",    "F7", "Dm7",    "Db7",   "Cm7",    "F7",
      "D7",     "D7",    "G7",     "G7", "C7",     "C7",    "F7",     "F7",
      "Bbmaj7", "Bdim7", "Cm7",    "F7", "Dm7",    "G7",    "Cm7",    "F7"
    ],
    description: "A bebop-oriented variation of Rhythm Changes with more sophisticated substitutions and a dominant cycle bridge, commonly used in jam sessions and bebop performances."
  },
  "2_5_1": {
    defaultKey: "C",
    displayName: "II-V-I",
    progression: ["iim7", "V7", "Imaj7", "Imaj7"],
    description: "The quintessential jazz turnaround, providing a smooth and satisfying resolution.",
  },
  "6_2_5_1": {
    defaultKey: "C",
    displayName: "VI-II-V-I",
    progression: ["vim7", "iim7", "V7", "Imaj7"],
    description: "An extended version of the 2-5-1, starting on the vi minor for a richer harmonic journey.",
  },
  minor_2_5_1: {
    defaultKey: "Gm", // Corrected based on your previous input
    displayName: "Minor iim-V7-im",
    progression: ["Am7b5", "D7alt", "Gm7", "Gm7"],
    description: "A dramatic minor key progression, often used for intense and emotional resolutions.",
  },
  dark_eyes: { 
    defaultKey: "Dm",
    displayName: "Dark Eyes",
    progression: [
      "Dm", "Dm", "A7", "A7", "A7", "A7", "Bbmaj7", "Bbmaj7", // Corrected from Dm to Bbmaj7 for variation
      "Gm", "Gm", "Dm", "Dm", "A7", "A7", "Dm", "Dm"
    ],
    description: "A passionate, Gypsy jazz-inspired progression with a fiery, Eastern European flair.",
  },
  ill_see_you_in_my_dreams: { 
    defaultKey: "F", // Often played in F or G by Django, original is Bb
    displayName: "I'll See You In My Dreams (Django)",
     progression: [ // Simplified a bit for common Django versions
      "F6", "F6", "Fm6", "Fm6", "C6",  "B7", "C6",  "C6",
      "A7", "A7", "D7", "D7", "G7", "G7", "C7", "C7",
      "F6", "F6", "Fm6", "Fm6", "C6",  "B7", "F6",  "D7",
      "Gm7", "C7", "F6", "F6" // Simplified ending
    ],
    description: "A popular Django Reinhardt arrangement, characterized by 6th chords."
  },
  ill_see_you_in_my_dreams_alternate: { 
    defaultKey: "Bb",
    displayName: "I'll See You In My Dreams (Django Alt.)",
    progression: [
      "Bbmaj6", "G7",     "Cm7",    "F7",     "Bbmaj6", "Bbmin6", "Fmaj6",  "F7",
      "Bbmaj6", "D7",     "Gm7",    "C7",     "Fmaj6",  "F#dim7", "Bbmaj6", "F7",
      "Bbmaj6", "G7",     "Cm7",    "F7",     "Bbmaj6", "Bbmin6", "Fmaj6",  "F7",
      "Bbmaj6", "D7",     "Gm7",    "C7",     "Fmaj6",  "F7",     "Bbmaj6", "Bbmaj6"
    ],
    description: "An alternate Django-style arrangement featuring both the characteristic 6th chords and the passing diminished chords often used in Gypsy jazz interpretations."
  },
  rose_room: { 
    defaultKey: "Ab", // Traditional key
    displayName: "Rose Room (Traditional)",
    progression: [ // Based on the 1917 version
      "Abmaj7","Abmaj7","Dbmaj7","Dbmaj7", "Abmaj7","Eb7",   "Abmaj7","Abmaj7",
      "Abmaj7","Abmaj7","Dbmaj7","Dbmaj7", "Fm7",   "Bb7",   "Ebmaj7","Eb7",
      "Abmaj7","Abmaj7","Dbmaj7","Dbmaj7", "Abmaj7","Cm7b5 F7","Bbm7",  "Eb7",
      "Abmaj7","Dbmaj7","Abmaj7","F7",     "Bbm7",  "Eb7",   "Abmaj7","(Eb7)"
    ],
    description: "The authentic 'Rose Room' progression with the traditional harmonization favored by swing and early jazz players."
  },
  rose_room_django: { 
    defaultKey: "Ab", // Django also played it in Ab
    displayName: "Rose Room (Django)",
    progression: [
      "Ab6",    "Eb7",    "Ab6", "Ab6", "Bbm6",   "Eb7",    "Ab6", "Ab6",
      "Ab6",    "C7",     "Fm6", "Fm6", "Bbm7",   "Eb7",    "Ab6", "Eb7",
      "Db6",    "Dbm6",   "Ab6", "F7",  "Bbm7",   "Eb7",    "Ab6", "Eb7",
      "Ab6",    "C7",     "Fm6", "Bb7", "Bbm7",   "Eb7",    "Ab6", "Ab6"
    ],
    description: "A Django Reinhardt-influenced version of 'Rose Room' with characteristic Gypsy jazz voicings and substitutions."
  },
  black_orpheus: { 
    defaultKey: "Am",
    displayName: "Black Orpheus (Manhã de Carnaval)",
    progression: [
      "Am7",  "Am7", "Bm7b5","E7b9", "Am7",  "Dm7",    "G7",   "Cmaj7",
      "Fmaj7","Bm7b5", "E7b9", "Am7","Am7", "A7",    "Dm7",   "G7",
      "Cmaj7","Fmaj7", "Bm7b5", "E7b9","Am7",  "E7b9", "Am7",   "Am7"
    ],
    description: "A bossa nova classic with a haunting minor key, inspired by Brazilian rhythms."
  },
  all_the_things_you_are: {
    defaultKey: "Ab",
    displayName: "All The Things You Are",
    progression: [
        "Fm7",    "Bbm7",   "Eb7",    "Abmaj7",
        "Dbmaj7", "Dm7b5",  "G7",     "Cmaj7",
        "Cm7",    "Fm7",    "Bb7",    "Ebmaj7",
        "Abmaj7", "Am7b5",  "D7b9",   "Gmaj7",
        "Gmaj7",  "Am7",    "D7",     "Gmaj7", // Often Gmaj7 for 2 bars here in solos
        "Gmaj7",  "F#m7b5", "B7b9",   "Emaj7", // Often Emaj7 for 2 bars here
        "Emaj7",  "Am7 D7", "Gmaj7 C7","Fm7 Bb7", // Bridge back to A, or more complex changes
        "Ebmaj7 Abmaj7","Dbmaj7 G7","Cmaj7", "(Cmaj7)" // Ending variations exist
      // Simplified the ending part from the original overly long one you had
    ],
    description: "Kern & Hammerstein standard. A cornerstone of the jazz repertoire known for its modulations.",
  },
  all_of_me: { 
    defaultKey: "C",
    displayName: "All of Me",
    progression: [
      "Cmaj7", "E7",    "A7",    "Dm7",
      "E7",    "Am7",   "D7",    "Dm7 G7",
      "Cmaj7", "E7",    "A7",    "Dm7",
      "Fmaj7", "Fm6",   "Cmaj7 G7", "C6 (A7 Dm7 G7)" // Common turnaround added
    ],
    description: "A cheerful, upbeat standard with a catchy progression, great for vocal jazz.",
  },
  stella_by_starlight: { 
    defaultKey: "Bb",
    displayName: "Stella By Starlight",
    progression: [
      "Em7b5", "A7alt",  "Cm7",    "F7",
      "Fm7",   "Bb7",    "Ebmaj7", "Ab7", // Ab7 or Abmaj7
      "Dm7b5", "G7alt",  "Cmaj7",  "Am7 D7", // Often Am7 D7 instead of Cmaj7 for 2
      "Gm7",   "C7",     "Fm7",    "Bb7",
      "Ebmaj7", "Ebdim7", "Dm7",    "G7alt",
      "Cm7",   "F7",     "Bbmaj7", "Bbmaj7 (Em7b5 A7alt for repeat)" // Or F#dim7 B7 to loop to Ebmaj7
    ],
    description: "A lush, cinematic progression with a romantic and introspective feel."
  },
  autumn_leaves: { 
    defaultKey: "Gm", // More common jazz key for this tune than Bb major
    displayName: "Autumn Leaves",
    progression: [
      "Cm7",   "F7",    "Bbmaj7", "Ebmaj7",
      "Am7b5", "D7alt", "Gm7",    "Gm7 (C7 for turnaround to F7)",
      "Cm7",   "F7",    "Bbmaj7", "Ebmaj7",
      "Am7b5", "D7alt", "Gm7 G7alt", "Cm7 F7 (or Gm for end)" // G7alt leading to Cm7
    ],
    description: "A melancholic jazz standard evoking falling leaves and wistful nostalgia."
  },
  summertime: { 
    defaultKey: "Am", // Or Dm
    displayName: "Summertime",
    progression: [
      "Am7", "Am7", "E7",  "E7",
      "Am7", "Am7", "Dm7", "Am7",
      "Dm7", "Am7", "E7",  "Am7 (E7alt for repeat)",
      "Am7" // Add extra bar for common 16 bar form
    ],
    description: "A sultry, soulful progression from Gershwin's opera, perfect for laid-back grooves."
  },
  girl_from_ipanema: { 
    defaultKey: "F",
    displayName: "Girl From Ipanema (Authentic Bossa)",
    progression: [
      "Fmaj7",  "Fmaj7",  "G7", "G7", // G7 or G7#11
      "Gm7",    "Gb7#11",    "Fmaj7", "Gb7#11", // or Fmaj7 for 2 bars
      "Fmaj7",  "Fmaj7",  "G7", "G7",
      "Gm7",    "C7",     "Fmaj7", "Fmaj7", // A section ends
      "F#maj7", "F#maj7", "B7",   "B7",    // Bridge
      "Bm7",    "E7",     "Amaj7","Amaj7",
      "Abm7",   "Db7",    "Gbmaj7","Gbmaj7",
      "Gm7",    "C7",     "Fmaj7", "Fmaj7"  // Back to A or end
    ],
    description: "The authentic bossa nova classic by Antonio Carlos Jobim with the traditional modulation."
  },
  girl_from_ipanema_jazz: { 
    defaultKey: "F",
    displayName: "Girl From Ipanema (Jazz Variant)",
    progression: [
      "Fmaj7",  "D7alt",  "Gm9",    "C13",
      "Am9",    "D7b9",   "Gm9",    "C13", // Repeated A section
      "Fmaj7",  "D7alt",  "Gm9",    "C13",
      "Am9",    "D7b9",   "Gm9",    "C13",
      "F#maj7", "C#7alt", "Bbm9",   "Eb13", // Jazzier bridge changes
      "Abm9",   "Db7b9",  "Bbm9",   "Eb13",
      "Fmaj7",  "D7alt",  "Gm9",    "C13",  // Back to A
      "Am9",    "D7b9",   "Gm9",    "C13"
    ],
    description: "A jazzier interpretation of 'Girl From Ipanema' with extended harmonies and common jazz substitutions."
  },
  coltrane_changes: { 
    defaultKey: "Bb", // Giant Steps is often in Bb or Eb
    displayName: "Coltrane Changes (Giant Steps Cycle)",
    progression: [
      "Bbmaj7", "D7",    "Gmaj7",  "Bb7",
      "Ebmaj7", "Gb7",   "Cbmaj7", "E7", // Cbmaj7 or Bmaj7
      "Amaj7",  "C7",    "Fmaj7",  "Ab7",
      "Dbmaj7", "E7",    "Amaj7",  "C7" // Loop or resolve
    ],
    description: "A challenging, innovative progression from John Coltrane, with rapid key shifts based on major thirds."
  },
  bird_blues: { 
    defaultKey: "F",
    displayName: "Bird Blues (Parker Blues)",
    progression: [
      "Fmaj7",  "Em7b5 A7alt", "Dm7 G7alt", "Cm7 F7",
      "Bbmaj7", "Bbm7 Eb7",    "Am7 D7alt", "Abm7 Db7",
      "Gm7",    "C7alt",       "Fmaj7 D7alt", "Gm7 C7alt"
    ],
    description: "A bebop blues progression inspired by Charlie Parker, full of energy and drive."
  },
  just_friends: { 
    defaultKey: "F", // Often played in F or G
    displayName: "Just Friends",
    progression: [
      "Fmaj7", "A7",    "Dm7", "G7",
      "Gm7",   "C7",    "Fmaj7", "C7",
      "Fmaj7", "A7",    "Dm7", "G7",
      "Gm7",   "C7",    "Fmaj7", "Fmaj7",
      "Bbmaj7","Bbm7",  "Fmaj7", "D7",
      "Gm7",   "C7",    "Am7 D7", "Gm7 C7", // Common bridge variations
      "Fmaj7", "A7",    "Dm7", "G7",
      "Gm7",   "C7",    "Fmaj7", "Fmaj7"
    ],
    description: "A lively, upbeat standard with a playful harmonic structure, great for swing."
  },
  blue_bossa: { 
    defaultKey: "Cm",
    displayName: "Blue Bossa",
    progression: [
      "Cm7",  "Cm7",  "Fm7",  "Fm7",
      "Dm7b5","G7alt","Cm7",  "Cm7 (Ab7 for bridge)", // Ab7 leads to Dbmaj7
      "Ebm7", "Ab7",  "Dbmaj7","Dbmaj7",
      "Dm7b5","G7alt","Cm7",  "(G7alt for repeat or Cm7 for end)"
    ],
    description: "A cool, Latin-jazz progression with a relaxed yet groovy bossa nova feel."
  },
  on_green_dolphin_street: { 
    defaultKey: "Eb", // Common key, though C is also used
    displayName: "On Green Dolphin Street",
    progression: [
      "Ebmaj7", "Ebmaj7", "Ebm7",  "Ab7",   // Or Dmaj7, Dm7, G7 for C version
      "Dbmaj7", "Dbmaj7", "Dm7b5", "G7alt",
      "Cm7",    "Cm7",    "Fm7",   "Bb7",
      "Ebmaj7", "Am7b5 D7b9", "Gm7", "C7alt", // Turnaround
      "Fm7",    "Bb7",    "Ebmaj7", "Ebmaj7"
    ],
    description: "A modal, cinematic progression with a mysterious and captivating atmosphere."
  },
  solar: { 
    defaultKey: "Cm",
    displayName: "Solar",
    progression: [
      "Cm(maj7)", "Cm(maj7)", "Gm7b5",  "C7alt",
      "Fmaj7",    "Fmaj7",    "Fm7",    "Bb7",
      "Ebmaj7",   "Ebmaj7",   "Am7b5",  "D7alt", // Or Ebm7 Ab7 for a variation
      "Gm7",      "C7alt",    "Fmaj7",  "Fmaj7 (or turnaround)"
    ],
    description: "A contemplative, Miles Davis original with a flowing, introspective harmonic line."
  },
  misty: { 
    defaultKey: "Eb",
    displayName: "Misty",
    progression: [
      "Ebmaj7", "Bbm7",  "Eb7",   "Abmaj7",
      "Abm7",   "Db7",   "Ebmaj7","Cm7",
      "Fm7",    "Bb7",   "Gm7",   "C7alt",
      "Fm7",    "Bb7",   "Ebmaj7","(Fm7 Bb7 for repeat or Eb6 for end)"
    ],
    description: "A tender, romantic ballad progression, evoking misty-eyed sentimentality."
  },
  days_of_wine_and_roses: { 
    defaultKey: "F",
    displayName: "Days of Wine and Roses",
    progression: [
      "Fmaj7", "Eb7#11", "Dm7",   "G7#11", // Common subs
      "Cm7",   "F7",     "Bbmaj7","Bbm7 Eb7",
      "Am7",   "D7",     "Gm7",   "C7",
      "Fmaj7", "Dm7 Gm7","C7sus C7","F6"
    ],
    description: "A bittersweet, elegant progression with a waltzing, reflective quality."
  },
  cherokee: { 
    defaultKey: "Bb",
    displayName: "Cherokee",
    progression: [ 
      "Bbmaj7", "Bbmaj7","Bbmaj7", "Bbmaj7", "Cm7",    "F7",    "Bbmaj7", "Bbmaj7",
      "Bbmaj7", "Bbmaj7","Bbmaj7", "Bbmaj7", "Cm7",    "F7",    "Bbmaj7", "Bb7", // Bb7 leads to bridge
      // Bridge
      "Bmaj7",  "Bmaj7", "Emaj7",  "Emaj7",  "Amaj7",  "Amaj7", "Dmaj7",  "Dmaj7",
      "Gmaj7",  "Gmaj7", "Cmaj7",  "Cmaj7",  "Fmaj7",  "Fmaj7", "Bb7",    "Bb7",
      // Back to A
      "Bbmaj7", "Bbmaj7","Bbmaj7", "Bbmaj7", "Cm7",    "F7",    "Bbmaj7", "Bbmaj7"
    ],
    description: "A high-energy bebop standard with a fast-moving, adventurous harmonic structure."
  },
  caravan: { 
    defaultKey: "Fm",
    displayName: "Caravan",
    progression: [ 
      "Fm7", "Fm7", "Fm7", "C7b9", "Fm7", "Fm7", "C7b9","Fm7", // A Section
      "Abmaj7","Abmaj7","Dbmaj7","Dbmaj7","Gm7b5", "C7b9",  "Fm7",   "Fm7"  // B Section
    ],
    description: "An exotic, Latin-tinged progression with a hypnotic, caravan-like rhythm."
  },
  nows_the_time: { 
    defaultKey: "F",
    displayName: "Now's The Time (Parker F Blues)",
    progression: [ 
      "F7", "Bb7", "F7", "F7",
      "Bb7","Bb7", "F7", "D7alt",
      "Gm7","C7",  "F7", "(Gm7 C7 or F7)"
    ],
    description: "A gritty, straightforward blues progression by Charlie Parker, full of soul."
  },
  tenor_madness: { 
    defaultKey: "Bb",
    displayName: "Tenor Madness (Rollins Bb Blues)",
    progression: [ 
      "Bb7", "Eb7", "Bb7", "Bb7",
      "Eb7", "Eb7", "Bb7", "G7alt",
      "Cm7", "F7",  "Bb7", "(Cm7 F7 or Bb7)"
    ],
    description: "A hard-swinging blues progression, ideal for fiery tenor sax battles."
  },
  embraceable_you: {
    defaultKey: "G",
    displayName: "Embraceable You",
    progression: [
      "Gmaj7", "Gmaj7", "Em7 A7", "Am7 D7",
      "Gmaj7", "Gmaj7", "Em7 A7", "G6 D7alt",
      "Gmaj7", "Gmaj7", "Em7 A7", "Am7 D7",
      "Gmaj7", "Gmaj7", "Em7 A7", "G6",
      "Gm7", "C7", "Fmaj7", "Fmaj7",
      "Bb7", "Bb7", "Ebmaj7 D7", "Gmaj7 E7",
      "Am7", "D7", "Gmaj7", "Gmaj7",
      "Gmaj7", "E7", "Am7 D7", "G6 (D7)"
    ],
    description: "George Gershwin's timeless ballad, a favorite for its tender melody and rich harmonies."
  },
  body_and_soul: {
    defaultKey: "Db",
    displayName: "Body and Soul",
    progression: [
      "Ebm7 Ab7", "Dbmaj7", "Ebm7 A7", "Dbmaj7",
      "Ebm7 Ab7", "Dbmaj7", "Bbm7", "Eb7 Ab7",
      "Ebm7 Ab7", "Dbmaj7", "Ebm7 A7", "Dbmaj7",
      "Ebm7 Ab7", "Dbmaj7", "Bbm7", "Eb7 Ab7",
      "Dm7", "Dm7", "G7", "G7",
      "Cmaj7", "Cmaj7", "Cm7 F7", "Bb7 Eb7",
      "Ebm7 Ab7", "Dbmaj7", "Ebm7 A7", "Dbmaj7",
      "Ebm7 Ab7", "Dbmaj7", "Bbm7", "Dbmaj7"
    ],
    description: "A quintessential jazz ballad by Johnny Green, known for its challenging bridge and emotional depth."
  },
  take_the_a_train: {
    defaultKey: "C",
    displayName: "Take the A Train",
    progression: [
      "Cmaj7", "Cmaj7", "D7", "D7",
      "Dm7 G7", "Cmaj7 A7", "Dm7 G7", "C6 (G7)",
      "Cmaj7", "Cmaj7", "D7", "D7",
      "Dm7 G7", "Cmaj7 A7", "Dm7 G7", "C6 (G7)",
      "Fmaj7", "Fmaj7", "Fmaj7", "Fmaj7",
      "D7", "G7", "Cmaj7 (A7)", "Dm7 G7",
      "Cmaj7", "Cmaj7", "D7", "D7",
      "Dm7 G7", "Cmaj7 A7", "Dm7 G7", "C6"
    ],
    description: "Duke Ellington's signature tune, an upbeat swing classic with a memorable melody."
  },
  so_what: {
    defaultKey: "Dm",
    displayName: "So What",
    progression: [
      "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7",
      "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7",
      "Ebm7", "Ebm7", "Ebm7", "Ebm7", "Ebm7", "Ebm7", "Ebm7", "Ebm7",
      "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7"
    ],
    description: "Miles Davis's modal jazz masterpiece, characterized by its spacious harmony and iconic bassline."
  },
  impressions: {
    defaultKey: "Dm", 
    displayName: "Impressions",
    progression: [
      "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7",
      "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7",
      "Ebm7", "Ebm7", "Ebm7", "Ebm7", "Ebm7", "Ebm7", "Ebm7", "Ebm7",
      "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7", "Dm7"
    ],
    description: "John Coltrane's high-energy modal piece, sharing the harmonic structure of 'So What'."
  },
  how_high_the_moon: {
    defaultKey: "G",
    displayName: "How High the Moon",
    progression: [
      "Gmaj7", "Gmaj7", "Gm7", "C7",
      "Fmaj7", "Fmaj7", "Fm7", "Bb7",
      "Ebmaj7", "Am7b5", "D7", "Gmaj7", // Simplified B section start
      "Gmaj7", "Gm7", "C7", "Fmaj7",   // Common changes
      "Fmaj7", "Fm7", "Bb7", "Ebmaj7",
      "Am7b5", "D7alt", "Gmaj7", "Gmaj7 (D7alt)"
    ],
    description: "A popular jazz standard with a memorable cycle of dominants, a favorite for bebop improvisers."
  },
  a_night_in_tunisia: {
    defaultKey: "Dm", // Often played in Dm for solos, head in Fm
    displayName: "A Night in Tunisia",
    progression: [ // Solo section (usually Dm based)
      "Eb7", "Dm7", "Eb7", "Dm7", // Vamp
      "Eb7", "Dm7", "Eb7", "Dm7",
      "Gm7", "C7", "Fmaj7", "Fmaj7", // Bridge
      "Em7b5", "A7alt", "Dm7", "A7alt"  // Turnaround
    ],
    description: "Dizzy Gillespie's Afro-Cuban jazz classic, known for its exotic melody and rhythm. (Solo changes shown)"
  },
  blue_monk: {
    defaultKey: "Bb",
    displayName: "Blue Monk",
    progression: [
      "Bb7", "Eb7", "Bb7", "Bb7",
      "Eb7", "Edim7", "Bb7 G7alt", "Cm7 F7alt",
      "Bb7 Eb7", "Bb7 F7alt", "Bb7", "Bb7 (F7alt)"
    ],
    description: "Thelonious Monk's quirky and infectious blues, a staple in jazz repertoire."
  },
  straight_no_chaser: {
    defaultKey: "F",
    displayName: "Straight, No Chaser",
    progression: [
      "F7", "Bb7", "F7", "F7",
      "Bb7", "Bdim7", "F7 D7alt", "Gm7 C7alt",
      "F7", "Gm7 C7alt", "F7", "F7 (C7alt)"
    ],
    description: "Another iconic Thelonious Monk blues, featuring his signature angular melodies and rhythmic displacement."
  },
  confirmation: {
    defaultKey: "F",
    displayName: "Confirmation",
    progression: [
      "Fmaj7", "Em7b5 A7alt", "Dm7 G7alt", "Cm7 F7",
      "Bbmaj7", "Am7 Dm7", "Gm7 C7", "Fmaj7 (Gm7 C7)",
      "Fmaj7", "Em7b5 A7alt", "Dm7 G7alt", "Cm7 F7",
      "Bbmaj7", "Am7 Dm7", "Gm7 C7", "Fmaj7 (Gm7 C7)",
      "Em7b5 A7alt", "Dm7", "Dbm7 Gb7", "Bmaj7", // Or Cbmaj7
      "Bbm7 Eb7", "Abmaj7", "Gm7 C7", "Fmaj7 (Gm7 C7)",
      "Fmaj7", "Em7b5 A7alt", "Dm7 G7alt", "Cm7 F7",
      "Bbmaj7", "Am7 Dm7", "Gm7 C7", "Fmaj7"
    ],
    description: "Charlie Parker's bebop masterpiece, a challenging and exhilarating tune for improvisers."
  },
  donna_lee: {
    defaultKey: "Ab",
    displayName: "Donna Lee",
    progression: [
      "Abmaj7", "Abmaj7", "Fm7 Bb7", "Eb7",
      "Abmaj7", "F7", "Bbm7", "Eb7",
      "Abmaj7", "Abmaj7", "Fm7 Bb7", "Eb7",
      "Abmaj7", "F7", "Bbm7", "Abmaj7 (Ebm7 Ab7)",
      "Dbmaj7", "Dbmaj7", "Dbm7 Gb7", "Bmaj7", // Or Cbmaj7
      "Bbm7 Eb7", "Abmaj7", "F7", "Bbm7 Eb7",
      "Abmaj7", "Abmaj7", "Fm7 Bb7", "Eb7",
      "Abmaj7", "F7", "Bbm7", "Abmaj7"
    ],
    description: "A quintessential bebop head attributed to Charlie Parker, based on the changes of 'Indiana'."
  },
  moments_notice: { 
    defaultKey: "Eb", // Another common key for this
    displayName: "Moment's Notice",
    progression: [ // Main 16-bar A section
      "Ebm7", "Ab7", "Dbmaj7", "Gb7",
      "Bmaj7", "Am7b5 D7b9", "Gm7", "C7b9", // Bmaj7 or Cbmaj7
      "Fm7", "Bb7", "Ebmaj7", "A7b9",
      "Dmaj7", "Am7 D7", "Gm7 C7alt", "Fm7 Bb7" // Turnaround
    ],
    description: "John Coltrane's intricate composition with rapid key center shifts, a test of harmonic navigation."
  },
  recorda_me: { 
    defaultKey: "Am",
    displayName: "Recorda Me",
    progression: [ // Main 16-bar A section
      "Am7", "Am7", "Cm7", "F7",
      "Bbmaj7", "Bbmaj7", "Ebm7", "Ab7",
      "Am7", "Am7", "Cm7", "F7",
      "Bbmaj7", "Ebm7 Ab7", "Dm7 G7", "Cmaj7 Fmaj7" // Common variation at end of form
    ],
    description: "Joe Henderson's Bossa-influenced classic, known for its smooth melody and distinctive harmony."
  },
  my_funny_valentine: {
    defaultKey: "Cm",
    displayName: "My Funny Valentine",
    progression: [
      "Cm7", "Cm(maj7)", "Cm7", "C7alt",
      "Fm7", "Bb7", "Ebmaj7", "Abmaj7 Dm7b5 G7alt",
      "Cm7", "Cm(maj7)", "Cm7", "C7alt",
      "Fm7", "Bb7", "Ebmaj7", "Abmaj7 Dm7b5 G7alt",
      "Cm7", "Cm7", "Fm7", "Fm7",
      "Bb7", "Bb7", "Ebmaj7", "Abmaj7",
      "Dm7b5", "G7alt", "Cm7", "Fm7",
      "Cm7 G7alt", "Cm7", "Cm7 G7alt", "Cm7" 
    ],
    description: "Richard Rodgers' iconic ballad, famed for its melancholic beauty and poignant lyrics."
  },
  someday_my_prince_will_come: {
    defaultKey: "Bb",
    displayName: "Someday My Prince Will Come",
    progression: [
      "Bbmaj7", "Gm7", "Cm7", "F7",
      "Ebmaj7", "Edim7", "Dm7 G7", "Cm7 F7",
      "Bbmaj7", "Gm7", "Cm7", "F7",
      "Ebmaj7", "Edim7", "Dm7 G7", "Cm7 F7",
      "Am7 D7", "Gm7 C7", "Fmaj7 A7", "Dm7 G7",
      "Cm7 F7", "Bbmaj7 D7", "Gm7 C7", "F7 Bbmaj7",
      "Bbmaj7", "Gm7", "Cm7", "F7",
      "Ebmaj7", "Edim7", "Dm7 G7", "Cm7 F7"
    ],
    description: "A charming waltz from Disney's 'Snow White,' transformed into a beloved jazz standard."
  },
  footprints: { 
    defaultKey: "Cm",
    displayName: "Footprints",
    progression: [ // 12-bar modal blues (each slot can be 1 bar of 6/4 or 2 bars of 3/4)
      "Cm11", "Cm11", "Cm11", "Cm11",
      "Fm11", "Fm11", "Cm11", "Cm11", // Often Cm11 instead of Fm11 for all 4 bars
      "D7#9#5", "D7#9#5", "Cm11", "G7alt" // Common altered dominant
    ],
    description: "Wayne Shorter's influential modal jazz composition, often played in a 6/4 feel."
  },
  in_a_sentimental_mood: {
    defaultKey: "Dm", // Common key
    displayName: "In a Sentimental Mood",
    progression: [
      "Dm7 G7", "Cmaj7 Fmaj7", "Dm7 G7", "Cmaj7 A7alt",
      "Dm7 G7", "Cmaj7 Fmaj7", "Bbmaj7 E7alt", "A7alt",
      "Dm7 G7", "Cmaj7 Fmaj7", "Dm7 G7", "Cmaj7 A7alt",
      "Dm7 G7", "Cmaj7 Fmaj7", "Bbmaj7 E7alt", "A7alt",
      "Gm7", "C7", "Fmaj7", "Fmaj7",
      "Ebm7", "Ab7", "Dbmaj7", "Gm7 C7",
      "Dm7 G7", "Cmaj7 Fmaj7", "Dm7 G7", "Cmaj7 A7alt",
      "Dm7 G7", "Cmaj7 Fmaj7", "Bbmaj7 Gm7 C7", "F6"
    ],
    description: "Duke Ellington's beautiful ballad, evoking a feeling of tender nostalgia."
  },
  dolphin_dance: { 
    defaultKey: "Eb",
    displayName: "Dolphin Dance",
    progression: [ // Main 16-bar theme
      "Eb7sus", "Ab7alt/Eb", "Dm7b5/Eb", "G7alt/Eb", 
      "Cm7", "F9sus F7b9", "Bbmaj7sus", "Bb7",
      "Ebm7", "Ab7sus Ab7", "Dbmaj7", "Am7 D7",
      "Gm7", "C7sus C7", "Fm7 Bb7", "Ebmaj7"
    ],
    description: "Herbie Hancock's sophisticated post-bop piece from 'Maiden Voyage,' with flowing, modern harmony."
  },
  oleo: { 
    defaultKey: "Bb",
    displayName: "Oleo (Rhythm Changes)",
    progression: [
      "Bbmaj7 G7", "Cm7 F7", "Bbmaj7 G7", "Cm7 F7",
      "Dm7 G7", "Cm7 F7", "Bbmaj7", "Cm7 F7",
      "Bbmaj7 G7", "Cm7 F7", "Bbmaj7 G7", "Cm7 F7",
      "Dm7 G7", "Cm7 F7", "Bbmaj7", "Bb7",
      "D7", "D7", "G7", "G7",
      "C7", "C7", "F7", "F7",
      "Bbmaj7 G7", "Cm7 F7", "Bbmaj7 G7", "Cm7 F7",
      "Dm7 G7", "Cm7 F7", "Bbmaj7", "F7" 
    ],
    description: "Sonny Rollins' classic bebop head written over the 'Rhythm Changes' progression."
  },
  there_will_never_be_another_you: {
    defaultKey: "Eb",
    displayName: "There Will Never Be Another You",
    progression: [
      "Ebmaj7", "Ebmaj7", "Fm7", "Bb7",
      "Ebmaj7", "Cm7", "F7", "Bb7",
      "Ebmaj7", "Ebmaj7", "Fm7", "Bb7",
      "Ebmaj7", "Cm7", "Fm7 Bb7", "Ebmaj7",
      "Ebm7", "Ab7", "Dbmaj7", "Dbmaj7",
      "Dbm7", "Gb7", "Bmaj7", "Bb7sus Bb7", // Bmaj7 or Cbmaj7
      "Ebmaj7", "Ebmaj7", "Fm7", "Bb7",
      "Ebmaj7", "Cm7", "Fm7 Bb7", "Ebmaj7"
    ],
    description: "A popular jazz standard by Harry Warren, loved for its beautiful melody and flowing changes."
  },
  minor_swing: {
    defaultKey: "Am",
    displayName: "Minor Swing",
    progression: [ 
      "Am", "Am", "Dm", "Dm",
      "E7", "E7", "Am", "Am",
      "Dm", "Dm", "Am", "Am",
      "E7", "E7", "Am", "E7", 
      "Am", "Am", "Dm", "Dm",
      "E7", "E7", "Am", "Am",
      "Dm", "Dm", "Am", "Am",
      "E7", "E7", "Am", "Am"
    ],
    description: "Django Reinhardt and Stéphane Grappelli's iconic Gypsy Jazz anthem, simple yet profound."
  },
  nuages: { 
    defaultKey: "G", 
    displayName: "Nuages",
    progression: [
      "G6", "G6", "Cm6", "Cm6",
      "G6", "D7", "G6", "Gdim7", 
      "G6", "G6", "Cm6", "Cm6",
      "G6", "D7", "G6", "D7",
      "Eb6", "Eb6", "Bbm6", "Bbm6",
      "G6", "E7", "Am7", "D7",
      "G6", "G6", "Cm6", "Cm6",
      "G6", "D7", "G6", "G6"
    ],
    description: "Django Reinhardt's evocative masterpiece, meaning 'Clouds,' known for its beautiful, melancholic melody."
  },
  djangology: {
    defaultKey: "G",
    displayName: "Djangology",
    progression: [
      "G6", "G6", "C6", "C6",
      "G6", "D7", "G6", "D7",
      "G6", "G6", "C6", "C6",
      "G6", "D7", "G6", "G6",
      "Am7", "D7", "G6", "E7",
      "Am7", "D7", "G6", "D7",
      "G6", "G6", "C6", "C6",
      "G6", "D7", "G6", "G6"
    ],
    description: "A lively and swinging Django Reinhardt composition, a staple of the Gypsy Jazz repertoire."
  },
  sweet_georgia_brown_gypsy: { 
    defaultKey: "Ab", 
    displayName: "Sweet Georgia Brown (Gypsy)",
    progression: [
      "Eb7", "Eb7", "Ab6", "Ab6",
      "Eb7", "Eb7", "Ab6", "Ab6",
      "Eb7", "Eb7", "Ab6", "Ab6",
      "C7", "C7", "F6", "F6",
      "C7", "C7", "F6", "F6",
      "C7", "C7", "F6", "F6",
      "C7", "C7", "F6", "F6",
      "C7", "C7", "F6", "F6"
    ],
    description: "A classic jazz tune frequently played in the Gypsy Jazz style, known for its key changes."
  },
  after_youve_gone_gypsy: {
    defaultKey: "C",
    displayName: "After You've Gone (Gypsy)",
    progression: [
      "C6", "C6", "G7", "G7",
      "C6", "C6", "G7", "G7",
      "E7", "E7", "Am", "Am",
      "D7", "D7", "G7", "G7",
      "C6", "C6", "G7", "G7",
      "C6", "C6", "G7", "G7",
      "F6", "F#dim7", "C6/G A7", "Dm7 G7", 
      "C6 Fm6", "C6 G7", "C6", "C6"
    ],
    description: "A popular early jazz standard given a vibrant treatment in the Gypsy Jazz tradition."
  },
  limehouse_blues_gypsy: {
    defaultKey: "G", // Often played in G or Ab
    displayName: "Limehouse Blues (Gypsy)",
    progression: [
      "G", "G", "C", "G",
      "D7", "D7", "G", "D7",
      "G", "G", "C", "G",
      "D7", "D7", "G", "G",
      "F", "F", "Bb", "F", // Bridge often modulates down a step
      "C7", "C7", "F", "C7",
      "G", "G", "C", "G",
      "D7", "D7", "G", "G"
    ],
    description: "A fast-paced, exciting tune with an oriental flavor, a favorite for Gypsy Jazz improvisers."
  },
  belleville_gypsy: {
    defaultKey: "D",
    displayName: "Belleville (Gypsy)",
    progression: [
      "D6", "D6", "G6", "G6",
      "D6", "A7", "D6", "A7",
      "D6", "D6", "G6", "G6",
      "D6", "A7", "D6", "D6",
      "Em7", "A7", "D6", "B7",
      "Em7", "A7", "D6", "A7",
      "D6", "D6", "G6", "G6",
      "D6", "A7", "D6", "D6"
    ],
    description: "A charming and melodic Django Reinhardt composition, named after the Parisian neighborhood."
  },
  swing_42_gypsy: {
    defaultKey: "C",
    displayName: "Swing 42 (Gypsy)",
    progression: [
      "C6", "C6", "G7", "G7",
      "G7", "G7", "C6", "C6",
      "C6", "C6", "G7", "G7",
      "G7", "G7", "C6", "C6",
      "F6", "F6", "C6", "C6",
      "D7", "D7", "G7", "G7",
      "C6", "C6", "G7", "G7",
      "G7", "G7", "C6", "C6"
    ],
    description: "A classic Django Reinhardt swing tune from 1941 (Swing '42), often played with a driving rhythm."
  },
  douce_ambiance_gypsy: {
    defaultKey: "Am", 
    displayName: "Douce Ambiance (Gypsy)",
    progression: [
      "Am6", "Dm6", "Am6", "E7",
      "Am6", "Dm6", "Am6 E7", "Am6",
      "Am6", "Dm6", "Am6", "E7",
      "Am6", "Dm6", "Am6 E7", "Am6",
      "Dm6", "G7", "Cmaj7", "Fmaj7", 
      "Bm7b5", "E7", "Am6", "E7",
      "Am6", "Dm6", "Am6", "E7",
      "Am6", "Dm6", "Am6 E7", "Am6"
    ],
    description: "Meaning 'Sweet Atmosphere,' this is a beautiful and lyrical Django Reinhardt waltz."
  },
  jattendrai_gypsy: { 
    defaultKey: "C",
    displayName: "J'attendrai (Gypsy)",
    progression: [
      "Cmaj7", "Cmaj7", "G7", "G7",
      "G7", "G7", "Cmaj7", "Cmaj7",
      "Cmaj7", "Cmaj7", "G7", "G7",
      "G7", "G7", "Cmaj7", "Cmaj7",
      "Fmaj7", "Fmaj7", "Cmaj7", "Cmaj7",
      "Dm7", "G7", "Cmaj7 G7", "Cmaj7",
      "Cmaj7", "Cmaj7", "G7", "G7",
      "G7", "G7", "Cmaj7", "Cmaj7"
    ],
    description: "A popular French song adopted into the Gypsy Jazz repertoire, known for its romantic melody."
  }
};

// ==================================
// === APPLICATION STATE ==========
// ==================================
const AppState = {
    isPlaying: false,
    currentBeat: 0,
    currentMeasure: 0,
    tempo: 120,
    audioInitialized: false,
    intervalId: null,
    lastTapTime: 0,
    tapTempoTimestamps: [],
    guideTonesActive: false,
    loopingActive: false,
    loopStartMeasure: -1,
    loopEndMeasure: -1,
    listeners: [], 

    updateState(newState) {
        Object.assign(this, newState);
        this.notifyListeners();
    },
    addListener(callback) {
        this.listeners.push(callback);
    },
    notifyListeners() {
        this.listeners.forEach(callback => callback(this));
    }
};

let currentFunctionalProgression = [];
let currentProgressionName = "";
let currentDrumSetIndex = 0;

// ==================================
// === UI MANAGEMENT & DOM ELEMENTS ===
// ==================================
const UI = {
    elements: {},
    init() {
        this.elements = {
            chordFretboardSection: document.getElementById('chord-fretboard-section'),
            metronomeSection: document.getElementById('metronome-section'),
            chordProgressionSection: document.getElementById('chord-progression-section'),
            fretflowSection: document.getElementById('fretflow-section'),
            measures: document.getElementById('measures'),
            fretboardsGrid: document.querySelector('.fretboards-grid'),
            chordFretboard: document.getElementById('chord-fretboard'),
            chordFretboardVolume: document.getElementById('chord-fretboard-volume'),
            chordTuning: document.getElementById('chord-tuning'),
            scaleDisplay: document.getElementById('scale-display'),
            nextChordDisplay: document.getElementById('next-chord-display'),
            currentSongTitleFretboard: document.getElementById('current-song-title-fretboard'),
            currentSongDescriptionFretboard: document.getElementById('current-song-description-fretboard'),
            guideTonesToggle: document.getElementById('guide-tones-toggle'),
            timeSignature: document.getElementById('time-signature'),
            soundType: document.getElementById('sound-type'),
            drumSetToggleBtn: document.getElementById('drumSetToggleBtn'),
            tempo: document.getElementById('tempo'),
            tempoDisplay: document.getElementById('tempo-display'),
            tapTempo: document.getElementById('tap-tempo'),
            startStopButton: document.getElementById('start-stop'),
            metronomeVolumeControlsStack: document.getElementById('metronome-volume-controls-stack'),
            metronomeVolume: document.getElementById('metronome-volume'),
            kickVolumeContainer: document.getElementById('kick-volume-container'),
            kickVolume: document.getElementById('kick-volume'),
            snareVolumeContainer: document.getElementById('snare-volume-container'),
            snareVolume: document.getElementById('snare-volume'),
            hihatVolumeContainer: document.getElementById('hihat-volume-container'),
            hihatVolume: document.getElementById('hihat-volume'),
            accentIntensity: document.getElementById('accent-intensity'),
            beatsContainer: document.querySelector('.beats-container'),
            progressionSelect: document.getElementById('progression-select'),
            keySelect: document.getElementById('keySelect'),
            loopSelectedToggle: document.getElementById('loop-selected-toggle'),
            userProgressionSelect: document.getElementById('user-progression-select'),
            deleteUserSongButton: document.getElementById('delete-user-song-button'),
            saveProgressionButton: document.getElementById('save-progression-button'),
            chordsEnabled: document.getElementById('chordsEnabled'),
            chordVolume: document.getElementById('chord-volume'),
            reverbDial: document.getElementById('reverb-dial'),
            reverbDialValue: document.getElementById('reverb-dial-value'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            loadingIndicator: document.getElementById('loading-indicator'),
            // NEW placeholders for global controls (optional to add here if not immediately used by JS)
            swingToggle: document.getElementById('swing-toggle'),
            noteNamingConvention: document.getElementById('note-naming-convention'),
        };
        Object.entries(this.elements).forEach(([key, element]) => {
            if (!element && !['currentSongTitle', 'currentSongDescription', 'swingToggle', 'noteNamingConvention'].includes(key)) {
                 console.warn(`[UI Init] Missing DOM element: ${key}`);
            }
        });
        log("UI elements cached.");
    }
};

// ==================================
// === MUSIC THEORY HELPERS =======
// ==================================
function transposeChordData(chordData, originalSongKeyRoot, targetGlobalKeyRoot) {
    // console.log(`TRANSPOSE CALL: chordData=${JSON.stringify(chordData)}, origKeyRoot=${originalSongKeyRoot}, targetKeyRoot=${targetGlobalKeyRoot}`);
    const originalKeyRootIndex = NOTES_CHROMATIC.indexOf(standardizeNoteName(originalSongKeyRoot));
    const targetKeyRootIndex = NOTES_CHROMATIC.indexOf(standardizeNoteName(targetGlobalKeyRoot));
    if (originalKeyRootIndex === -1 || targetKeyRootIndex === -1) {
        console.error(`Invalid key for transposition: Original '${originalSongKeyRoot}', Target '${targetGlobalKeyRoot}'. Returning original chord.`);
        return { ...chordData };
    }
    const transpositionInterval = (targetKeyRootIndex - originalKeyRootIndex + 12) % 12;
    const originalChordRootIndex = NOTES_CHROMATIC.indexOf(standardizeNoteName(chordData.root));
    if (originalChordRootIndex === -1) {
        console.error(`Invalid original chord root for transposition: '${chordData.root}'. Returning original chord.`);
        return { ...chordData };
    }
    const transposedChordRootIndex = (originalChordRootIndex + transpositionInterval + 12) % 12;
    const transposedRoot = NOTES_CHROMATIC[transposedChordRootIndex];
    // console.log(`  -> transpositionInterval=${transpositionInterval}, origChordRootIdx=${originalChordRootIndex}, transposedChordRootIdx=${transposedChordRootIndex}, transposedRoot=${transposedRoot}`);
    return { root: transposedRoot, quality: chordData.quality };
}  
        
function standardizeNoteName(note) {
    if (!note || typeof note !== 'string') return '';
    let standardized = note.trim().replace('♭', 'b').replace('♯', '#');
    if (standardized === "Bbb" || standardized === "bbb") return "A";
    if (standardized === "E##" || standardized === "e##") return "Gb";
    if (standardized === "B##" || standardized === "b##") return "Db";
    standardized = standardized.toUpperCase();
    const sharpToFlatMap = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
    if (sharpToFlatMap[standardized]) {
        return sharpToFlatMap[standardized];
    }
    const foundNote = NOTES_CHROMATIC.find(n_chromatic => n_chromatic.toUpperCase() === standardized);
    if (foundNote) return foundNote;
    if (NOTES_CHROMATIC.includes(note.charAt(0).toUpperCase() + note.slice(1))) {
        return note.charAt(0).toUpperCase() + note.slice(1);
    }
    return standardized;
}

function standardizeNoteNameForSamples(note) {
    const stdNote = standardizeNoteName(note);
    return SAMPLE_NOTE_MAP[stdNote] || SAMPLE_NOTE_MAP[note.toUpperCase()] || note.toLowerCase();
}

function getStandardQuality(rawQualityInput) {
    if (!rawQualityInput || typeof rawQualityInput !== 'string') return 'maj7';
    let quality = rawQualityInput.toLowerCase().trim();
    quality = quality.split('/')[0].trim();
    if (quality === 'alt' || quality === '7alt') return 'alt';
    if (quality === '7b9' || quality === 'dom7b9') return 'dom7b9';
    if (quality === '7#9' || quality === 'dom7#9') return 'dom7#9';
    if (quality === '7b5' || quality === 'dom7b5') return 'dom7b5';
    if (quality === '7sus' || quality === '7sus4' || quality === 'dom7sus') return 'dom7sus';
    if (quality === 'imaj7' || quality === 'm(maj7)' || quality === 'minmaj7' || quality === 'mmaj7') return 'imaj7';
    if (quality === 'm7b5' || quality === 'min7b5' || quality === 'ø' || quality === 'mi7b5' || quality.startsWith('m7b5')) return 'min7b5';
    if (quality === 'dim7' || quality === '°7' || (quality.startsWith('dim') && quality.includes('7'))) return 'dim7';
    if (quality === 'maj7' || quality === 'ma7' || quality === 'Δ' || quality.startsWith('maj7') || quality.startsWith('ma7')) return 'maj7';
    if (quality === '7' || quality === 'dom7' || quality === 'dom' || (quality.startsWith('7') && !quality.startsWith('7b') && !quality.startsWith('7#') && !quality.startsWith('7s'))) return 'dom7';
    if (quality === 'm7' || quality === 'min7' || quality === 'mi7' || quality.startsWith('m7') || quality.startsWith('min7')) return 'min7';
    if (quality === 'maj6' || quality === 'ma6' || quality === '6' || quality.startsWith('maj6') || quality.startsWith('ma6')) return 'maj6';
    if (quality === 'm6' || quality === 'min6' || quality === 'mi6' || quality.startsWith('m6') || quality.startsWith('min6')) return 'min6';
    if (quality === '6/9' || quality.startsWith('6/9')) return 'maj6';
    if (quality === 'maj' || quality === '') return 'maj';
    if (quality === 'm' || quality === 'min' || quality === 'mi') return 'min';
    if (quality === 'dim' || quality === '°') return 'dim';
    if (quality === 'aug' || quality === '+') return 'aug';
    if (quality === 'sus4' || quality === 'sus') return 'sus4';
    if (quality === 'sus2') return 'sus2';
    if (CHORD_INTERVALS[rawQualityInput]) return rawQualityInput;
    if (CHORD_INTERVALS[quality]) return quality;
    console.warn(`getStandardQuality: Unstandardized quality "${rawQualityInput}". Defaulting to 'maj7'.`);
    return 'maj7';
}

function parseChord(chordString) {
    if (typeof chordString !== 'string' || !chordString.trim()) {
        return null;
    }
    chordString = chordString.trim();
    const match = chordString.match(/^([A-G][#b]?)(.*)$/);
    if (!match) {
        return null;
    }
    const root = standardizeNoteName(match[1]);
    const qualityString = match[2].trim(); 
    const quality = getStandardQuality(qualityString);
    return { root: root, quality: quality, originalString: chordString };
}

function parseRomanNumeralToAbsoluteChord(romanString, key) {
    const isMinorKey = key.includes('m');
    const normalizedKeyRoot = standardizeNoteName(key.replace('m', ''));
    const keyRootIndex = NOTES_CHROMATIC.indexOf(normalizedKeyRoot);
    if (keyRootIndex === -1) {
        console.error(`Invalid key for Roman numeral parsing: ${key}`);
        return { root: 'C', quality: 'maj7', originalRoman: romanString };
    }
    const firstChordInSplit = romanString.split('/')[0].trim();
    const absoluteChordAttempt = parseChord(firstChordInSplit);
    if (absoluteChordAttempt && absoluteChordAttempt.root && CHORD_INTERVALS[absoluteChordAttempt.quality]) {
        return { ...absoluteChordAttempt, originalRoman: romanString };
    }
    const romanMatch = firstChordInSplit.match(/^(b|#)?([IViv]+)(.*)$/);
    if (!romanMatch) {
        console.warn(`Could not parse Roman numeral or absolute chord: "${firstChordInSplit}" in key ${key}. Assuming Imaj7 of key.`);
        return { root: normalizedKeyRoot, quality: 'maj7', originalRoman: romanString };
    }
    const accidental = romanMatch[1];
    const numeral = romanMatch[2];
    let qualitySuffix = romanMatch[3].trim();
    const majorScaleIntervals = { 'I': 0, 'II': 2, 'III': 4, 'IV': 5, 'V': 7, 'VI': 9, 'VII': 11 };
    const minorScaleIntervals = { 'i': 0, 'ii': 2, 'III': 3, 'iv': 5, 'v': 7, 'VI': 8, 'VII': 10 };
    let degreeInterval;
    const isUpperCaseNumeral = numeral === numeral.toUpperCase();
    if (isMinorKey) {
        degreeInterval = minorScaleIntervals[numeral.toLowerCase()];
        if (isUpperCaseNumeral && numeral.toLowerCase() === 'v') degreeInterval = majorScaleIntervals['V'];
        if (isUpperCaseNumeral && numeral.toLowerCase() === 'iv') degreeInterval = majorScaleIntervals['IV'];
    } else {
        degreeInterval = majorScaleIntervals[numeral.toUpperCase()];
    }
    if (degreeInterval === undefined) {
        console.warn(`Unknown Roman numeral base: ${numeral} in "${firstChordInSplit}". Assuming I of key.`);
        return { root: normalizedKeyRoot, quality: 'maj7', originalRoman: romanString };
    }
    let chordRootIndex = (keyRootIndex + degreeInterval) % 12;
    if (accidental === 'b') chordRootIndex = (chordRootIndex - 1 + 12) % 12;
    else if (accidental === '#') chordRootIndex = (chordRootIndex + 1) % 12;
    const chordRoot = NOTES_CHROMATIC[chordRootIndex];
    let finalQuality = getStandardQuality(qualitySuffix);
    if (!qualitySuffix) {
        if (numeral.toLowerCase() === 'v' && (isMinorKey || !qualitySuffix)) {
            finalQuality = 'dom7';
        } else if (numeral.toLowerCase() === 'vii' && !isUpperCaseNumeral) {
            finalQuality = 'min7b5';
        } else {
            finalQuality = isUpperCaseNumeral ? 'maj7' : 'min7';
        }
    } else if (!CHORD_INTERVALS[finalQuality]) {
        console.warn(`Quality suffix "${qualitySuffix}" for Roman ${firstChordInSplit} not fully resolved. Defaulting based on numeral.`);
        finalQuality = isUpperCaseNumeral ? 'maj7' : 'min7';
    }
    return { root: chordRoot, quality: finalQuality, originalRoman: romanString };
}

function getChordNotes(root, quality) {
    let intervals = CHORD_INTERVALS[quality];
    if (!intervals) {
        console.warn(`Quality "${quality}" for root "${root}" not found. Defaulting to dom7 intervals.`);
        intervals = CHORD_INTERVALS['dom7'];
    }
    const standardizedRoot = standardizeNoteName(root);
    const rootIndex = NOTES.indexOf(standardizedRoot);
    if (rootIndex === -1) {
        console.error(`Invalid root note for getChordNotes: ${root}`);
        return [standardizedRoot];
    }
    return intervals.map(interval => NOTES[(rootIndex + interval + 12) % 12]);
}

function suggestScaleForQuality(quality) {
    const scaleMap = {
        'maj7': 'major', 'maj': 'major', 'maj6': 'major', 'maj9': 'major',
        'dom7': 'mixolydian', 'dom9': 'mixolydian', 'dom7b9': 'diminishedWH',
        'dom7#9': 'altered', 'alt': 'altered', 'dom7sus': 'mixolydian',
        'min7': 'dorian', 'min': 'dorian', 'min9': 'dorian', 'min6': 'dorian',
        'min7b5': 'locrian', 'dim7': 'diminishedWH',
        'imaj7': 'melodicMinor',
    };
    return scaleMap[quality] || 'major';
}

// ... (Rest of Music Theory Helpers, Chord Voicing, DOM Utilities, Audio Management (ensure AudioContextManager is complete)) ...
// --- PASTE THE FULL AudioContextManager OBJECT HERE (from previous steps, it's quite long) ---
AudioContextManager.initialize = async function() {
    if (this.context && this.context.state !== 'closed') {
        return this.context;
    }
    try {
        this.context = new (window.AudioContext || window.webkitAudioContext)();
        log("AudioContext created/resumed.");
        updateLoadingStatus("Loading essential sounds...", true);
        await this.loadInitialSounds(); 
        AppState.audioInitialized = true;
        log("AudioContextManager initial sounds loaded.");
        await this.setupReverb();

        if (this.context.state === 'suspended') {
            await this.context.resume(); 
            log("AudioContext resumed from suspended state.");
        }
        setTimeout(() => this.loadSecondarySounds(), 100);

    } catch (error) {
        console.error("Error initializing AudioContextManager:", error);
        alert("Failed to initialize audio. Please ensure your browser supports Web Audio API and allow autoplay if prompted.");
        AppState.audioInitialized = false;
        throw error; 
    }
    return this.context;
};
AudioContextManager.ensureAudioContext = async function() {
    if (!this.context || this.context.state === 'suspended') {
        return await this.initialize();
    }
    if (this.context.state === 'closed') {
        console.warn("AudioContext was closed, attempting to re-initialize.");
        return await this.initialize();
    }
    return this.context;
};
AudioContextManager.loadInitialSounds = async function() {
    try {
        const response = await fetch('./Click.wav');
        if (!response.ok) throw new Error(`HTTP error ${response.status} for Click.wav`);
        const arrayBuffer = await response.arrayBuffer();
        this.soundBuffers['click'] = await this.context.decodeAudioData(arrayBuffer);
        log("Successfully loaded Click.wav");
    } catch (e) {
        console.error("Failed to load Click.wav:", e);
        this.soundBuffers['click'] = await this.createDrumSound('click'); 
        log("Using synthetic fallback for click sound.");
    }
    await this.loadPianoSamplesSpecific(PLAYBACK_OCTAVES);
    this.samplesLoaded = Object.keys(this.pianoSampleBuffers).length > 0;
    if (this.samplesLoaded) {
        log(`Initial piano samples (Octaves ${PLAYBACK_OCTAVES.join(',')}) loaded.`);
    } else {
        console.warn(`Initial piano samples (Octaves ${PLAYBACK_OCTAVES.join(',')}) failed to load any samples.`);
    }
};
AudioContextManager.loadSecondarySounds = async function() {
    if (this.secondaryLoadStarted) return;
    this.secondaryLoadStarted = true;
    log("Starting secondary background sound loading...");
    updateLoadingStatus("Loading additional sounds...", true);

    const loadPromises = [];
    const soundsToLoad = {
        'woodblock': 'woodblock.wav', 'hihat': 'HiHat.wav', 
        'kick': 'Kick.wav', 'snare': 'Snare.wav'
    };
    for (let [type, filename] of Object.entries(soundsToLoad)) {
        if (!this.soundBuffers[type]) { 
            loadPromises.push(this.loadSingleSound(type, filename));
        }
    }
    const remainingOctaves = OCTAVES_FOR_SAMPLES.filter(o => !PLAYBACK_OCTAVES.includes(o));
    if (remainingOctaves.length > 0) {
        loadPromises.push(this.loadPianoSamplesSpecific(remainingOctaves));
    }
    await Promise.allSettled(loadPromises);
    log("Secondary background sound loading complete.");
    updateLoadingStatus("All sounds loaded.", true);
    setTimeout(() => updateLoadingStatus("", false), 1500);
};
AudioContextManager.loadSingleSound = async function(type, filename) {
    try {
        const response = await fetch(`./${filename}`);
        if (!response.ok) throw new Error(`HTTP error ${response.status} for ${filename}`);
        const arrayBuffer = await response.arrayBuffer();
        this.soundBuffers[type] = await this.context.decodeAudioData(arrayBuffer);
        log(`Successfully loaded secondary sound: ${filename}`);
    } catch (e) {
        console.error(`Failed to load secondary sound ${filename}:`, e);
        this.soundBuffers[type] = await this.createDrumSound(type); 
        log(`Using synthetic fallback for secondary sound: ${type}`);
    }
};
AudioContextManager.loadPianoSamplesSpecific = async function(octavesToLoad) {
    let loadedCount = 0;
    const promises = [];
    for (const note of ALL_NOTES_FOR_SAMPLES) { 
        for (const octave of octavesToLoad) {
            if (!OCTAVES_FOR_SAMPLES.includes(octave)) continue; 
            const sampleKey = `${note}${octave}`;
            if (this.pianoSampleBuffers[sampleKey]) continue; 

            const filename = getSampleFileName(note, octave);
            promises.push(
                fetch(filename)
                    .then(response => {
                        if (!response.ok) return Promise.reject(new Error(`HTTP error ${response.status} for ${filename}`));
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => this.context.decodeAudioData(arrayBuffer))
                    .then(buffer => {
                        this.pianoSampleBuffers[sampleKey] = buffer;
                        loadedCount++;
                    })
                    .catch(error => { /* console.warn(`Failed to load piano sample: ${filename}`, error.message); */ })
            );
        }
    }
    await Promise.allSettled(promises);
    if (loadedCount > 0) {
        log(`Loaded ${loadedCount} new piano samples for octaves: [${octavesToLoad.join(', ')}]`);
    }
    this.samplesLoaded = Object.keys(this.pianoSampleBuffers).length > 0;
};
AudioContextManager.createDrumSound = async function(type) { 
    const sampleRate = this.context.sampleRate;
    const duration = type === 'hihat' ? 0.05 : 0.2; 
    const buffer = this.context.createBuffer(1, sampleRate * duration, sampleRate);
    const data = buffer.getChannelData(0);
    let x;
    switch (type) {
        case 'click': 
            for (let i = 0; i < data.length; i++) data[i] = Math.sin(i * 0.05) * Math.exp(-i * 0.01);
            break;
        case 'hihat': 
            for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (sampleRate * 0.01));
            break;
        case 'kick': 
            for (let i = 0; i < data.length; i++) {
                x = i / sampleRate;
                data[i] = Math.sin(2 * Math.PI * 100 * Math.exp(-x * 5) * x) * Math.exp(-x * 10) * 2; 
            }
            break;
        case 'snare': 
             for (let i = 0; i < data.length; i++) {
                x = i / sampleRate;
                data[i] = ((Math.random() * 2 - 1) + Math.sin(2 * Math.PI * 200 * x)) * Math.exp(-x * 10) * 1.5;
            }
            break;
        case 'woodblock': 
            for (let i = 0; i < data.length; i++) {
                x = i / sampleRate;
                data[i] = Math.sin(2 * Math.PI * 800 * x) * Math.exp(-x * 20);
            }
            break;
        default: 
            for (let i = 0; i < data.length; i++) data[i] = Math.sin(i * 0.05) * Math.exp(-i * 0.01);
    }
    return buffer;
};
AudioContextManager.setupReverb = async function() {
    if (!this.context) return;
    if (!this.reverbNode) {
        try {
            this.reverbNode = this.context.createConvolver();
            const sampleRate = this.context.sampleRate;
            const length = sampleRate * 2.5; 
            const impulse = this.context.createBuffer(2, length, sampleRate);
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2.5); 
                }
            }
            this.reverbNode.buffer = impulse;
            log("Reverb node created with synthetic impulse response.");

            if (this.context.destination && !this.reverbNodeConnected) {
                 this.reverbNode.connect(this.context.destination);
                 this.reverbNodeConnected = true;
                 log("Reverb node connected to destination.");
            }
        } catch (e) {
            console.error("Failed to create reverb node:", e);
            this.reverbNode = null; 
        }
    }
};


// ... (Audio Playback functions: playNote, playChord, playMetronomeSound) ...
// ... (Fretboard UI functions: createFretboard, updateFretboardNotes) ...
// ... (Metronome UI & Logic: createBeats, toggleBeatAccent, onMetronomeInstrumentChange) ...
// ... (Playback Engine: playBeat, startPlayback, stopPlayback) ...

// ==================================
// === PROGRESSION MANAGEMENT =====
// ==================================
// (Make sure loadProgression, updateProgressionKey, saveCurrentProgression are the versions with transposition logic)
// (And ensure createMeasurePartHTML, addMeasure, toggleSplitMeasure, removeMeasure, updateMeasureNumbers, handleMeasureControlChange are present)
// (And User Progression Save/Load: isUserSongCurrentlyLoaded, populateUserSongsDropdown, deleteSelectedUserSong)
// (And Looper Functionality: toggleMeasureLoopSelection, resetLoop, toggleLoopingMode)
// (And Guide Tones: toggleGuideTones, highlightGuideTones, clearGuideToneHighlights)
// (And FretFlow: initializeFretFlow)

// ==================================
// === EVENT LISTENERS SETUP ======
// ==================================
// ... (addFirstChordListener) ...

function setupEventListeners() {
    document.body.addEventListener('click', ensureAudioInitializedUserInteraction, { once: true });

    UI.elements.startStopButton.addEventListener('click', () => AppState.isPlaying ? stopPlayback() : startPlayback());
    UI.elements.drumSetToggleBtn?.addEventListener('click', () => {
        currentDrumSetIndex = (currentDrumSetIndex + 1) % drumSoundSets.length;
        UI.elements.drumSetToggleBtn.textContent = drumSoundSets[currentDrumSetIndex].name;
        log(`Drum set: ${drumSoundSets[currentDrumSetIndex].name}`);
    });
    UI.elements.soundType?.addEventListener('change', (e) => onMetronomeInstrumentChange(e.target.value));
    
    let currentDarkModeIndex = 0;
    const darkModeClasses = ['', 'dark-mode', 'dark-mode-2', 'dark-mode-3'];
    const activeToggleClasses = ['', 'active', 'active-2', 'active-3'];
    UI.elements.darkModeToggle.addEventListener('click', () => {
        currentDarkModeIndex = (currentDarkModeIndex + 1) % darkModeClasses.length;
        darkModeClasses.forEach(cls => { if (cls) document.body.classList.remove(cls); });
        activeToggleClasses.forEach(cls => { if (cls) UI.elements.darkModeToggle.classList.remove(cls); });
        if (currentDarkModeIndex > 0) {
            document.body.classList.add(darkModeClasses[currentDarkModeIndex]);
            UI.elements.darkModeToggle.classList.add(activeToggleClasses[currentDarkModeIndex]);
        }
        log(`Color mode: ${darkModeClasses[currentDarkModeIndex] || 'Light Mode'}`);
    });

    UI.elements.chordsEnabled.addEventListener('click', () => {
        const isActive = UI.elements.chordsEnabled.classList.toggle('active');
        UI.elements.chordsEnabled.textContent = isActive ? 'Chords Enabled' : 'Chords Disabled';
        log(`Chords ${isActive ? 'enabled' : 'disabled'}`);
    });

    UI.elements.tempo.addEventListener('input', () => {
        AppState.tempo = parseInt(UI.elements.tempo.value);
        UI.elements.tempoDisplay.textContent = `${AppState.tempo} BPM`;
        if (AppState.isPlaying) { stopPlayback(); startPlayback(); }
    });

    UI.elements.tapTempo.addEventListener('click', () => {
        const now = Date.now();
        AppState.tapTempoTimestamps.push(now);
        if (AppState.tapTempoTimestamps.length > 4) AppState.tapTempoTimestamps.shift();
        if (AppState.tapTempoTimestamps.length > 1) {
            let totalInterval = 0;
            for (let i = 1; i < AppState.tapTempoTimestamps.length; i++) totalInterval += AppState.tapTempoTimestamps[i] - AppState.tapTempoTimestamps[i-1];
            const avgInterval = totalInterval / (AppState.tapTempoTimestamps.length - 1);
            if (avgInterval > 0 && avgInterval < 3000) { // Avoid division by zero or extreme values
                AppState.tempo = Math.max(40, Math.min(220, Math.round(60000 / avgInterval)));
                UI.elements.tempo.value = AppState.tempo;
                UI.elements.tempoDisplay.textContent = `${AppState.tempo} BPM`;
                if (AppState.isPlaying) { stopPlayback(); startPlayback(); }
            }
        }
        // Clear timestamps if no tap for a while
        setTimeout(() => { 
            if (AppState.tapTempoTimestamps.length > 0 && (Date.now() - AppState.tapTempoTimestamps[AppState.tapTempoTimestamps.length - 1] > 3000)) {
                AppState.tapTempoTimestamps = []; 
            }
        }, 3100);
    });

    UI.elements.timeSignature.addEventListener('change', () => {
        createBeats();
        const is44 = parseInt(UI.elements.timeSignature.value) === 4;
        document.querySelectorAll('.measure .split-measure-button').forEach(btn => {
            btn.disabled = !is44;
            btn.title = is44 ? "" : "Splitting only available in 4/4.";
            if (!is44 && btn.closest('.measure').dataset.isSplit === 'true') {
                toggleSplitMeasure(btn.closest('.measure')); 
            }
        });
        if (AppState.isPlaying) { stopPlayback(); startPlayback(); }
    });

    UI.elements.reverbDial?.addEventListener('input', (e) => {
        AudioContextManager.reverbAmount = parseInt(e.target.value, 10) / 100;
        UI.elements.reverbDialValue.textContent = e.target.value;
        log(`Reverb: ${AudioContextManager.reverbAmount}`);
    });

    UI.elements.progressionSelect.addEventListener('change', (e) => {
        loadProgression(e.target.value, null, false);
        if (UI.elements.userProgressionSelect) UI.elements.userProgressionSelect.value = "";
    });
    UI.elements.userProgressionSelect?.addEventListener('change', (e) => {
        if (e.target.value) {
            const userSongs = JSON.parse(localStorage.getItem('userBebopProgressions') || '{}');
            const selectedSongData = userSongs[e.target.value];
            loadProgression(e.target.value, selectedSongData?.defaultKey || UI.elements.keySelect.value, true);
            if (UI.elements.progressionSelect) UI.elements.progressionSelect.value = ""; // Clear standard progression select
        }
    });
    UI.elements.keySelect.addEventListener('change', (e) => updateProgressionKey(e.target.value));
    UI.elements.chordTuning.addEventListener('change', () => { addFirstChordListener(); initializeFretFlow(); });
    UI.elements.saveProgressionButton?.addEventListener('click', saveCurrentProgression);
    UI.elements.deleteUserSongButton?.addEventListener('click', deleteSelectedUserSong);
    UI.elements.guideTonesToggle?.addEventListener('click', toggleGuideTones);
    UI.elements.loopSelectedToggle?.addEventListener('click', toggleLoopingMode);

    // NEW: Event Listeners for Collapsible Sections
    document.querySelectorAll('.collapsible-toggle').forEach(button => {
        button.addEventListener('click', () => {
            const contentId = button.getAttribute('aria-controls');
            const content = document.getElementById(contentId);
            const isExpanded = button.getAttribute('aria-expanded') === 'true' || false;

            button.setAttribute('aria-expanded', !isExpanded);
            content.style.display = isExpanded ? 'none' : (contentId === 'metronome-volume-controls-stack' ? 'flex' : 'block'); // adjust display based on content
            button.querySelector('.toggle-icon').textContent = isExpanded ? '+' : '-';
            log(`Collapsible ${contentId} ${isExpanded ? 'collapsed' : 'expanded'}`);
        });
    });


    document.addEventListener('keydown', (event) => {
        const targetTagName = event.target.tagName.toLowerCase();
        if (['input', 'select', 'textarea'].includes(targetTagName)) return;
        let tempoChanged = false;
        switch (event.key) {
            case ' ': event.preventDefault(); UI.elements.startStopButton.click(); break;
            case 'ArrowUp':
                event.preventDefault();
                UI.elements.tempo.value = AppState.tempo = Math.min(220, parseInt(UI.elements.tempo.value) + 1);
                tempoChanged = true; break;
            case 'ArrowDown':
                event.preventDefault();
                UI.elements.tempo.value = AppState.tempo = Math.max(40, parseInt(UI.elements.tempo.value) - 1);
                tempoChanged = true; break;
        }
        if (tempoChanged) {
            UI.elements.tempoDisplay.textContent = `${AppState.tempo} BPM`;
            if (AppState.isPlaying) { stopPlayback(); startPlayback(); }
        }
    });
    log("Event listeners set up.");
}

// ==================================
// === INITIALIZATION =============
// ==================================
async function initializeApp() {
    UI.init(); 
    
    createBeats();
    const initialTuning = TUNINGS[UI.elements.chordTuning?.value || 'standard'] || TUNINGS.standard;
    createFretboard(UI.elements.chordFretboard, initialTuning);
    onMetronomeInstrumentChange(UI.elements.soundType?.value || 'click');
    populateUserSongsDropdown();

    const initialProgressionName = UI.elements.progressionSelect?.value || "I V7"; // Default to a simple one
    const initialProgData = progressions[initialProgressionName] || {};
    const initialKey = UI.elements.keySelect?.value || initialProgData.defaultKey || "C";
    loadProgression(initialProgressionName, initialKey, false);

    initializeFretFlow();
    setupEventListeners(); // This now includes collapsible setup

    try {
        await AudioContextManager.initialize();
    } catch (e) {
        updateLoadingStatus("Audio initialization failed. Click screen to retry.", true);
        document.body.addEventListener('click', async function retryAudioInit() {
            document.body.removeEventListener('click', retryAudioInit);
            updateLoadingStatus("Retrying audio initialization...", true);
            try {
                await AudioContextManager.initialize();
                updateLoadingStatus("Audio initialized!", true);
                setTimeout(() => updateLoadingStatus("", false), 1500);
            } catch (err) {
                updateLoadingStatus("Audio retry failed. Please refresh or check browser settings.", true);
                 console.error("Audio retry failed:", err);
            }
        }, { once: true });
    }

    if (AppState.audioInitialized) {
        updateLoadingStatus("Application initialized.", true);
        setTimeout(() => updateLoadingStatus("", false), 1500);
    }
    log("Application initialized.");
}

document.addEventListener('DOMContentLoaded', () => {
    initializeApp().catch(error => {
        console.error("Application initialization failed:", error);
        updateLoadingStatus("Fatal Error: App could not initialize. Check console.", true);
    });
});

    </script>
</body>
