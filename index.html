<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bebop Blueprint</title>
    <link rel="icon" type="image/png" href="jazzmaster.png">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lato', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0; /* Lighter default background */
        }
        .app-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .fretboards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .fretboard-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .scale-display {
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px; /* Reduced margin */
            color: #333;
             min-height: 1.5em; /* Reserve space */
        }
         /* Next Chord Display Styling */
         .next-chord-display {
            font-size: 0.95em; /* Slightly smaller than scale display */
            font-style: italic;
            text-align: center;
            color: #6c757d; /* Muted gray color */
            margin-top: -5px; /* Pull it up slightly */
            margin-bottom: 15px; /* Space below before controls */
            height: 1.2em; /* Reserve space to prevent layout shift */
            line-height: 1.2em;
        }
        .controls, .top-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        .controls-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .control-group { display: flex; align-items: center; gap: 10px; }
        .control-group label { font-weight: bold; }
        .control-group select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }

        .fretboard { position: relative; height: 200px; background-color: #FFCF79; border-radius: 5px; margin-bottom: 30px; border: 2px solid #4A3B31; overflow: visible; }
        .fret-line { position: absolute; top: 0; height: 100%; width: 2px; background: #A0A0A0; border-right: 1px solid rgba(0,0,0,0.1); z-index: 1; }
        .string-line { position: absolute; left: 0; width: 100%; height: 1px; background: #C0C0C0; border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 0; }
        .fret-number { position: absolute; bottom: -25px; font-size: 14px; color: #555; transform: translateX(-50%); font-weight: bold; z-index: 2; width: 20px; text-align: center; }
        .fret-marker { position: absolute; width: 10px; height: 10px; background-color: #5A4F46; border-radius: 50%; transform: translate(-50%, -50%); z-index: 1; }
        .note { position: absolute; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color: white; z-index: 3; cursor: pointer; transform: translate(-50%, -50%); transition: transform 0.1s ease, box-shadow 0.1s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .note.guide-tone-highlight { box-shadow: 0 0 0 3px orange, 0 1px 3px rgba(0,0,0,0.2); }
        .note:hover { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        .beat { width: 40px; height: 80px; background: #9E9E9E; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: white; font-weight: bold; transition: all 0.2s ease; font-size: 14px; margin: 0 2px; }
        .beats-container { display: flex; justify-content: center; gap: 8px; margin: 20px 0; flex-wrap: nowrap; overflow-x: auto; }
        .beat.active { transform: translateY(-10px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        #measures { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .measure { position: relative; background-color: #e9ecef; padding: 15px; border-radius: 4px; transition: opacity 0.2s ease, background-color 0.2s ease, border 0.2s ease; border: 2px solid transparent; cursor: pointer; }
        .measure.loop-selected { border: 2px solid #007bff; background-color: #e6f2ff; }
        .measure.active { background-color: #c3e6cb; border: 2px solid #28a745; }
        .measure-number { position: absolute; top: 5px; left: 5px; font-size: 12px; color: #333; background-color: rgba(255,255,255,0.7); padding: 2px 4px; border-radius: 3px; }
        .chord-controls, .scale-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .chord-controls select, .scale-controls select { flex: 1; }

        .fretboard-section { border: 1px solid #ccc; padding: 15px; border-radius: 8px; background-color: #f9f9f9; }
        body.dark-mode .fretboard-section { background-color: #3a441e; border-color: #606c38; color: #fefae0; }
        body.dark-mode-2 .fretboard-section { background-color: #001f54; border-color: #1282a2; color: #fefcfb; }
        body.dark-mode-3 .fretboard-section { background-color: #a5a58d; border-color: #cb997e; color: #ffe8d6; }
        .fretboard-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .control-group label { font-weight: bold; font-size: 0.9em; }
        .control-group select { padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
        @media (max-width: 1200px) { /* #measures grid-template-columns already responsive */ }
        @media (max-width: 600px) { /* #measures grid-template-columns already responsive */ }
        .volume-control { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
        button, .button-like { padding: 10px 15px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
        button:hover, .button-like:hover { background: #45a049; }
        button.secondary { background-color: #007bff; }
        button.secondary:hover { background-color: #0056b3; }
        button.danger { background-color: #dc3545; color: white;} /* Changed default danger color */
        button.danger:hover { background-color: #c82333; }
        select { padding: 8px 10px; margin: 5px; border-radius: 5px; border: 1px solid #ddd; background-color: white; }
        #tempo-display { font-size: 1.2em; font-weight: bold; margin: 0 10px; min-width: 70px; text-align: center; }
        #loading-indicator { position: fixed; top: 20px; right: 20px; padding: 10px 15px; background: rgba(0,0,0,0.8); color: white; border-radius: 5px; z-index: 1000; font-size: 0.9em; display: none; }
        .checkbox-wrapper { margin-top: 10px; margin-left: 0; display: flex; align-items: center; }
        .control-button { padding: 8px 12px; font-size: 0.9em; }
        #chordsEnabled { margin-bottom: 10px; }
        body.dark-mode { background-color: #283618; color: #fefae0; }
        .dark-mode .app-section { background: linear-gradient(145deg, #283618, #606c38); color: #fefae0; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .dark-mode .fretboard-container { background-color: #606c38; border: 1px solid #dda15e; }
        .dark-mode .fretboard { background-color: #dda15e; border: 2px solid #4b4b4b; }
        .dark-mode .note { color: #283618; }
        .dark-mode .scale-display { color: #fefae0; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .dark-mode button, .dark-mode .button-like { background-color: #dda15e; color: #283618; border: 1px solid #bc6c25; }
        .dark-mode button:hover, .dark-mode .button-like:hover { background-color: #bc6c25; }
        .dark-mode button.secondary { background-color: #a17d40; }
        .dark-mode button.secondary:hover { background-color: #8a6930; }
        .dark-mode button.danger { background-color: #e44d5a; color: white;}
        .dark-mode button.danger:hover { background-color: #d73744; }
        .dark-mode select { background-color: #dda15e; color: #283618; border: 1px solid #bc6c25; }
        .dark-mode select:hover { background-color: #bc6c25; }
        .dark-mode .measure { background-color: #606c38; color: #fefae0; border: 1px solid #dda15e; }
        .dark-mode .measure.active { background-color: #dda15e; border-color: #bc6c25; }
        .dark-mode .measure.loop-selected { border-color: #ffc107; background-color: #7d6830; }
        .dark-mode .beat { background-color: #dda15e; color: #283618; }
        .dark-mode .beat.active { background-color: #bc6c25; transform: translateY(-5px); }
        .dark-mode .volume-control, .dark-mode .next-chord-display { color: #fefae0; }
        .dark-mode #current-song-title { color: #fefae0; }
        .dark-mode #current-song-description { color: #e0daca; }
        .dark-mode #song-info-display { background-color: #4a542e; border-color: #7a845e; }
        #dark-mode-toggle.active { background-color: #283618; color: #fefae0; border: 1px solid #dda15e; }

        .dark-mode-2 { background-color: #0a1128; color: #fefcfb; }
        .dark-mode-2 .app-section { background: linear-gradient(145deg, #001f54, #034078); color: #fefcfb; }
        .dark-mode-2 .fretboard-container { background-color: #034078; border: 1px solid #1282a2; }
        .dark-mode-2 .fretboard { background-color: #001f54; border: 2px solid #1282a2; }
        .dark-mode-2 .note { color: #fefcfb; }
        .dark-mode-2 .scale-display { color: #fefcfb; }
        .dark-mode-2 button, .dark-mode-2 .button-like { background-color: #1282a2; color: #fefcfb; border: 1px solid #034078; }
        .dark-mode-2 button:hover, .dark-mode-2 .button-like:hover { background-color: #0e6c89; }
        .dark-mode-2 button.secondary { background-color: #0c5f7d; }
        .dark-mode-2 button.secondary:hover { background-color: #094b61; }
        .dark-mode-2 button.danger { background-color: #ff4d4d; color: white;}
        .dark-mode-2 button.danger:hover { background-color: #e83838; }
        .dark-mode-2 select { background-color: #034078; color: #fefcfb; border: 1px solid #1282a2; }
        .dark-mode-2 .measure { background-color: #034078; color: #fefcfb; border: 1px solid #1282a2; }
        .dark-mode-2 .measure.active { background-color: #1282a2; border-color: #fefcfb; }
        .dark-mode-2 .measure.loop-selected { border-color: #61dafb; background-color: #01325A; }
        .dark-mode-2 .beat { background-color: #1282a2; color: #fefcfb; }
        .dark-mode-2 .beat.active { background-color: #034078; }
        .dark-mode-2 .volume-control, .dark-mode-2 .next-chord-display { color: #fefcfb; }
        .dark-mode-2 #current-song-title { color: #fefcfb; }
        .dark-mode-2 #current-song-description { color: #e0e0df; }
        .dark-mode-2 #song-info-display { background-color: #023059; border-color: #0f6090; }
        #dark-mode-toggle.active-2 { background-color: #1282a2; color: #fefcfb; border: 1px solid #034078; }

        .dark-mode-3 { background-color: #6b705c; color: #ffe8d6; }
        .dark-mode-3 .app-section { background: linear-gradient(145deg, #6b705c, #a5a58d); color: #ffe8d6; }
        .dark-mode-3 .fretboard-container { background-color: #a5a58d; border: 1px solid #cb997e; }
        .dark-mode-3 .fretboard { background-color: #cb997e; border: 2px solid #6b705c; }
        .dark-mode-3 .note { color: #6b705c; }
        .dark-mode-3 .scale-display { color: #ffe8d6; }
        .dark-mode-3 button, .dark-mode-3 .button-like { background-color: #cb997e; color: #6b705c; border: 1px solid #6b705c; }
        .dark-mode-3 button:hover, .dark-mode-3 .button-like:hover { background-color: #b2856c; }
        .dark-mode-3 button.secondary { background-color: #b18f7a; }
        .dark-mode-3 button.secondary:hover { background-color: #9a7860; }
        .dark-mode-3 button.danger { background-color: #d85c5c; color: white;}
        .dark-mode-3 button.danger:hover { background-color: #c24a4a; }
        .dark-mode-3 select { background-color: #ddbea9; color: #6b705c; border: 1px solid #cb997e; }
        .dark-mode-3 .measure { background-color: #a5a58d; color: #ffe8d6; border: 1px solid #cb997e; }
        .dark-mode-3 .measure.active { background-color: #ddbea9; border-color: #cb997e; }
        .dark-mode-3 .measure.loop-selected { border-color: #e7ad99; background-color: #BDA290; }
        .dark-mode-3 .beat { background-color: #ddbea9; color: #6b705c; }
        .dark-mode-3 .beat.active { background-color: #cb997e; }
        .dark-mode-3 .volume-control, .dark-mode-3 .next-chord-display { color: #ffe8d6; }
        .dark-mode-3 #current-song-title { color: #ffe8d6; }
        .dark-mode-3 #current-song-description { color: #f0d8c6; }
        .dark-mode-3 #song-info-display { background-color: #8a8a75; border-color: #b6a191; }
        #dark-mode-toggle.active-3 { background-color: #cb997e; color: #ffe8d6; border: 1px solid #6b705c; }

        .dark-mode #fretflow-section { background: linear-gradient(145deg, #283618, #606c38); color: #fefae0; }
        .dark-mode-2 #fretflow-section { background: linear-gradient(145deg, #001f54, #034078); color: #fefcfb; }
        .dark-mode-3 #fretflow-section { background: linear-gradient(145deg, #6b705c, #a5a58d); color: #ffe8d6; }

        .toggle-button { padding: 8px 12px; border: none; border-radius: 5px; color: white; cursor: pointer; transition: background-color 0.3s ease; font-size: 0.9em; }
        .toggle-button.active { background: #4CAF50; }
        .toggle-button:not(.active) { background: #9E9E9E; }

        #user-songs-section { margin-top: 15px; }
        #user-songs-section label { margin-right: 5px; }

    </style>
</head>
<body>
    <div class="top-controls app-section">
        <button id="dark-mode-toggle" aria-label="Toggle dark mode">Dark Mode</button>
        <button id="guide-tones-toggle" class="toggle-button" aria-label="Toggle guide tones">Guide Tones Off</button>
        <button id="loop-selected-toggle" class="toggle-button" aria-label="Toggle measure looping">Looping Off</button>
    </div>

    <div class="app-section" id="chord-fretboard-section">
        <h1>BEBOP BLUEPRINT</h1>
        <h3>Fretflow - Dynamic Fretboard with Scales that Move with the Chord Progression</h3>
        <div class="volume-control">
            <span>Fretboard Volume:</span>
            <input type="range" id="chord-fretboard-volume" min="0" max="1" step="0.1" value="0.3">
        </div>
        <div class="fretboard-container">
            <div class="scale-display" id="scale-display">Select a progression and key.</div>
            <div class="next-chord-display" id="next-chord-display"></div>
            <div class="controls">
                <select class="tuning-select" id="chord-tuning" aria-label="Select guitar tuning">
                    <option value="standard">Standard (EADGBE)</option>
                    <option value="dropD">Drop D (DADGBE)</option>
                    <option value="openG">Open G (DGDGBD)</option>
                    <option value="DADGAD">DADGAD</option>
                    <option value="openE">Open E (EBEG#BE)</option>
                </select>
            </div>
            <div id="chord-fretboard" class="fretboard"></div>
        </div>
    </div>

    <div class="app-section" id="metronome-section">
        <h2>BeatForge Metronome</h2>
        <h3>Click to accent strong beats</h3>
        <div class="controls">
            <select id="time-signature" aria-label="Select time signature">
                <option value="2">2/4</option> <option value="3">3/4</option> <option value="4" selected>4/4</option>
                <option value="6">6/8</option> <option value="7">7/8</option> <option value="8">8/8</option> <option value="12">12/8</option>
            </select>
            <select id="sound-type" aria-label="Select metronome sound">
                <option value="click">Click</option> <option value="woodblock">Woodblock</option> <option value="drums">Drums</option>
            </select>
            <button id="drumSetToggleBtn" class="control-button">Drums</button>
            <div class="volume-control">
                <span>Metronome Volume:</span>
                <input type="range" id="metronome-volume" min="0" max="1" step="0.1" value="0.25" aria-label="Metronome volume">
            </div>
            <input type="range" id="tempo" min="40" max="220" value="120" aria-label="Tempo">
            <span id="tempo-display">120 BPM</span>
            <button id="tap-tempo" aria-label="Tap tempo">Tap Tempo</button>
            <button id="start-stop" aria-label="Start or stop metronome">Start</button>
        </div>
        <div class="beats-container"></div>
         <div class="volume-control">
            <label for="accent-intensity">Accent Intensity:</label>
            <input type="range" id="accent-intensity" min="1" max="2" step="0.1" value="1.5" aria-label="Accent intensity">
        </div>
    </div>

    <div class="app-section" id="chord-progression-section">
        <h2>Chord Progression Practice</h2>
        <div id="song-info-display">
            <h4 id="current-song-title"></h4>
            <p id="current-song-description"></p>
        </div>
        <h3>Create a progression or pick one from the dropdown. Choose which key and scale to go with it.</h3>
        <div class="controls">
            <label for="progression-select">Select Progression:</label>
            <select id="progression-select" aria-label="Select chord progression">
                <option value="I V7">I-V7</option> <option value="jazz_blues">Jazz Blues</option> <option value="minor_blues">Minor Blues</option> <option value="rhythm_changes">Rhythm Changes</option> <option value="2_5_1">II-V-I</option> <option value="6_2_5_1">VI-II-V-I</option> <option value="minor_2_5_1">Minor iim-V7-im</option> <option value="dark_eyes">Dark Eyes</option> <option value="ill_see_you_in_my_dreams">I'll See You In My Dreams</option> <option value="rose_room">Rose Room</option> <option value="black_orpheus">Black Orpheus</option> <option value="all_the_things_you_are">All The Things You Are</option> <option value="all_of_me">All of Me</option> <option value="stella_by_starlight">Stella By Starlight</option> <option value="autumn_leaves">Autumn Leaves</option> <option value="summertime">Summertime</option> <option value="girl_from_ipanema">Girl From Ipanema</option> <option value="coltrane_changes">Coltrane Changes</option> <option value="bird_blues">Bird Blues</option> <option value="just_friends">Just Friends</option> <option value="blue_bossa">Blue Bossa</option> <option value="on_green_dolphin_street">On Green Dolphin Street</option> <option value="solar">Solar</option> <option value="misty">Misty</option> <option value="days_of_wine_and_roses">Days of Wine and Roses</option> <option value="cherokee">Cherokee</option> <option value="caravan">Caravan</option> <option value="nows_the_time">Now's The Time</option> <option value="tenor_madness">Tenor Madness</option>
            </select>
            <label for="keySelect">Select Key:</label>
            <select id="keySelect" aria-label="Select key">
              <option value="C">C</option> <option value="Cm">Cm</option> <option value="Db">Db</option> <option value="Dbm">Dbm</option> <option value="D">D</option> <option value="Dm">Dm</option> <option value="Eb">Eb</option> <option value="Ebm">Ebm</option> <option value="E">E</option> <option value="Em">Em</option> <option value="F">F</option> <option value="Fm">Fm</option> <option value="Gb">Gb</option> <option value="Gbm">Gbm</option> <option value="G">G</option> <option value="Gm">Gm</option> <option value="Ab">Ab</option> <option value="Abm">Abm</option> <option value="A">A</option> <option value="Am">Am</option> <option value="Bb">Bb</option> <option value="Bbm">Bbm</option> <option value="B">B</option> <option value="Bm">Bm</option>
            </select>
        </div>
        <div id="user-songs-section" class="controls">
            <label for="user-progression-select">Your Saved Songs:</label>
            <select id="user-progression-select" aria-label="Select your saved chord progression">
                <option value="">-- Select a saved song --</option>
            </select>
            <button id="delete-user-song-button" class="danger">Delete Selected Song</button>
        </div>

        <div id="measures"></div>

        <div class="controls">
            <button onclick="addMeasure()" aria-label="Add measure">Add Measure</button>
            <button onclick="removeMeasure()" aria-label="Remove measure">Remove Last Measure</button>
            <button id="save-progression-button" class="secondary" aria-label="Save current progression">Save Current Progression</button>
            <button id="chordsEnabled" class="toggle-button active">Chords Enabled</button>
        </div>
        <div class="volume-control">
            <label for="chord-volume">Chord Volume:</label>
            <input type="range" id="chord-volume" min="0" max="1" step="0.1" value="0.5" aria-label="Chord volume">
        </div>
        <div class="control-group">
              <label for="reverb-dial">Reverb</label>
              <input type="range" id="reverb-dial" min="0" max="100" value="20" style="width: 120px;">
              <span id="reverb-dial-value">20</span>%
         </div>
    </div>

<div class="app-section" id="fretflow-section">
    <h2>FretFlow</h2>
    <h3>Multiple scale workout</h3>
    <div class="fretboards-grid"></div>
</div>

    <script>
// ==================================
// === UTILITY FUNCTIONS ==========
// ==================================
function log(message) { console.log(`[Bebop Blueprint Debug] ${message}`); }
function updateLoadingStatus(message, isVisible = true) { let i = document.getElementById('loading-indicator'); if (!i) { i = document.createElement('div'); i.id = 'loading-indicator'; document.body.appendChild(i); } i.textContent = message; i.style.display = isVisible ? 'block' : 'none'; }

// ==================================
// === MUSICAL CONSTANTS ==========
// ==================================
const progressions = {
  "I V7": {
    defaultKey: "C",
    progression: ["Imaj7", "V7"],
    description:
      "A classic two-chord progression often used in jazz standards for a simple, elegant harmonic resolution.",
  },
  jazz_blues: {
    defaultKey: "Bb",
    progression: [
      "I7",
      "IV7",
      "I7",
      "I7",
      "IV7",
      "IV7",
      "I7",
      "VI7",
      "iim7",
      "V7",
      "I7",
      "V7",
    ],
    description:
      "A swinging 12-bar blues with jazzy substitutions, perfect for improvisation and soulful melodies.",
  },
  minor_blues: {
    defaultKey: "Am",
    progression: [
      "im7",
      "ivm7",
      "im7",
      "im7",
      "ivm7",
      "ivm7",
      "im7",
      "im7",
      "V7",
      "V7",
      "im7",
      "V7",
    ],
    description:
      "A moody minor blues progression with a melancholic vibe, ideal for expressive solos.",
  },
  rhythm_changes: {
    defaultKey: "Bb",
    progression: [
      "Imaj7",
      "vim7",
      "iim7",
      "V7",
      "Imaj7",
      "vim7",
      "iim7",
      "V7",
      "Imaj7",
      "IV7",
      "Imaj7",
      "Imaj7",
      "iim7",
      "V7",
      "Imaj7",
      "V7",
    ],
    description:
      "A fast-paced, iconic jazz structure based on Gershwin's 'I Got Rhythm,' great for bebop.",
  },
  "2_5_1": {
    defaultKey: "C",
    progression: ["iim7", "V7", "Imaj7", "Imaj7"],
    description:
      "The quintessential jazz turnaround, providing a smooth and satisfying resolution.",
  },
  "6_2_5_1": {
    defaultKey: "C",
    progression: ["vim7", "iim7", "V7", "Imaj7", "Imaj7"],
    description:
      "An extended version of the 2-5-1, starting on the vi minor for a richer harmonic journey.",
  },
  minor_2_5_1: {
    defaultKey: "Am",
    progression: ["iim7b5", "V7b9", "im7", "im7"],
    description:
      "A dramatic minor key progression, often used for intense and emotional resolutions.",
  },
  dark_eyes: {
    defaultKey: "Dm",
    progression: [
      "V7",
      "V7",
      "im7",
      "im7",
      "V7",
      "V7",
      "VI6",
      "VI6",
      "ivm6",
      "ivm6",
      "im7",
      "im7",
      "V7",
      "V7",
      "im7",
      "im7",
    ],
    description:
      "A passionate, Gypsy jazz-inspired progression with a fiery, Eastern European flair.",
  },
  ill_see_you_in_my_dreams: {
    defaultKey: "F",
    progression: [
      "IV6",
      "IV6",
      "ivm6",
      "ivm6",
      "Imaj7",
      "VII7",
      "Imaj7",
      "Imaj7",
      "VI7",
      "VI7",
      "VI7",
      "VI7",
      "II7",
      "II7",
      "iim7",
      "V7",
      "IV7",
      "Imaj6",
    ],
    description:
      "A dreamy, nostalgic progression from the 1920s, evoking romance and whimsy.",
  },
  rose_room: {
    defaultKey: "Ab",
    progression: [
      "II7",
      "V7",
      "I6",
      "I7",
      "IV6",
      "ivm7",
      "bVII7",
      "I6",
      "VI7",
      "V7",
      "V7",
      "II7",
      "V7",
      "I6",
      "I7",
      "IV6",
      "ivm7",
      "bVII7",
      "I6",
      "VI7",
      "IV7",
      "V7",
      "I6",
      "VI7",
    ],
    description:
      "A sophisticated swing tune with lush chords, perfect for a classy jazz vibe.",
  },
  black_orpheus: {
    defaultKey: "Am",
    progression: [
      "im7",
      "iim7b5",
      "V7b9",
      "im7",
      "ivm7",
      "VII7",
      "bIIImaj7",
      "bVImaj7",
      "iim7b5",
      "V7b9",
      "im7",
      "iim7b5",
      "V7b9",
      "im7",
      "ivm7",
      "VII7",
    ],
    description:
      "A bossa nova classic with a haunting minor key, inspired by Brazilian rhythms.",
  },
  all_the_things_you_are: {
    defaultKey: "Ab",
    progression: [
      "vim7",
      "iim7",
      "V7",
      "Imaj7",
      "IVmaj7",
      "iiim7",
      "VI7",
      "IImaj7",
      "iim7",
      "vm7",
      "I7",
      "IVmaj7",
      "Imaj7",
      "iim7",
      "V7",
      "Imaj7",
      "iim7",
      "V7",
      "Imaj7",
      "iim7",
      "vm7",
      "I7",
      "IVmaj7",
      "Imaj7",
    ],
    description:
      "A harmonically complex standard with shifting keys, beloved in jazz for its beauty.",
  },
  all_of_me: {
    defaultKey: "C",
    progression: [
      "Imaj7",
      "III7",
      "VI7",
      "iim7",
      "III7",
      "vim7",
      "II7",
      "iim7",
      "V7",
      "Imaj7",
      "III7",
      "VI7",
      "iim7",
      "IVmaj7",
      "ivm7",
      "Imaj7",
      "V7",
    ],
    description:
      "A cheerful, upbeat standard with a catchy progression, great for vocal jazz.",
  },
  stella_by_starlight: {
    defaultKey: "Bb",
    progression: [
      "iim7b5",
      "V7b9",
      "Imaj7",
      "IV7",
      "vm7",
      "I7",
      "IVmaj7",
      "bVIImaj7",
      "biiim7b5",
      "VI7b9",
      "iim7",
      "V7",
      "Imaj7",
      "IV7",
      "IVmaj7",
      "V7",
    ],
    description:
      "A lush, cinematic progression with a romantic and introspective feel.",
  },
  autumn_leaves: {
    defaultKey: "Gm",
    progression: [
      "iim7b5",
      "V7",
      "imaj7",
      "IVmaj7",
      "viim7b5",
      "III7",
      "vim7",
      "vim7",
    ],
    description:
      "A melancholic jazz standard evoking falling leaves and wistful nostalgia.",
  },
  summertime: {
    defaultKey: "Am",
    progression: [
      "im7",
      "V7",
      "im7",
      "V7",
      "im7",
      "V7",
      "im7",
      "V7",
      "ivm7",
      "im7",
      "V7",
      "im7",
      "ivm7",
      "im7",
      "V7",
      "im7",
    ],
    description:
      "A sultry, soulful progression from Gershwin's opera, perfect for laid-back grooves.",
  },
  girl_from_ipanema: {
    defaultKey: "F",
    progression: [
      "Imaj7",
      "II7",
      "iim7",
      "V7",
      "Imaj7",
      "II7",
      "iim7",
      "V7",
      "Imaj7",
      "bII7",
      "#IVm7b5",
      "VII7",
      "iiim7",
      "VI7",
      "iim7",
      "V7",
    ],
    description:
      "A breezy bossa nova tune with a sunny, beachy vibe, iconic in jazz.",
  },
  coltrane_changes: {
    defaultKey: "C",
    progression: [
      "Imaj7",
      "bIII7",
      "bVImaj7",
      "VII7",
      "IIImaj7",
      "V7",
      "Imaj7",
      "bIII7",
      "bVImaj7",
      "VII7",
      "IIImaj7",
      "V7",
    ],
    description:
      "A challenging, innovative progression from John Coltrane, with rapid key shifts.",
  },
  bird_blues: {
    defaultKey: "F",
    progression: [
      "I7",
      "IV7",
      "I7",
      "vim7",
      "iim7",
      "V7",
      "IV7",
      "ivm7",
      "I7",
      "vim7",
      "iim7",
      "V7",
    ],
    description:
      "A bebop blues progression inspired by Charlie Parker, full of energy and drive.",
  },
  just_friends: {
    defaultKey: "G",
    progression: [
      "Imaj7",
      "VI7",
      "iim7",
      "V7",
      "Imaj7",
      "VI7",
      "iim7",
      "V7",
      "iim7",
      "V7",
      "Imaj7",
      "VI7",
      "iim7",
      "V7",
      "Imaj7",
      "VI7",
    ],
    description:
      "A lively, upbeat standard with a playful harmonic structure, great for swing.",
  },
  blue_bossa: {
    defaultKey: "Cm",
    progression: [
      "im7",
      "im7",
      "bVII7",
      "bVII7",
      "im7",
      "im7",
      "ivm7",
      "bVII7",
      "im7",
      "V7",
      "im7",
      "im7",
    ],
    description:
      "A cool, Latin-jazz progression with a relaxed yet groovy bossa nova feel.",
  },
  on_green_dolphin_street: {
    defaultKey: "C",
    progression: [
      "Imaj7",
      "im7",
      "Imaj7",
      "im7",
      "bIImaj7",
      "Imaj7",
      "bIImaj7",
      "Imaj7",
      "iim7",
      "V7",
    ],
    description:
      "A modal, cinematic progression with a mysterious and captivating atmosphere.",
  },
  solar: {
    defaultKey: "Cm",
    progression: [
      "imaj7",
      "iim7b5",
      "V7alt",
      "imaj7",
      "bVImaj7",
      "bIIImaj7",
      "bVII7",
      "bVII7",
      "imaj7",
      "imaj7",
    ],
    description:
      "A contemplative, Miles Davis original with a flowing, introspective harmonic line.",
  },
  misty: {
    defaultKey: "Eb",
    progression: [
      "Imaj7",
      "vm7",
      "I7",
      "IVmaj7",
      "ivm7",
      "Imaj7",
      "iim7",
      "V7",
      "iiim7",
      "VI7",
      "iim7",
      "V7",
    ],
    description:
      "A tender, romantic ballad progression, evoking misty-eyed sentimentality.",
  },
  days_of_wine_and_roses: {
    defaultKey: "F",
    progression: [
      "Imaj7",
      "vim7",
      "iim7",
      "V7",
      "Imaj7",
      "vim7",
      "iim7",
      "V7",
      "IVmaj7",
      "vm7",
      "I7",
      "IVmaj7",
      "iiim7",
      "VI7",
      "iim7",
      "V7",
    ],
    description:
      "A bittersweet, elegant progression with a waltzing, reflective quality.",
  },
  cherokee: {
    defaultKey: "Bb",
    progression: [
      "Imaj7",
      "Imaj7",
      "iim7",
      "V7",
      "Imaj7",
      "Imaj7",
      "iim7",
      "V7",
      "bVImaj7",
      "bVImaj7",
      "V7",
      "V7",
      "Imaj7",
      "Imaj7",
      "iim7",
      "V7",
    ],
    description:
      "A high-energy bebop standard with a fast-moving, adventurous harmonic structure.",
  },
  caravan: {
    defaultKey: "Fm",
    progression: [
      "im7",
      "IV7b5",
      "im7",
      "IV7b5",
      "im7",
      "IV7b5",
      "im7",
      "IV7b5",
      "bVII7",
      "bVII7",
      "Imaj7",
      "Imaj7",
      "V7",
      "V7",
      "im7",
      "im7",
    ],
    description:
      "An exotic, Latin-tinged progression with a hypnotic, caravan-like rhythm.",
  },
  nows_the_time: {
    defaultKey: "F",
    progression: [
      "I7",
      "I7",
      "I7",
      "I7",
      "IV7",
      "IV7",
      "I7",
      "I7",
      "V7",
      "IV7",
      "I7",
      "I7",
    ],
    description:
      "A gritty, straightforward blues progression by Charlie Parker, full of soul.",
  },
  tenor_madness: {
    defaultKey: "Bb",
    progression: [
      "I7",
      "I7",
      "I7",
      "I7",
      "IV7",
      "IV7",
      "I7",
      "I7",
      "iim7",
      "V7",
      "I7",
      "I7",
    ],
    description:
      "A hard-swinging blues progression, ideal for fiery tenor sax battles.",
  },
};
const NOTES = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
const NOTES_CHROMATIC = [
  "C",
  "Db",
  "D",
  "Eb",
  "E",
  "F",
  "Gb",
  "G",
  "Ab",
  "A",
  "Bb",
  "B",
];
const ALL_NOTES_FOR_SAMPLES = [
  "a",
  "as",
  "b",
  "c",
  "cs",
  "d",
  "ds",
  "e",
  "f",
  "fs",
  "g",
  "gs",
];
const OCTAVES_FOR_SAMPLES = [2, 3, 4, 5];
const PLAYBACK_OCTAVES = [3, 4];
const FILE_FORMAT = "wav";
// *** Corrected Placement for getSampleFileName ***
function getSampleFileName(note, octave) {
  return `${note}${octave}.${FILE_FORMAT}`;
}
// *** End Corrected Placement ***
const SAMPLE_NOTE_MAP = {
  C: "c",
  Db: "cs",
  "C#": "cs",
  D: "d",
  Eb: "ds",
  "D#": "ds",
  E: "e",
  F: "f",
  Gb: "fs",
  "F#": "fs",
  G: "g",
  Ab: "gs",
  "G#": "gs",
  A: "a",
  Bb: "as",
  "A#": "as",
  B: "b",
  CS: "cs",
  DS: "ds",
  FS: "fs",
  GS: "gs",
  AS: "as",
};
const FRETBOARD_NOTES_OCTAVES = {
  string1: [
    "E4",
    "F4",
    "Fs4",
    "G4",
    "Gs4",
    "A4",
    "As4",
    "B4",
    "C5",
    "Cs5",
    "D5",
    "Ds5",
    "E5",
  ],
  string2: [
    "B3",
    "C4",
    "Cs4",
    "D4",
    "Ds4",
    "E4",
    "F4",
    "Fs4",
    "G4",
    "Gs4",
    "A4",
    "As4",
    "B4",
  ],
  string3: [
    "G3",
    "Gs3",
    "A3",
    "As3",
    "B3",
    "C4",
    "Cs4",
    "D4",
    "Ds4",
    "E4",
    "F4",
    "Fs4",
    "G4",
  ],
  string4: [
    "D3",
    "Ds3",
    "E3",
    "F3",
    "Fs3",
    "G3",
    "Gs3",
    "A3",
    "As3",
    "B3",
    "C4",
    "Cs4",
    "D4",
  ],
  string5: [
    "A2",
    "As2",
    "B2",
    "C3",
    "Cs3",
    "D3",
    "Ds3",
    "E3",
    "F3",
    "Fs3",
    "G3",
    "Gs3",
    "A3",
  ],
  string6: [
    "E2",
    "F2",
    "Fs2",
    "G2",
    "Gs2",
    "A2",
    "As2",
    "B2",
    "C3",
    "Cs3",
    "D3",
    "Ds3",
    "E3",
  ],
};
const SCALES = {
  major: [0, 2, 4, 5, 7, 9, 11],
  minor: [0, 2, 3, 5, 7, 8, 10],
  harmonicMinor: [0, 2, 3, 5, 7, 8, 11],
  melodicMinor: [0, 2, 3, 5, 7, 9, 11],
  dorian: [0, 2, 3, 5, 7, 9, 10],
  phrygian: [0, 1, 3, 5, 7, 8, 10],
  lydian: [0, 2, 4, 6, 7, 9, 11],
  mixolydian: [0, 2, 4, 5, 7, 9, 10],
  locrian: [0, 1, 3, 5, 6, 8, 10],
  bebopDominant: [0, 2, 4, 5, 7, 9, 10, 11],
  bebopMajor: [0, 2, 4, 5, 7, 8, 9, 11],
  bebopDorian: [0, 2, 3, 4, 5, 7, 9, 10],
  bebopPhrygian: [0, 1, 2, 3, 5, 7, 8, 10],
  altered: [0, 1, 3, 4, 6, 8, 10],
  lydianDominant: [0, 2, 4, 6, 7, 9, 10],
  diminishedWH: [0, 2, 3, 5, 6, 8, 9, 11],
  diminishedHW: [0, 1, 3, 4, 6, 7, 9, 10],
  wholeTone: [0, 2, 4, 6, 8, 10],
  pentatonicMajor: [0, 2, 4, 7, 9],
  pentatonicMinor: [0, 3, 5, 7, 10],
  blues: [0, 3, 5, 6, 7, 10],
  majorBlues: [0, 2, 3, 4, 7, 9],
  harmonicMajor: [0, 2, 4, 5, 7, 8, 11],
  doubleHarmonic: [0, 1, 4, 5, 7, 8, 11],
  enigmatic: [0, 1, 4, 6, 8, 10, 11],
  persian: [0, 1, 4, 5, 6, 8, 11],
  arabic: [0, 2, 4, 5, 6, 8, 10],
  japanese: [0, 2, 5, 7, 8],
  egyptian: [0, 2, 5, 7, 10],
};
const TUNINGS = {
  standard: ["E", "B", "G", "D", "A", "E"],
  dropD: ["E", "B", "G", "D", "A", "D"],
  openG: ["D", "B", "G", "D", "G", "D"],
  DADGAD: ["D", "A", "G", "D", "A", "D"],
  openE: ["E", "B", "E", "Ab", "B", "E"],
};
Object.keys(TUNINGS).forEach((key) => TUNINGS[key].reverse());
const CHORD_INTERVALS = {
  maj: [0, 4, 7],
  min: [0, 3, 7],
  dim: [0, 3, 6],
  aug: [0, 4, 8],
  sus4: [0, 5, 7],
  sus2: [0, 2, 7],
  maj7: [0, 4, 7, 11],
  dom7: [0, 4, 7, 10],
  min7: [0, 3, 7, 10],
  min7b5: [0, 3, 6, 10],
  dim7: [0, 3, 6, 9],
  maj6: [0, 4, 7, 9],
  min6: [0, 3, 7, 9],
  dom7b9: [0, 4, 7, 10, 13],
  "dom7#9": [0, 4, 7, 10, 15],
  dom7b5: [0, 4, 6, 10],
  alt: [0, 4, 6, 10, 13],
  dom7sus: [0, 5, 7, 10],
  maj9: [0, 4, 7, 11, 14],
  dom9: [0, 4, 7, 10, 14],
  min9: [0, 3, 7, 10, 14],
  imaj7: [0, 3, 7, 11],
  unknown: [0, 4, 7, 10],
};
const drumSoundSets = [
  { name: "Drums", snare: "Snare.wav", hihat: "HiHat.wav", kick: "Kick.wav" },
  {
    name: "Makaya",
    snare: "Snare2.wav",
    hihat: "HiHat2.wav",
    kick: "Kick2.wav",
  },
  {
    name: "PhillyJoe",
    kick: "jazzkick.wav",
    snare: "jazzsnare.wav",
    hihat: "jazzhat.wav",
  },
];

// --- State Management ---
const AppState = { isPlaying: false, currentBeat: 0, currentMeasure: 0, tempo: 120, audioInitialized: false, intervalId: null, lastTapTime: 0, tapTempoTimestamps: [], guideTonesActive: false, loopingActive: false, loopStartMeasure: -1, loopEndMeasure: -1, previousChordRootIndex: undefined, listeners: [], updateState(newState){ Object.assign(this,newState); this.notifyListeners(); }, addListener(cb){ this.listeners.push(cb); }, notifyListeners(){ this.listeners.forEach(cb=>cb(this));} };
let currentFunctionalProgression = [];
let currentProgressionName = "";
let currentDrumSetIndex = 0;

// --- UI Management ---
const UI = {
    elements: {},
    init() { this.elements = { chordFretboard:document.getElementById('chord-fretboard'), measures:document.getElementById('measures'), tempoDisplay:document.getElementById('tempo-display'), startStopButton:document.getElementById('start-stop'), progressionSelect:document.getElementById('progression-select'), keySelect:document.getElementById('keySelect'), scaleDisplay:document.getElementById('scale-display'), nextChordDisplay:document.getElementById('next-chord-display'), chordTuning:document.getElementById('chord-tuning'), timeSignature:document.getElementById('time-signature'), soundType:document.getElementById('sound-type'), metronomeVolume:document.getElementById('metronome-volume'), tempo:document.getElementById('tempo'), tapTempo:document.getElementById('tap-tempo'), chordFretboardVolume:document.getElementById('chord-fretboard-volume'), chordVolume:document.getElementById('chord-volume'), chordsEnabled:document.getElementById('chordsEnabled'), fretboardsGrid:document.querySelector('.fretboards-grid'), darkModeToggle:document.getElementById('dark-mode-toggle'), accentIntensity:document.getElementById('accent-intensity'), drumSetToggleBtn:document.getElementById('drumSetToggleBtn'), reverbDial:document.getElementById('reverb-dial'), reverbDialValue:document.getElementById('reverb-dial-value'), currentSongTitle:document.getElementById('current-song-title'), currentSongDescription:document.getElementById('current-song-description'), userProgressionSelect:document.getElementById('user-progression-select'), saveProgressionButton:document.getElementById('save-progression-button'), deleteUserSongButton:document.getElementById('delete-user-song-button'), guideTonesToggle:document.getElementById('guide-tones-toggle'), loopSelectedToggle:document.getElementById('loop-selected-toggle') }; Object.entries(this.elements).forEach(([k,el])=> { if(!el && k!=='reverbDialValue') console.warn(`Missing DOM: ${k}`);}); log("UI elements cached."); }
};

// --- Music Theory Helpers ---
function standardizeNoteName(note) { if (!note) return ''; let s=note.toUpperCase().trim().replace('♭','b').replace('♯','#'); const sfm={'C#':'Db','D#':'Eb','F#':'Gb','G#':'Ab','A#':'Bb'}; if(s.includes('#'))return sfm[s]||s; const f=NOTES.find(n=>n.toUpperCase()===s.toUpperCase()); return f||s; }
function standardizeNoteNameForSamples(note){ const sn = standardizeNoteName(note); return SAMPLE_NOTE_MAP[sn] || SAMPLE_NOTE_MAP[note.toUpperCase()] || note.toLowerCase(); }
function getStandardQuality(rawQuality) { if (!rawQuality) return 'maj7'; const q = rawQuality.toLowerCase().trim(); if (q === 'maj7' || q === 'ma7' || q === 'Δ' || q === 'maj') return 'maj7'; if (q === '7' || q === 'dom7' || q === 'dom') return 'dom7'; if (q === 'm7' || q === 'min7' || q === 'mi7' || q === 'min' || q === 'm') return 'min7'; if (q === 'm7b5' || q === 'min7b5' || q === 'ø' || q === 'mi7b5') return 'min7b5'; if (q === 'dim7' || q === '°7') return 'dim7'; if (q === 'maj6' || q === 'ma6' || (q === '6' && !rawQuality.startsWith('m') && !rawQuality.startsWith('M'))) return 'maj6'; if (q === 'm6' || q === 'min6' || q === 'mi6') return 'min6'; if (q === 'dim' || q === '°') return 'dim'; if (q === 'aug' || q === '+') return 'aug'; if (q === 'sus4' || q === 'sus') return 'sus4'; if (q === '7b9' || q === 'dom7b9') return 'dom7b9'; if (q === '7#9' || q === 'dom7#9') return 'dom7#9'; if (q === '7b5' || q === 'dom7b5') return 'dom7b5'; if (q === 'alt' || q === '7alt') return 'alt'; if (q === '7sus' || q === '7sus4') return 'dom7sus'; if (q === 'imaj7' || q === 'm(maj7)' || q === 'minmaj7') return 'imaj7'; if (CHORD_INTERVALS[rawQuality]) return rawQuality; console.warn(`getStandardQuality: Unstandardized "${rawQuality}". Defaulting.`); return 'maj7';}
function parseChord(chordString) { if(typeof chordString !== 'string' || !chordString.trim()) return null; chordString = chordString.trim(); const m = chordString.match(/^([A-G][#b]?)(.*)$/); if(!m) return null; const r = standardizeNoteName(m[1]); const q = m[2].trim(); return { root: r, quality: getStandardQuality(q) }; }
function parseRomanNumeralToAbsoluteChord(romanString, key) { const kim = key.includes('m'); const nkr = standardizeNoteName(key.replace('m','')); const kri = NOTES_CHROMATIC.indexOf(nkr); if(kri===-1)return{root:'C',quality:'maj7',originalRoman:romanString}; const rm = romanString.match(/^(b|#)?([IViv]+)(.*)$/); if(!rm){const pa=parseChord(romanString);if(pa&&pa.root){if(!CHORD_INTERVALS[pa.quality])pa.quality='maj7';return{...pa,originalRoman:romanString};}return{root:nkr,quality:'maj7',originalRoman:romanString};} const acc=rm[1];const num=rm[2];let qs=rm[3].trim(); const majSI={'I':0,'II':2,'III':4,'IV':5,'V':7,'VI':9,'VII':11}; const minSI={'i':0,'ii':2,'III':3,'iv':5,'v':7,'VI':8,'VII':10}; let di; const iucn=num===num.toUpperCase(); if(kim){di=minSI[num.toLowerCase()];if(iucn&&num==='V')di=majSI[num];else if(iucn&&num==='IV')di=majSI[num];}else{di=majSI[num.toUpperCase()];} if(di===undefined)return{root:nkr,quality:'maj7',originalRoman:romanString}; let cri=(kri+di)%12;if(acc==='b')cri=(cri-1+12)%12;else if(acc==='#')cri=(cri+1)%12; const cr=NOTES_CHROMATIC[cri]; let fq; if(qs){fq=getStandardQuality(qs);if(qs==="6")fq=iucn?"maj6":"min6";else if(qs==="m6")fq="min6";}else{if(num.toLowerCase()==='v')fq='dom7';else if(num.toLowerCase()==='vii'&&!iucn)fq='min7b5';else if(iucn)fq='maj7';else fq='min7';} if(!CHORD_INTERVALS[fq]){console.warn(`Quality "${fq}" for ${romanString} in ${key} not in CHORD_INTERVALS. Defaulting.`);fq=iucn?'maj7':'min7';} return{root:cr,quality:fq,originalRoman:romanString};}
function getChordNotes(root, quality) { let i=CHORD_INTERVALS[quality];if(!i){console.warn(`Quality "${quality}" for ${root} not found. Defaulting.`);i=CHORD_INTERVALS['dom7'];} const rn=standardizeNoteName(root);const ri=NOTES.indexOf(rn);if(ri===-1){console.error(`Invalid root for getChordNotes: ${root}`);return[rn];} return i.map(iv=>(NOTES[(ri+iv)%12]));}
function suggestScaleForQuality(quality) { const sm={'maj7':'major','maj':'major','maj6':'major','dom7':'mixolydian','dom9':'mixolydian','dom7b9':'diminishedWH','dom7#9':'altered','alt':'altered','dom7sus':'mixolydian','min7':'dorian','min':'dorian','min9':'dorian','min6':'dorian','min7b5':'locrian','dim7':'diminishedWH','imaj7':'melodicMinor'}; return sm[quality]||'major';}

// --- DOM Utilities ---
function createKeyOptions(selKey='C'){return NOTES.map(n=>`<option value="${n}"${n===standardizeNoteName(selKey)?' selected':''}>${n}</option>`).join('');}

function createQualityOptions(selQ='maj7'){
    const Qs=[
        {v:'maj7',l:'maj7'},       // Changed Label
        {v:'dom7',l:'7'},          // Changed Label
        {v:'min7',l:'m7'},         // Changed Label
        {v:'min7b5',l:'m7b5'},     // Changed Label (or m7ø5)
        {v:'dim7',l:'dim7'},      // Changed Label (or °7)
        {v:'maj6',l:'maj6'},
        {v:'min6',l:'m6'},
        {v:'dom7b9',l:'7b9'},
        {v:'dom7#9',l:'7#9'},
        {v:'dom7b5',l:'7b5'},
        {v:'alt',l:'alt'},
        {v:'dom7sus',l:'7sus'},
        {v:'imaj7',l:'m(maj7)'}, // Or 'mM7'
        {v:'maj',l:'(maj)'},   // Indicate triad, maybe? Or just Root? Label is tricky.
        {v:'min',l:'m'},       // Minor triad label
        {v:'dim',l:'dim'},     // Dim triad label
        {v:'aug',l:'aug'},     // Aug triad label
        {v:'sus4',l:'sus4'}
    ];
    return Qs.map(q=>`<option value="${q.v}"${q.v===selQ?' selected':''}>${q.l}</option>`).join('');
}
function createScaleOptions(selS='major'){return Object.keys(SCALES).map(sn=>{const dn=sn.replace(/([A-Z]+)/g,' $1').replace(/([A-Z][a-z])/g,' $1').split(' ').map(s=>s.charAt(0).toUpperCase()+s.substring(1)).join(' ');return`<option value="${sn}"${sn===selS?' selected':''}>${dn}</option>`;}).join('');}

// --- Audio Management (Object MUST be defined AFTER helpers like getSampleFileName) ---
const AudioContextManager = {
    context: null, soundBuffers: {}, pianoSampleBuffers: {}, reverbNode: null, samplesLoaded: false, reverbAmount: 0.2, currentChordGain: null, secondaryLoadStarted: false, reverbNodeConnected: false,
    initialize: async function() { if (this.context && this.context.state !== 'closed') return this.context; try { this.context = new (window.AudioContext || window.webkitAudioContext)(); log("AudioContext created/resumed."); updateLoadingStatus("Loading essential sounds...", true); await this.loadInitialSounds(); AppState.audioInitialized = true; log("AudioContextManager initial sounds loaded."); await this.setupReverb(); if (this.context.state === 'suspended') { await this.context.resume(); log("AudioContext resumed from suspended state."); } setTimeout(() => this.loadSecondarySounds(), 100); } catch (error) { console.error("Error initializing AudioContextManager:", error); alert("Failed to initialize audio."); AppState.audioInitialized = false; throw error; } return this.context; },
    ensureAudioContext: async function() { if (!this.context || this.context.state === 'suspended') { return await this.initialize(); } if(this.context.state === 'closed'){ console.warn("AudioContext was closed, re-initializing."); return await this.initialize(); } return this.context; },
    loadInitialSounds: async function() { try { const r=await fetch('./Click.wav'); if(!r.ok)throw new Error(`HTTP ${r.status} for Click.wav`); const ab=await r.arrayBuffer(); this.soundBuffers['click']=await this.context.decodeAudioData(ab); log("Loaded click sound."); } catch(e){ console.error("Failed Click.wav:", e); this.soundBuffers['click']=await this.createDrumSound('click'); log("Using synth fallback for click."); } await this.loadPianoSamplesSpecific(PLAYBACK_OCTAVES); this.samplesLoaded=Object.keys(this.pianoSampleBuffers).length > 0; if(this.samplesLoaded) log(`Initial piano samples (Octaves ${PLAYBACK_OCTAVES.join(',')}) loaded.`); else console.warn(`Initial piano samples (Octaves ${PLAYBACK_OCTAVES.join(',')}) failed.`); },
    loadSecondarySounds: async function() { if(this.secondaryLoadStarted) return; this.secondaryLoadStarted=true; log("Starting secondary background sound loading..."); updateLoadingStatus("Loading additional sounds...", true); const lp=[]; const sm={'woodblock':'woodblock.wav','hihat':'HiHat.wav','kick':'Kick.wav','snare':'Snare.wav'}; for(let [t,f] of Object.entries(sm)){ if(!this.soundBuffers[t]){ lp.push(this.loadSingleSound(t,f)); }} const ro=OCTAVES_FOR_SAMPLES.filter(o => !PLAYBACK_OCTAVES.includes(o)); if(ro.length>0){ lp.push(this.loadPianoSamplesSpecific(ro)); } await Promise.allSettled(lp); log("Secondary background sound loading complete."); updateLoadingStatus("All sounds loaded.", true); setTimeout(() => updateLoadingStatus("", false), 1500); },
    loadSingleSound: async function(type, filename) { try { const r=await fetch(`./${filename}`); if(!r.ok)throw new Error(`HTTP ${r.status} for ${filename}`); const ab=await r.arrayBuffer(); this.soundBuffers[type]=await this.context.decodeAudioData(ab); log(`Loaded secondary sound: ${filename}`); } catch (e) { console.error(`Failed secondary load ${filename}:`, e); this.soundBuffers[type]=await this.createDrumSound(type); log(`Using fallback for secondary sound: ${type}`); } },
    loadPianoSamplesSpecific: async function(octavesToLoad) { let lc=0; const p=[]; for (const n of ALL_NOTES_FOR_SAMPLES){ for (const o of octavesToLoad){ if (!OCTAVES_FOR_SAMPLES.includes(o)) continue; const k=`${n}${o}`; if (this.pianoSampleBuffers[k]) continue; const fn=getSampleFileName(n,o); /* getSampleFileName must be defined before this */ p.push( fetch(fn).then(r=>r.ok?r.arrayBuffer():Promise.reject(`HTTP ${r.status} for ${fn}`)).then(ab=>this.context.decodeAudioData(ab)).then(buf=>{this.pianoSampleBuffers[k]=buf; lc++;}).catch(e=>console.error(`Failed piano sample: ${fn}`,e)) ); } } await Promise.allSettled(p); log(`Loaded ${lc} piano samples for octaves: [${octavesToLoad.join(', ')}]`); this.samplesLoaded=Object.keys(this.pianoSampleBuffers).length > 0; },
    createDrumSound: async function(t) {const sr=this.context.sampleRate; const d=t==='hihat'?0.05:0.2;const b=this.context.createBuffer(1,sr*d,sr);const data=b.getChannelData(0); switch(t){case 'click':for(let i=0;i<data.length;i++)data[i]=Math.sin(i*0.05)*Math.exp(-i*0.01);break; case 'hihat':for(let i=0;i<data.length;i++)data[i]=(Math.random()*2-1)*Math.exp(-i/(sr*0.01));break; case 'kick':for(let i=0;i<data.length;i++){const x=i/sr;data[i]=Math.sin(2*Math.PI*100*x)*Math.exp(-x*10)*2;}break; case 'snare':for(let i=0;i<data.length;i++){const x=i/sr;data[i]=((Math.random()*2-1)+Math.sin(2*Math.PI*200*x))*Math.exp(-x*10)*2;}break; case 'woodblock':for(let i=0;i<data.length;i++){const x=i/sr;data[i]=Math.sin(2*Math.PI*800*x)*Math.exp(-x*20);}break;} return b;},
    setupReverb: async function() { if(!this.context)return; if(!this.reverbNode){ try { this.reverbNode=this.context.createConvolver(); const sr=this.context.sampleRate; const l=sr*2.5; const imp=this.context.createBuffer(2,l,sr); for(let ch=0;ch<2;ch++){const cd=imp.getChannelData(ch);for(let i=0;i<l;i++)cd[i]=(Math.random()*2-1)*Math.pow(1-i/l,2.5);} this.reverbNode.buffer=imp; log("Reverb node created."); if(this.context.destination&&!this.reverbNodeConnected){this.reverbNode.connect(this.context.destination);this.reverbNodeConnected=true;log("Reverb connected to destination.");}}catch(e){console.error("Failed to create reverb node:", e);this.reverbNode=null;}}}
};
async function ensureAudioInitializedUserInteraction() { if(!AppState.audioInitialized){try{await AudioContextManager.initialize();log("Audio context initialized on user interaction.");}catch(e){console.error('Audio init failed on user interaction:',e);}} }

// --- Audio Playback ---
function playNote(noteNameWithOctave, volume=0.5, duration=500) { if (!AudioContextManager.context || !AudioContextManager.samplesLoaded || !noteNameWithOctave) return; const m=noteNameWithOctave.match(/^([A-G][#bs]?)(\d)$/i); if(!m){console.warn(`Invalid note format: ${noteNameWithOctave}`);return;} let [,pc,os]=m; const spc=standardizeNoteNameForSamples(pc); const o=Math.max(OCTAVES_FOR_SAMPLES[0],Math.min(OCTAVES_FOR_SAMPLES[OCTAVES_FOR_SAMPLES.length-1],parseInt(os))); const sk=`${spc}${o}`; const b=AudioContextManager.pianoSampleBuffers[sk]; if(!b){console.warn(`No sample for ${sk} (orig: ${noteNameWithOctave})`);return;} try{const s=AudioContextManager.context.createBufferSource();s.buffer=b;const gn=AudioContextManager.context.createGain();gn.gain.setValueAtTime(volume,AudioContextManager.context.currentTime);s.connect(gn);gn.connect(AudioContextManager.context.destination);s.start(AudioContextManager.context.currentTime);s.stop(AudioContextManager.context.currentTime+duration/1000);}catch(e){console.error('Error playing note:',e);} }
async function playChord(root, quality, startTime, duration) { if (!UI.elements.chordsEnabled.classList.contains('active') || !AudioContextManager.samplesLoaded) return; await AudioContextManager.ensureAudioContext(); const baseNotes = getChordNotes(root, quality); if (!baseNotes || baseNotes.length === 0) return; const overallVolume = parseFloat(UI.elements.chordVolume.value) * 0.7; if (overallVolume <= 0) return; if (AudioContextManager.currentChordGain) { try { AudioContextManager.currentChordGain.gain.setValueAtTime(AudioContextManager.currentChordGain.gain.value, startTime); AudioContextManager.currentChordGain.gain.exponentialRampToValueAtTime(0.001, startTime + 0.05); } catch(e) { console.warn("Fade out error", e); } } const mainGain = AudioContextManager.context.createGain(); mainGain.gain.setValueAtTime(0, startTime); mainGain.gain.linearRampToValueAtTime(overallVolume, startTime + 0.02); mainGain.connect(AudioContextManager.context.destination); AudioContextManager.currentChordGain = mainGain; if (AudioContextManager.reverbNode && AudioContextManager.reverbAmount > 0) { const rdw = AudioContextManager.context.createGain(); rdw.gain.value = AudioContextManager.reverbAmount; mainGain.connect(rdw); rdw.connect(AudioContextManager.reverbNode); if (!AudioContextManager.reverbNodeConnected && AudioContextManager.context.destination) { AudioContextManager.reverbNode.connect(AudioContextManager.context.destination); AudioContextManager.reverbNodeConnected = true; } } let voicing = [...baseNotes]; const inv = Math.floor(Math.random() * voicing.length); for (let i = 0; i < inv; i++) { voicing.push(voicing.shift()); } const assignedNotesWithOctaves = voicing.map((noteName, index) => { let octave = PLAYBACK_OCTAVES[0]; if (index > 0 && NOTES.indexOf(noteName) < NOTES.indexOf(voicing[0]) && PLAYBACK_OCTAVES.length > 1) { octave = PLAYBACK_OCTAVES[1]; } else if (PLAYBACK_OCTAVES.length > 1 && index > 1) { octave = PLAYBACK_OCTAVES[index % PLAYBACK_OCTAVES.length]; } if (!OCTAVES_FOR_SAMPLES.includes(octave)) { octave = OCTAVES_FOR_SAMPLES.find(o => o >= PLAYBACK_OCTAVES[0]) || OCTAVES_FOR_SAMPLES[0]; } return { name: noteName, octave: octave }; }); assignedNotesWithOctaves.forEach(noteObj => { const spc = standardizeNoteNameForSamples(noteObj.name); const sk = `${spc}${noteObj.octave}`; const b = AudioContextManager.pianoSampleBuffers[sk]; if (!b) { console.warn(`Chord Playback: No sample for ${sk}`); return; } const s = AudioContextManager.context.createBufferSource(); s.buffer = b; const nsg = AudioContextManager.context.createGain(); nsg.gain.value = 0.8 + Math.random() * 0.2; s.connect(nsg); nsg.connect(mainGain); const tv = Math.random() * 0.03; s.start(startTime + tv); s.stop(startTime + duration + tv); }); }
async function playMetronomeSound(baseVol) { if (!AudioContextManager.context) return; const mov = parseFloat(UI.elements.metronomeVolume.value); const cv = baseVol * mov; if (cv <= 0) return; const st = UI.elements.soundType.value; const be = document.querySelector(`.beat[data-beat="${AppState.currentBeat}"]`); if (!be) return; const sktp = be.dataset.sound.split(','); const iab = parseFloat(be.dataset.baseVolume) >= 1; const ab = parseFloat(UI.elements.accentIntensity?.value || 1.0); let fvfts = cv; if (iab && (sktp.includes('kick') || sktp.includes('snare') || st === 'click' || st === 'woodblock')) { fvfts = Math.min(cv * ab, 1.0); } for (let sk of sktp) { sk = sk.trim(); if (sk === 'silent') continue; let btp; let esk = sk; if (st === 'drums') { const cs = drumSoundSets[currentDrumSetIndex]; let sfn; switch(sk){case 'kick':sfn=cs.kick;break; case 'snare':sfn=cs.snare;break; case 'hihat':sfn=cs.hihat;break; default:esk='click';sfn=null;} if(sfn){try{if(!AudioContextManager.soundBuffers[sfn]){const r=await fetch(`./${sfn}`);if(!r.ok)throw new Error(`${r.status} for ${sfn}`);const aby=await r.arrayBuffer();AudioContextManager.soundBuffers[sfn]=await AudioContextManager.context.decodeAudioData(aby);}btp=AudioContextManager.soundBuffers[sfn];}catch(e){console.error(`Failed drum sample ${sfn}:`,e);btp=AudioContextManager.soundBuffers[sk]||AudioContextManager.soundBuffers['click'];}}else{btp=AudioContextManager.soundBuffers[esk]||AudioContextManager.soundBuffers['click'];}}else{esk=st;btp=AudioContextManager.soundBuffers[st]||AudioContextManager.soundBuffers['click'];} if(!btp)continue;const src=AudioContextManager.context.createBufferSource();src.buffer=btp;const gn=AudioContextManager.context.createGain();let afv=fvfts;if(st==='drums'){if(esk==='hihat'&&sktp.length>1)afv*=0.6;else if(esk==='kick')afv*=1.0;else if(esk==='snare')afv*=0.9;}gn.gain.setValueAtTime(Math.min(afv,1.0),AudioContextManager.context.currentTime);src.connect(gn);gn.connect(AudioContextManager.context.destination);if(st==='drums'&&AudioContextManager.reverbNode){const rg=AudioContextManager.context.createGain();rg.gain.setValueAtTime(0.05,AudioContextManager.context.currentTime);src.connect(rg);rg.connect(AudioContextManager.reverbNode);}src.start(AudioContextManager.context.currentTime);}}

// --- Fretboard Drawing ---
function createFretboard(container, tuningArr) { if (!(container instanceof HTMLElement)) return; if (!Array.isArray(tuningArr) || tuningArr.length === 0) return; container.innerHTML = ''; const nf = 12; const ns = tuningArr.length; for (let i=0;i<=nf;i++){ const fl=document.createElement('div');fl.className='fret-line';fl.style.left=`${(i/nf)*100}%`;container.appendChild(fl); if(i>0){const fn=document.createElement('div');fn.className='fret-number';fn.textContent=i;fn.style.left=`${((i-0.5)/nf)*100}%`;container.appendChild(fn);}} const nut=document.createElement('div');nut.className='fret-line';nut.style.left='0%';nut.style.width='4px';nut.style.background='#4A3B31';container.appendChild(nut); for (let i=0;i<ns;i++){const sl=document.createElement('div');sl.className='string-line';const sy=100-(i/(ns-1))*100;sl.style.top=`${sy}%`;container.appendChild(sl);} const mp=[3,5,7,9,12]; mp.forEach(fp=>{const m=document.createElement('div');m.className='fret-marker';m.style.left=`${((fp-0.5)/nf)*100}%`;if(fp===12){const tm=m.cloneNode(true);const bm=m.cloneNode(true);const tsi=Math.floor(ns/2)-1;const bsi=Math.floor(ns/2);tm.style.top=`${100-((tsi+0.5)/(ns-1))*100}%`;bm.style.top=`${100-((bsi-0.5)/(ns-1))*100}%`;container.appendChild(tm);container.appendChild(bm);}else{m.style.top='50%';container.appendChild(m);}}); }
function updateFretboardNotes(fretboardContainer, rootNote, scaleName, tuningArray) {
    // --- Validation & Setup ---
    if (!(fretboardContainer instanceof HTMLElement)) { console.error('Invalid fretboardContainer'); return; }
    const standardizedRoot = standardizeNoteName(rootNote);
    if (!NOTES.includes(standardizedRoot)) { console.error(`Invalid root note: ${rootNote}`); return; }
    const scaleData = SCALES[scaleName];
    if (!scaleData) { console.error(`Invalid scale: ${scaleName}`); return; }
    const isStandardTuning = Array.isArray(tuningArray) && tuningArray.length === 6;
    if (!Array.isArray(tuningArray) || tuningArray.length === 0) { console.error('Invalid tuning array'); return; }
    if (!isStandardTuning) { console.warn(`Non-standard tuning. Using approx octaves.`); }
    // --- End Validation ---

    fretboardContainer.querySelectorAll('.note').forEach(el => el.remove());

    // --- Update Scale Display ---
    if (fretboardContainer.id === 'chord-fretboard' && UI.elements.scaleDisplay) {
        const currentMeasureEl = AppState.currentMeasure < UI.elements.measures.children.length ? UI.elements.measures.children[AppState.currentMeasure] : null;
        if (currentMeasureEl) {
            const cr = currentMeasureEl.querySelector('.chord-controls .root-note')?.value;
            const cqRaw = currentMeasureEl.querySelector('.chord-controls .chord-quality')?.value; // e.g., 'dom7', 'maj7', 'min7'
            const srDisp = currentMeasureEl.querySelector('.scale-controls .second-key')?.value || rootNote;
            const stRaw = currentMeasureEl.querySelector('.scale-controls .scale-select')?.value || scaleName;
            const stOpt = currentMeasureEl.querySelector(`.scale-controls .scale-select option[value="${stRaw}"]`);
            const stDisp = stOpt ? stOpt.textContent : stRaw; // Scale name display

            // *** START Formatting Fixes ***
            let cqDisp = cqRaw; // Default to the raw value
            switch (cqRaw) {
                case 'maj7': cqDisp = 'maj7'; break; // Force lowercase
                case 'dom7': cqDisp = '7'; break;    // Abbreviate and remove (Dom)
                case 'min7': cqDisp = 'm7'; break;    // Force lowercase 'm'
                case 'min7b5': cqDisp = 'm7b5'; break; // Use common jazz notation
                case 'dim7': cqDisp = 'dim7'; break;  // Or '°7' if preferred
                case 'maj6': cqDisp = 'maj6'; break;
                case 'min6': cqDisp = 'm6'; break;
                // Add other specific formats if needed (e.g., for triads like 'maj', 'min')
                case 'maj': cqDisp = ''; break; // Major triad often shown just by root
                case 'min': cqDisp = 'm'; break; // Minor triad often shown just by root + m
                // ... other qualities if needed ...
                 default:
                    // If no specific rule, try getting text from option but remove hints
                    const cqOpt = currentMeasureEl.querySelector(`.chord-controls .chord-quality option[value="${cqRaw}"]`);
                    if (cqOpt) {
                        cqDisp = cqOpt.textContent.split(' ')[0]; // Take only first part (e.g., "7" from "7 (Dom)")
                    } else {
                         cqDisp = cqRaw; // Fallback to raw value if option not found
                    }
                    break;
            }

            // Construct the string WITHOUT the space between chord root and quality
            UI.elements.scaleDisplay.textContent = `${srDisp} ${stDisp} over ${cr}${cqDisp}`;
            // *** END Formatting Fixes ***

        } else {
             UI.elements.scaleDisplay.textContent = `${standardizedRoot} ${scaleName.replace(/([A-Z])/g, ' $1').trim()}`;
        }
    }
    // --- End Update Scale Display ---

    // --- Scale Note Calculation & Drawing ---
    const rootIdx = NOTES.indexOf(standardizedRoot);
    const notesInScale = scaleData.map(interval => NOTES[(rootIdx + interval) % 12]);
    const numStrings = tuningArray.length; const numFrets = 12;

    for (let stringIndex = 0; stringIndex < numStrings; stringIndex++) {
        const openStringNote = standardizeNoteName(tuningArray[stringIndex]);
        const openStringNoteIndex = NOTES.indexOf(openStringNote);
        if (openStringNoteIndex === -1) continue;
        const stringMapKey = `string${stringIndex + 1}`;
        for (let fret = 0; fret <= numFrets; fret++) {
            const currentNoteIndex = (openStringNoteIndex + fret + 12) % 12;
            const currentNoteName = NOTES[currentNoteIndex];
            if (notesInScale.includes(currentNoteName)) {
                const noteElement = document.createElement('div'); noteElement.className = 'note';
                noteElement.textContent = currentNoteName;
                if (fret === 0) noteElement.style.left = `1.5%`; else noteElement.style.left = `${((fret - 0.5) / numFrets) * 100 + 2}%`;
                const stringY = 100 - (stringIndex / (numStrings - 1)) * 100; noteElement.style.top = `${stringY}%`;
                if (currentNoteName === standardizedRoot) noteElement.style.backgroundColor = '#BD2031'; else { const di = notesInScale.indexOf(currentNoteName); noteElement.style.backgroundColor = (di % 2 === 0) ? '#006400' : '#4CAF50'; }
                let noteOctaveForPlayback = `${currentNoteName}3`;
                if (isStandardTuning && FRETBOARD_NOTES_OCTAVES[stringMapKey] && fret < FRETBOARD_NOTES_OCTAVES[stringMapKey].length) { noteOctaveForPlayback = FRETBOARD_NOTES_OCTAVES[stringMapKey][fret]; }
                else { let aO=PLAYBACK_OCTAVES[0]; if(stringIndex<numStrings/2)aO=PLAYBACK_OCTAVES[1]||PLAYBACK_OCTAVES[0]; if(fret>7&&aO<OCTAVES_FOR_SAMPLES[OCTAVES_FOR_SAMPLES.length-1])aO++; aO=Math.max(OCTAVES_FOR_SAMPLES[0],Math.min(OCTAVES_FOR_SAMPLES[OCTAVES_FOR_SAMPLES.length-1],aO)); noteOctaveForPlayback=`${currentNoteName}${aO}`; }
                noteElement.dataset.note = noteOctaveForPlayback;
                noteElement.addEventListener('click', async (e) => { e.stopPropagation(); await AudioContextManager.ensureAudioContext(); const ntP=noteElement.dataset.note; const v=fretboardContainer.id.startsWith('fretflow-fretboard')?0.4:parseFloat(UI.elements.chordFretboardVolume.value); playNote(ntP,v,500); noteElement.style.transform='translate(-50%,-50%) scale(1.3)'; setTimeout(()=>{noteElement.style.transform='translate(-50%,-50%) scale(1)';},150); });
                fretboardContainer.appendChild(noteElement);
            }
        }
    }
    // --- End Scale Note Calculation & Drawing ---

    // --- Guide Tones ---
    if (AppState.guideTonesActive && fretboardContainer.id === 'chord-fretboard') { highlightGuideTones(); }
    // --- End Guide Tones ---
}
// --- Metronome Beat Display & Interaction ---
function createBeats() { const c=document.querySelector('.beats-container');if(!c)return;c.innerHTML=''; if(!UI.elements.timeSignature||!UI.elements.soundType)return; const ts=parseInt(UI.elements.timeSignature.value);const sot=UI.elements.soundType.value;let tbtd=ts;let sf=1;if(ts===4){tbtd=8;sf=2;}else if(ts===6||ts===12){tbtd=ts;sf=1;} for(let i=0;i<tbtd;i++){const bd=document.createElement('div');bd.className='beat';bd.dataset.beat=i;let bl=`${Math.floor(i/sf)+1}`;if(sf>1&&(i%sf!==0)){bl+="&";}else if((ts===6||ts===12)&&(i%3===0)&&i!==0){bl=`${Math.floor(i/3)+1}`;}bd.textContent=bl;let bs=sot==='drums'?'hihat':sot;let bv=0.3;let col='#4CAF50';let isbits=false;if(ts===4){isbits=(i===0||i===4);}else if(ts===3||ts===2){isbits=(i===0);}else if(ts===6){isbits=(i===0||i===3);}else if(ts===12){isbits=(i===0||i===3||i===6||i===9);}else{isbits=(i===0);} if(isbits){bv=1.0;col='#1F618D';if(sot==='drums'){bs='kick,hihat';if(ts===4&&(i===2||i===6)){bs='snare,hihat';bv=0.8;col='#D9534F';}}}else if(ts===4&&(i===2||i===6)&&sot==='drums'){bs='snare,hihat';bv=0.8;col='#D9534F';}else if(sot==='drums'&&sf>1&&(i%sf!==0)){bs='hihat';bv=0.2;col='#9E9E9E';}else if(sot!=='drums'&&sf>1&&(i%sf!==0)){bs='silent';bv=0;col='#666';} bd.dataset.sound=bs;bd.dataset.baseVolume=bv;bd.dataset.volume=bv;bd.style.backgroundColor=col;bd.addEventListener('click',()=>toggleBeatAccent(bd,sot,sf>1));c.appendChild(bd);}}
function toggleBeatAccent(be, cst, isSub) { const cv=parseFloat(be.dataset.volume);let nv,ns,nc;if(cst==='drums'){const s=['silent','hihat','snare,hihat','kick,hihat'];const cl=['#666','#9E9E9E','#D9534F','#1F618D'];const v=[0,0.3,0.8,1.0];let ci=s.indexOf(be.dataset.sound);if(ci===-1)ci=1;let ni=(ci+1)%s.length;if(isSub&&(s[ni]==='snare,hihat'||s[ni]==='kick,hihat')){if(s[ci]!=='hihat'&&s[ci]!=='silent'){ni=(ci+1)%s.length;}else{ni=(ci+2)%s.length;if(ni===ci)ni=(ni+1)%s.length;}} ns=s[ni];nv=v[ni];nc=cl[ni];}else{const st=[{volume:0,sound:'silent',color:'#666'},{volume:0.3,sound:cst,color:'#9E9E9E'},{volume:1.0,sound:cst,color:'#1F618D'}];let csi=st.findIndex(s=>s.volume===cv);if(csi===-1){if(cv>0.5)csi=2;else if(cv>0)csi=1;else csi=0;} const nst=st[(csi+1)%st.length];nv=nst.volume;ns=nst.sound;nc=nst.color;} be.dataset.volume=nv;be.dataset.sound=ns;be.dataset.baseVolume=nv;be.style.backgroundColor=nc;}
function onMetronomeInstrumentChange(selIns){ if(UI.elements.drumSetToggleBtn) UI.elements.drumSetToggleBtn.style.display=selIns==="drums"?"inline-block":"none"; createBeats(); }

// --- Playback Loop & Control ---
async function playBeat() {
    const beatsUI = document.querySelectorAll('.beat');
    const measures = UI.elements.measures.children;
    if (beatsUI.length === 0) { return; }

    let measureToPlayIndex = AppState.currentMeasure;
    if (AppState.loopingActive && AppState.loopStartMeasure !== -1 && AppState.loopEndMeasure !== -1) {
        if (AppState.currentMeasure < AppState.loopStartMeasure || AppState.currentMeasure > AppState.loopEndMeasure) { AppState.currentMeasure = AppState.loopStartMeasure; }
        measureToPlayIndex = AppState.currentMeasure;
    }

    beatsUI.forEach(b => b.classList.remove('active'));
    const currentBeatElement = beatsUI[AppState.currentBeat];
    if (currentBeatElement) { currentBeatElement.classList.add('active'); const vol = parseFloat(currentBeatElement.dataset.volume); if (vol > 0) await playMetronomeSound(vol); }

    if (measures.length > 0 && measureToPlayIndex < measures.length) {
        Array.from(measures).forEach((m, idx) => m.classList.toggle('active', idx === measureToPlayIndex));
        const currentMeasureElement = measures[measureToPlayIndex];
        const root = currentMeasureElement.querySelector('.root-note')?.value, quality = currentMeasureElement.querySelector('.chord-quality')?.value, scaleRoot = currentMeasureElement.querySelector('.second-key')?.value, scaleType = currentMeasureElement.querySelector('.scale-select')?.value;
        if (root && quality && scaleRoot && scaleType) {
            const tuning = TUNINGS[UI.elements.chordTuning.value];
            updateFretboardNotes(UI.elements.chordFretboard, scaleRoot, scaleType, tuning);
            const timeSig = parseInt(UI.elements.timeSignature.value), beatDur = 60 / AppState.tempo; let chordDur = beatDur * timeSig;
            if (timeSig === 4) { chordDur = beatDur * 2; if (AppState.currentBeat === 0 || AppState.currentBeat === 4) await playChord(root, quality, AudioContextManager.context.currentTime, chordDur); }
            else if (AppState.currentBeat === 0) await playChord(root, quality, AudioContextManager.context.currentTime, chordDur);
        }
    }

    const totalBeatsInDisplay = beatsUI.length;
    AppState.currentBeat = (AppState.currentBeat + 1) % totalBeatsInDisplay;
    if (AppState.currentBeat === 0) {
        if (AppState.loopingActive && AppState.loopStartMeasure !== -1 && AppState.loopEndMeasure !== -1) { AppState.currentMeasure++; if (AppState.currentMeasure > AppState.loopEndMeasure) AppState.currentMeasure = AppState.loopStartMeasure; }
        else if (measures.length > 0) { AppState.currentMeasure = (AppState.currentMeasure + 1) % measures.length; }
        // Update next chord display AFTER measure potentially changes
        updateNextChordDisplay(); // Moved here
        if (AppState.guideTonesActive) highlightGuideTones();
    }
} // --- End of playBeat function ---

async function startPlayback() { try { await AudioContextManager.ensureAudioContext(); if (AppState.isPlaying) return; const measures = UI.elements.measures.children; const tsn = parseInt(UI.elements.timeSignature.value); let ims = (60 / AppState.tempo) * 1000; if (tsn === 4) ims /= 2; AppState.currentBeat = 0; if (!AppState.intervalId) { AppState.currentMeasure = (AppState.loopingActive && AppState.loopStartMeasure !== -1) ? AppState.loopStartMeasure : 0; await playBeat(); const tbuid = document.querySelectorAll('.beat').length; if (tbuid > 0) { AppState.currentBeat = (AppState.currentBeat + 1) % tbuid; if (AppState.currentBeat === 0) { if (AppState.loopingActive && AppState.loopStartMeasure !== -1 && AppState.loopEndMeasure !== -1) { AppState.currentMeasure++; if (AppState.currentMeasure > AppState.loopEndMeasure) AppState.currentMeasure = AppState.loopStartMeasure; } else if (measures.length > 0) { AppState.currentMeasure = (AppState.currentMeasure + 1) % measures.length; } } } } clearInterval(AppState.intervalId); AppState.intervalId = setInterval(async () => { await playBeat(); }, ims); AppState.updateState({ isPlaying: true }); UI.elements.startStopButton.textContent = 'Stop'; log("Playback started."); } catch (e) { console.error('Failed start playback:', e); stopPlayback(); alert("Error starting playback."); } }
function stopPlayback() { clearInterval(AppState.intervalId); AppState.intervalId = null; AppState.updateState({ isPlaying: false }); document.querySelectorAll('.beat.active').forEach(b => b.classList.remove('active')); document.querySelectorAll('.measure.active').forEach(m => m.classList.remove('active')); if (AudioContextManager.currentChordGain && AudioContextManager.context) { try { const now = AudioContextManager.context.currentTime; if (AudioContextManager.currentChordGain.gain) { AudioContextManager.currentChordGain.gain.setValueAtTime(AudioContextManager.currentChordGain.gain.value, now); AudioContextManager.currentChordGain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); } } catch (rampError) { console.warn("Gain ramp error:", rampError); } finally { AudioContextManager.currentChordGain = null; } } if (UI.elements.nextChordDisplay) UI.elements.nextChordDisplay.textContent = ""; UI.elements.startStopButton.textContent = 'Start'; log("Playback stopped."); }

// --- Progression Management & UI Updates ---
function updateNextChordDisplay(currentMeasureIndex = AppState.currentMeasure) { const nextChordEl = UI.elements.nextChordDisplay; if (!nextChordEl) return; const measures = UI.elements.measures.children; if (measures.length < 2) { nextChordEl.textContent = ""; return; } let nextMeasureIdx; if (AppState.loopingActive && AppState.loopStartMeasure !== -1 && AppState.loopEndMeasure !== -1) { nextMeasureIdx = currentMeasureIndex + 1; if (nextMeasureIdx > AppState.loopEndMeasure) nextMeasureIdx = AppState.loopStartMeasure; nextMeasureIdx = Math.max(AppState.loopStartMeasure, Math.min(AppState.loopEndMeasure, nextMeasureIdx)); } else { nextMeasureIdx = (currentMeasureIndex + 1) % measures.length; } const nextMeasureElement = measures[nextMeasureIdx]; if (!nextMeasureElement) { nextChordEl.textContent = ""; return; } const root = nextMeasureElement.querySelector('.root-note')?.value, qualityRaw = nextMeasureElement.querySelector('.chord-quality')?.value; if (root && qualityRaw) { let qualityDisplay = qualityRaw; const qOpt = nextMeasureElement.querySelector(`.chord-quality option[value="${qualityRaw}"]`); if (qOpt) qualityDisplay = qOpt.textContent; else { if (qualityRaw==='dom7') qualityDisplay='7'; else if(qualityRaw==='maj7') qualityDisplay='Maj7'; else if(qualityRaw==='min7') qualityDisplay='m7'; else if(qualityRaw==='min7b5') qualityDisplay='m7ø5'; else if(qualityRaw==='dim7') qualityDisplay='°7'; } nextChordEl.textContent = `Next: ${root}${qualityDisplay}`; } else { nextChordEl.textContent = ""; } }
function loadProgression(progName, overrideKey = null, isUserSong = false) { const sTe = UI.elements.currentSongTitle, sDe = UI.elements.currentSongDescription; let pD; if (isUserSong) { const uS=JSON.parse(localStorage.getItem('userBebopProgressions')||'{}'); pD=uS[progName]; } else { pD=progressions[progName]; } if (!progName||!pD) { currentProgressionName=""; currentFunctionalProgression=[]; UI.elements.measures.innerHTML='<p>Select.</p>'; if(sTe)sTe.textContent=""; if(sDe)sDe.textContent=""; return; } currentProgressionName=progName; currentFunctionalProgression=pD.progression; const aK=overrideKey||pD.defaultKey||"C"; if(sTe)sTe.textContent=pD.displayName||progName.replace(/_/g,' '); if(sDe)sDe.textContent=pD.description||""; if(UI.elements.keySelect)UI.elements.keySelect.value=aK; UI.elements.measures.innerHTML=''; resetLoop(); currentFunctionalProgression.forEach((rcs,idx)=>{ const pc=parseRomanNumeralToAbsoluteChord(rcs,aK); const md=document.createElement('div'); md.className='measure'; /* Removed draggable=true */ md.dataset.measureIndex=idx; md.innerHTML=`<span class="measure-number" data-measure-idx="${idx}">${idx+1}</span><div class="chord-controls"><select class="root-note">${createKeyOptions(pc.root)}</select><select class="chord-quality">${createQualityOptions(pc.quality)}</select></div><div class="scale-controls"><select class="second-key">${createKeyOptions(pc.root)}</select><select class="scale-select">${createScaleOptions(suggestScaleForQuality(pc.quality))}</select></div>`; UI.elements.measures.appendChild(md); md.querySelectorAll('select').forEach(sel=>sel.addEventListener('change',()=>handleMeasureControlChange(md))); md.addEventListener('click',(e)=>{if(e.target.tagName!=='SELECT')toggleMeasureLoopSelection(idx);}); /* Removed dragstart listener */ }); updateMeasureNumbers(); addFirstChordListener(); updateNextChordDisplay(0); log(`Loaded ${isUserSong?'user':'std'}: ${progName} in ${aK}`); }
function updateProgressionKey(newKey) { const st=UI.elements.currentSongTitle, sd=UI.elements.currentSongDescription; if(!currentFunctionalProgression||currentFunctionalProgression.length===0){if(UI.elements.measures.children.length===0){const t=TUNINGS[UI.elements.chordTuning.value];updateFretboardNotes(UI.elements.chordFretboard,newKey,'major',t);if(UI.elements.scaleDisplay)UI.elements.scaleDisplay.textContent=`${newKey} Major`;if(st)st.textContent="";if(sd)sd.textContent=""; updateNextChordDisplay();}return;} Array.from(UI.elements.measures.children).forEach((me,ix)=>{if(ix<currentFunctionalProgression.length){const rcs=currentFunctionalProgression[ix];const pc=parseRomanNumeralToAbsoluteChord(rcs,newKey);const rs=me.querySelector('.root-note'),qs=me.querySelector('.chord-quality'),sks=me.querySelector('.second-key'),ss=me.querySelector('.scale-select');if(rs)rs.value=pc.root;if(qs)qs.value=pc.quality;if(sks)sks.value=pc.root;if(ss)ss.value=suggestScaleForQuality(pc.quality);}});addFirstChordListener();updateNextChordDisplay();log(`Progression '${currentProgressionName}' re-keyed to: ${newKey}`);}
function addMeasure(r='C',q='maj7',sr='C',st='major'){const mc=UI.elements.measures.children.length;const md=document.createElement('div');md.className='measure'; /* Removed draggable=true */ md.dataset.measureIndex=mc;md.innerHTML=`<span class="measure-number" data-measure-idx="${mc}">${mc+1}</span><div class="chord-controls"><select class="root-note">${createKeyOptions(r)}</select><select class="chord-quality">${createQualityOptions(q)}</select></div><div class="scale-controls"><select class="second-key">${createKeyOptions(sr)}</select><select class="scale-select">${createScaleOptions(st)}</select></div>`;UI.elements.measures.appendChild(md);md.querySelectorAll('select').forEach(sel=>sel.addEventListener('change',()=>handleMeasureControlChange(md)));md.addEventListener('click',(e)=>{if(e.target.tagName!=='SELECT')toggleMeasureLoopSelection(mc);}); /* Removed dragstart listener */ updateMeasureNumbers();if(mc===0)addFirstChordListener();updateNextChordDisplay();log(`Added measure ${mc+1}`);}
function removeMeasure(){const m=UI.elements.measures.children;if(m.length>0){const removedIdx=m.length-1;if(AppState.loopStartMeasure===removedIdx||AppState.loopEndMeasure===removedIdx)resetLoop();m[m.length-1].remove();updateMeasureNumbers();if(m.length>0)addFirstChordListener();else if(UI.elements.scaleDisplay)UI.elements.scaleDisplay.textContent="";updateNextChordDisplay();log('Removed last measure');}}
function updateMeasureNumbers(){Array.from(UI.elements.measures.children).forEach((m,i)=>{const n=m.querySelector('.measure-number');if(n){n.textContent=i+1; m.dataset.measureIndex = i; n.dataset.measureIdx = i;}});}
function handleMeasureControlChange(me) { const rs=me.querySelector('.root-note'),qs=me.querySelector('.chord-quality'),sks=me.querySelector('.second-key'),ss=me.querySelector('.scale-select');if(rs&&qs&&sks&&ss){sks.value=rs.value;ss.value=suggestScaleForQuality(qs.value);}if(me===UI.elements.measures.firstElementChild)addFirstChordListener();updateNextChordDisplay(); const mix=Array.from(UI.elements.measures.children).indexOf(me);if(AppState.isPlaying&&mix===AppState.currentMeasure){const t=TUNINGS[UI.elements.chordTuning.value];updateFretboardNotes(UI.elements.chordFretboard,sks.value,ss.value,t);}}
// Drag & Drop Functions REMOVED: dragStart, dragOver, drop, dragEnd

// --- User Progression Save/Load ---
function saveCurrentProgression() { const m=Array.from(UI.elements.measures.children);if(m.length===0){alert("No progression to save!");return;} let pn=prompt("Name:",currentProgressionName||"My Song");if(!pn||pn.trim()===""){alert("Save cancelled.");return;} pn=pn.trim(); const pts=m.map(me=>{const mi=parseInt(me.dataset.measureIndex);if(currentFunctionalProgression&&mi<currentFunctionalProgression.length&&!isUserSongCurrentlyLoaded()){return currentFunctionalProgression[mi];} const r=me.querySelector('.root-note').value, q=me.querySelector('.chord-quality').value; return`${r}${q}`;}); const uS=JSON.parse(localStorage.getItem('userBebopProgressions')||'{}'); uS[pn]={progression:pts,defaultKey:UI.elements.keySelect.value,description:`Saved ${new Date().toLocaleDateString()}`,displayName:pn}; localStorage.setItem('userBebopProgressions',JSON.stringify(uS)); populateUserSongsDropdown(); alert(`"${pn}" saved!`); log(`Saved: ${pn}`); }
function isUserSongCurrentlyLoaded() { const uS=JSON.parse(localStorage.getItem('userBebopProgressions')||'{}'); return uS.hasOwnProperty(currentProgressionName); }
function populateUserSongsDropdown() { const sE=UI.elements.userProgressionSelect;sE.innerHTML='<option value="">-- Select a saved song --</option>'; const uS=JSON.parse(localStorage.getItem('userBebopProgressions')||'{}'); Object.keys(uS).sort().forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=uS[n].displayName||n;sE.appendChild(o);}); }
function deleteSelectedUserSong() { const ssn=UI.elements.userProgressionSelect.value;if(!ssn){alert("Select song to delete.");return;} if(confirm(`Delete "${ssn}"?`)){ const uS=JSON.parse(localStorage.getItem('userBebopProgressions')||'{}');delete uS[ssn]; localStorage.setItem('userBebopProgressions',JSON.stringify(uS)); populateUserSongsDropdown(); if(currentProgressionName===ssn){UI.elements.measures.innerHTML='';UI.elements.currentSongTitle.textContent='';UI.elements.currentSongDescription.textContent='';currentProgressionName="";currentFunctionalProgression=[]; resetLoop();} alert(`"${ssn}" deleted.`);log(`Deleted: ${ssn}`);}} // Also reset loop if deleted song was active

// --- Looper Functionality ---
function toggleMeasureLoopSelection(mIdx) { if(!AppState.loopingActive)toggleLoopingMode(); const me=UI.elements.measures.children[mIdx];if(!me)return; me.classList.toggle('loop-selected'); const si=Array.from(UI.elements.measures.children).map((m,i)=>m.classList.contains('loop-selected')?i:-1).filter(i=>i!==-1).sort((a,b)=>a-b); if(si.length>0){AppState.loopStartMeasure=si[0];AppState.loopEndMeasure=si[si.length-1]; Array.from(UI.elements.measures.children).forEach(m=>m.classList.remove('loop-selected')); for(let i=AppState.loopStartMeasure;i<=AppState.loopEndMeasure;i++){if(UI.elements.measures.children[i])UI.elements.measures.children[i].classList.add('loop-selected');}}else{resetLoop();} log(`Loop: ${AppState.loopStartMeasure} to ${AppState.loopEndMeasure}`);}
function resetLoop() { AppState.loopStartMeasure=-1;AppState.loopEndMeasure=-1;Array.from(UI.elements.measures.children).forEach(m=>m.classList.remove('loop-selected'));log("Loop cleared.");}
function toggleLoopingMode() { AppState.loopingActive=!AppState.loopingActive;UI.elements.loopSelectedToggle.textContent=AppState.loopingActive?"Looping ON":"Looping Off";UI.elements.loopSelectedToggle.classList.toggle('active',AppState.loopingActive);if(!AppState.loopingActive)resetLoop();else alert("Loop ON. Click measures for range.");log(`Looping: ${AppState.loopingActive}`);}

// --- Guide Tones Functionality ---
function toggleGuideTones() { AppState.guideTonesActive=!AppState.guideTonesActive;UI.elements.guideTonesToggle.textContent=AppState.guideTonesActive?"Guide Tones ON":"Guide Tones Off";UI.elements.guideTonesToggle.classList.toggle('active',AppState.guideTonesActive);if(AppState.guideTonesActive)highlightGuideTones();else clearGuideToneHighlights();log(`Guide tones: ${AppState.guideTonesActive}`);}
function highlightGuideTones() { clearGuideToneHighlights(); if(!AppState.guideTonesActive||AppState.currentMeasure<0||!UI.elements.measures.children[AppState.currentMeasure])return; const ms=UI.elements.measures.children; const cme=ms[AppState.currentMeasure]; let nmi; if(AppState.loopingActive&&AppState.loopStartMeasure!==-1&&AppState.loopEndMeasure!==-1){nmi=AppState.currentMeasure+1;if(nmi>AppState.loopEndMeasure)nmi=AppState.loopStartMeasure;}else{nmi=(AppState.currentMeasure+1)%ms.length;} const nme=ms[nmi]; if(!cme||!nme)return; const cr=cme.querySelector('.root-note')?.value,cq=cme.querySelector('.chord-quality')?.value,nr=nme.querySelector('.root-note')?.value,nq=nme.querySelector('.chord-quality')?.value; if(!cr||!cq||!nr||!nq)return; const ci=CHORD_INTERVALS[cq],ni=CHORD_INTERVALS[nq];if(!ci||!ni)return; let si=ci.find(i=>i===10||i===11);if(si===undefined&&cq.includes('6'))si=9;if(si===undefined)return; const c7=NOTES[(NOTES.indexOf(standardizeNoteName(cr))+si+12)%12]; let ti=ni.find(i=>i===3||i===4);if(ti===undefined)return; const n3=NOTES[(NOTES.indexOf(standardizeNoteName(nr))+ti+12)%12]; const d=Math.abs(NOTES.indexOf(c7)-NOTES.indexOf(n3));const iR=d===1||d===2||d===11||d===10; if(iR){UI.elements.chordFretboard.querySelectorAll('.note').forEach(ne=>{if(ne.textContent===c7||ne.textContent===n3)ne.classList.add('guide-tone-highlight');});}}
function clearGuideToneHighlights() { UI.elements.chordFretboard.querySelectorAll('.note.guide-tone-highlight').forEach(n => n.classList.remove('guide-tone-highlight'));}

// --- FretFlow ---
function initializeFretFlow() { const fg=UI.elements.fretboardsGrid;if(!fg)return;fg.innerHTML='';fg.style.display='grid';fg.style.gridTemplateColumns='repeat(2,1fr)';fg.style.gap='20px';for(let i=0;i<4;i++){const fs=document.createElement('div');fs.className='fretboard-section';const so=Object.entries(SCALES).map(([sk,_])=>{const dn=sk.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase());return`<option value="${sk}">${dn}</option>`;}).join('');fs.innerHTML=`<div class="fretboard-controls"><div class="control-group"><label for="ffk-${i}">Key:</label><select id="ffk-${i}"class="fretflow-key">${createKeyOptions()}</select></div><div class="control-group"><label for="ffs-${i}">Scale:</label><select id="ffs-${i}"class="fretflow-scale">${so}</select></div><div class="control-group"><label for="fft-${i}">Tuning:</label><select id="fft-${i}"class="tuning-select"><option value="standard">Std</option><option value="dropD">DropD</option><option value="openG">OpG</option><option value="DADGAD">DADGAD</option><option value="openE">OpE</option></select></div></div><div class="scale-display"id="ffsd-${i}"></div><div id="fffb-${i}"class="fretboard"></div>`;fg.appendChild(fs);const fe=fs.querySelector(`#fffb-${i}`);const kse=fs.querySelector(`#ffk-${i}`);const sse=fs.querySelector(`#ffs-${i}`);const tse=fs.querySelector(`#fft-${i}`);const sde=fs.querySelector(`#ffsd-${i}`);function u(){const sk=kse.value;const ss=sse.value;const stv=tse.value;const sta=TUNINGS[stv];if(!sta)return;const dsn=sse.options[sse.selectedIndex].text;sde.textContent=`${sk} ${dsn}`;createFretboard(fe,sta);updateFretboardNotes(fe,sk,ss,sta);}kse.addEventListener('change',u);sse.addEventListener('change',u);tse.addEventListener('change',u);u();}log("FretFlow initialized.");}

// --- Event Handling Helpers ---
function addFirstChordListener() { const fm=UI.elements.measures.firstElementChild;if(fm){const srs=fm.querySelector('.scale-controls .second-key');const sts=fm.querySelector('.scale-controls .scale-select');const ts=UI.elements.chordTuning;const u=()=>{if(srs&&sts&&ts){const t=TUNINGS[ts.value];updateFretboardNotes(UI.elements.chordFretboard,srs.value,sts.value,t);}};u();}else{const t=TUNINGS[UI.elements.chordTuning.value];updateFretboardNotes(UI.elements.chordFretboard,"C","major",t);if(UI.elements.scaleDisplay)UI.elements.scaleDisplay.textContent="C Major (Default)";}}
function handleMeasureControlChange(me) { const rs=me.querySelector('.root-note'),qs=me.querySelector('.chord-quality'),sks=me.querySelector('.second-key'),ss=me.querySelector('.scale-select');if(rs&&qs&&sks&&ss){sks.value=rs.value;ss.value=suggestScaleForQuality(qs.value);}if(me===UI.elements.measures.firstElementChild)addFirstChordListener();updateNextChordDisplay();const mix=Array.from(UI.elements.measures.children).indexOf(me);if(AppState.isPlaying&&mix===AppState.currentMeasure){const t=TUNINGS[UI.elements.chordTuning.value];updateFretboardNotes(UI.elements.chordFretboard,sks.value,ss.value,t);}}

// --- Event Listeners Setup ---
function setupEventListeners() {
    document.body.addEventListener('click', ensureAudioInitializedUserInteraction, { once: true });
    UI.elements.startStopButton.addEventListener('click', () => { if (AppState.isPlaying) stopPlayback(); else startPlayback(); });
    if (UI.elements.drumSetToggleBtn) { UI.elements.drumSetToggleBtn.addEventListener('click', () => { currentDrumSetIndex=(currentDrumSetIndex+1)%drumSoundSets.length; UI.elements.drumSetToggleBtn.textContent=drumSoundSets[currentDrumSetIndex].name; log(`Switched to drum set: ${drumSoundSets[currentDrumSetIndex].name}`); }); }
    if (UI.elements.soundType) { UI.elements.soundType.addEventListener('change', (e)=>onMetronomeInstrumentChange(e.target.value)); onMetronomeInstrumentChange(UI.elements.soundType.value); }
    let colorMode=0; UI.elements.darkModeToggle.addEventListener('click',()=>{colorMode=(colorMode+1)%4;document.body.classList.remove('dark-mode','dark-mode-2','dark-mode-3');UI.elements.darkModeToggle.classList.remove('active','active-2','active-3');const m=['','dark-mode','dark-mode-2','dark-mode-3'];const ac=['','active','active-2','active-3'];if(colorMode>0){document.body.classList.add(m[colorMode]);UI.elements.darkModeToggle.classList.add(ac[colorMode]);} log(`Color mode: ${m[colorMode]||'Light'}`);});
    UI.elements.chordsEnabled.addEventListener('click',()=>{const iA=UI.elements.chordsEnabled.classList.toggle('active');UI.elements.chordsEnabled.textContent=iA?'Chords Enabled':'Chords Disabled'; log(`Chords ${iA ? 'enabled' : 'disabled'}`); });
    UI.elements.tempo.addEventListener('input',()=>{AppState.tempo=parseInt(UI.elements.tempo.value);UI.elements.tempoDisplay.textContent=`${AppState.tempo} BPM`;if(AppState.isPlaying){stopPlayback();startPlayback();}});
    UI.elements.tapTempo.addEventListener('click',()=>{const n=Date.now();AppState.tapTempoTimestamps.push(n);if(AppState.tapTempoTimestamps.length>4)AppState.tapTempoTimestamps.shift();if(AppState.tapTempoTimestamps.length>1){let ti=0;for(let i=1;i<AppState.tapTempoTimestamps.length;i++)ti+=AppState.tapTempoTimestamps[i]-AppState.tapTempoTimestamps[i-1];const ai=ti/(AppState.tapTempoTimestamps.length-1);if(ai>0&&ai<3000){const bpm=Math.round(60000/ai);AppState.tempo=Math.max(40,Math.min(220,bpm));UI.elements.tempo.value=AppState.tempo;UI.elements.tempoDisplay.textContent=`${AppState.tempo} BPM`;if(AppState.isPlaying){stopPlayback();startPlayback();}}} setTimeout(()=>{if(AppState.tapTempoTimestamps.length>0&&Date.now()-AppState.tapTempoTimestamps[AppState.tapTempoTimestamps.length-1]>3000)AppState.tapTempoTimestamps=[];},3100);});
    UI.elements.timeSignature.addEventListener('change',()=>{createBeats();if(AppState.isPlaying){stopPlayback();startPlayback();}});
    if(UI.elements.reverbDial&&UI.elements.reverbDialValue){UI.elements.reverbDial.addEventListener('input',function(e){const v=parseInt(e.target.value,10);AudioContextManager.reverbAmount=v/100;UI.elements.reverbDialValue.textContent=v; log(`Reverb amount set to: ${AudioContextManager.reverbAmount}`);});}
    UI.elements.progressionSelect.addEventListener('change', (e) => { const s = e.target.value; loadProgression(s, null, false); if (s && UI.elements.userProgressionSelect) UI.elements.userProgressionSelect.value = ""; });
    if (UI.elements.userProgressionSelect) { UI.elements.userProgressionSelect.addEventListener('change', (e) => { const s = e.target.value; if (s) { const uS=JSON.parse(localStorage.getItem('userBebopProgressions')||'{}'); const k=uS[s]?.defaultKey||UI.elements.keySelect.value; loadProgression(s, k, true); if(UI.elements.progressionSelect) UI.elements.progressionSelect.value = ""; } }); }
    UI.elements.keySelect.addEventListener('change', (e) => { updateProgressionKey(e.target.value); });
    UI.elements.chordTuning.addEventListener('change', () => { addFirstChordListener(); initializeFretFlow(); });
    if (UI.elements.saveProgressionButton) UI.elements.saveProgressionButton.addEventListener('click', saveCurrentProgression);
    if (UI.elements.deleteUserSongButton) UI.elements.deleteUserSongButton.addEventListener('click', deleteSelectedUserSong);
    if (UI.elements.guideTonesToggle) UI.elements.guideTonesToggle.addEventListener('click', toggleGuideTones);
    if (UI.elements.loopSelectedToggle) UI.elements.loopSelectedToggle.addEventListener('click', toggleLoopingMode);
    // Removed Drag/Drop listeners for UI.elements.measures
    log("Event listeners set up.");
}

// --- Initialize App ---
async function initializeApp() {
    UI.init();
    createBeats(); // MUST be after UI.init()
    const initTuning = TUNINGS[UI.elements.chordTuning.value] || TUNINGS.standard;
    createFretboard(UI.elements.chordFretboard, initTuning); // MUST be after UI.init()
    populateUserSongsDropdown(); // MUST be after UI.init()
    const initProg = UI.elements.progressionSelect.value || Object.keys(progressions)[0];
    const initKey = UI.elements.keySelect.value || progressions[initProg]?.defaultKey || "C";
    loadProgression(initProg, initKey, false); // MUST be after UI.init()
    initializeFretFlow(); // MUST be after UI.init()
    setupEventListeners(); // MUST be after UI.init()

    try { await AudioContextManager.initialize(); }
    catch (e) { updateLoadingStatus("Audio init failed. Click to try.", true); }

    updateLoadingStatus("Application initialized", true);
    setTimeout(() => updateLoadingStatus("", false), 1500);
    log("Application initialized.");
}


// --- DOM Ready Listener ---
document.addEventListener('DOMContentLoaded', () => {
    initializeApp().catch(e => { console.error("App init failed:", e); updateLoadingStatus("Initialization Error!", true); });
});

    </script>
</body>
</html>
